# DONE_LIST_VPN — выполненные задачи VPN/Proxy проекта

## 2026-02-22 — Чистый сброс eu1 (Fornex): AmneziaWG, проверка на ПК и iOS

- **Проблема:** на телефоне и у друзей — подключение к eu1 было, интернета не было; на ПК VPN работал через AmneziaWG.
- **План:** сброс только на eu1 (оставить MTProto и Shadowsocks), остановить и убрать конфиги AmneziaWG и wg0, проверить работу с нуля.
- **Документы:** созданы `docs/eu1-clean-slate-plan.md`, `docs/eu1-clean-slate-commands.md`; в README_FOR_NEXT_AGENT.md добавлен блок про план чистого сброса.
- **На eu1:** бэкап в `/root/eu1-backup-20260222`; остановлены и отключены awg-quick@awg0 и wg-quick@wg0; awg0.conf и копия /etc/amnezia перенесены в бэкап. Контейнеры Docker (amnezia-awg2, mtproto-proxy) не трогали.
- **Проверка:** сервер уже был в AmneziaVPN; экспорт для iOS через «Поделиться VPN»; на телефоне и на ПК подключение и интернет работают. Чистый сброс завершён успешно.

- **Бот — выдача конфигов AmneziaWG (Docker):** на eu1 развёрнуты скрипты amneziawg-add-client-docker.sh и amneziawg-remove-client-docker.sh; конфиг сервера в контейнере — /opt/amnezia/awg/awg0.conf; в скрипт добавлено извлечение обфускации (Jc, Jmin, Jmax, S1–S4, H1–H4) и подстановка в клиентский .conf. На Timeweb в env указаны пути к *-docker.sh; бот по /get_config и /regen выдаёт конфиги. На телефоне с конфигом от бота: handshake есть, трафик не грузится (открытый вопрос — см. SESSION_SUMMARY и docs/eu1-phone-config-open-question.md).

## 2026-02-21 — Веб-панель: деплой, этапы 2–3, подсказки

- **Деплой:** панель развёрнута на Timeweb на порту 5001 (чтобы не конфликтовать с Damir на 5000). Добавлены `web/vpn-web.service.example`, раздел в `docs/deployment.md`, переменная PORT=5001.
- **Этап 2:** блок «Сервисы» (API `/api/services` — WireGuard, AmneziaWG по пингу; Shadowsocks и MTProto по проверке TCP-портов); блок «Пользователи (сводка)» (без блока «По типам профилей»).
- **Этап 3:** учёт трафика — `wg show dump` локально для main, по SSH для eu1; API `/api/traffic`, блок «Трафик по пользователям» (по пользователям и по устройствам), обновление раз в 30 сек.
- **Подсказки:** под каждым блоком панели добавлены короткие пояснения (пользователь vs подключение, онлайн/офлайн по пингу, main/eu1, частота обновления трафика, подключение = конфиг, не устройство).

## 2026-02-21 — Бот: Европа = AmneziaWG (инструкция + опция выдачи конфига через скрипт)

- **Европа (eu1) в боте:** для сервера «Европа» бот больше не выдаёт WireGuard конфиги. Выдаётся инструкция по AmneziaWG (ПК + iOS через «Поделиться»). При настройке скрипта на eu1 (`AMNEZIAWG_EU1_ADD_CLIENT_SCRIPT`) бот вызывает скрипт по SSH и выдаёт готовый AmneziaWG .conf.
- **Спецификация и скрипты:** созданы `docs/specs/spec-05-bot-amneziawg-eu1.md`, `docs/scripts/amneziawg-add-client.sh.example`, `docs/amneziawg-eu1-discovery.md` (проверка на eu1). В `env_vars.example.txt` добавлены переменные для AmneziaWG.
- **Тексты бота:** обновлены /start, /help, /instruction — Европа = AmneziaWG, импорт в AmneziaVPN/AmneziaWG. Добавлен короткий текст `docs/bot-instruction-texts/instruction_amneziawg_short.txt`. Регенерация (/regen) для Европы пока вручную — сообщение «напиши владельцу».
- **Код:** в `bot/wireguard_peers.py` добавлены `is_amneziawg_eu1_configured()`, `create_amneziawg_peer_and_config_for_user()`, `_remove_amneziawg_peer()`, `regenerate_amneziawg_peer_and_config_for_user()`; в `bot/main.py` — ветка для eu1 (AmneziaWG скрипт или инструкция), автоматическая регенерация (/regen) для Европы при настроенных скриптах.
- **Автоматизация выдачи и регенерации:** доработаны скрипты add-client и remove-client (`docs/scripts/`); бот поддерживает reuse_ip при создании peer и автоматический /regen для Европы (удаление старого peer на eu1, создание нового с тем же IP). Добавлен пошаговый гайд `docs/amneziawg-bot-automation-setup.md`. Переменные env: AMNEZIAWG_EU1_INTERFACE, AMNEZIAWG_EU1_REMOVE_CLIENT_SCRIPT.

## 2026-02-21 — AmneziaWG на eu1 работает, iOS через «Поделиться», следующие задачи

- **VPN работает:** AmneziaWG на eu1 развёрнут, подключение из России (ПК + iPhone/iPad) работает. На iOS конфиг импортируется через «Поделиться» → AmneziaWG (выбор файла в пикере не срабатывал).
- **Инструкция для пользователей:** обновлена docs/client-instructions-amneziawg.md — импорт через «Поделиться» на iOS, какой файл использовать (.conf для AmneziaWG).
- **Решения владельца:** бэкап можно хранить в Git (репозиторий сделать приватным). Второй VPS отложен — без монетизации по бюджету не планируется. Бот — обновить инструкции (выдавать инструкцию по AmneziaWG, при возможности конфиг). Веб-панель — развернуть, получить ссылку, доработать под полный мониторинг (сейчас ссылки нет).
- **ROADMAP и README:** обновлены: задачи по боту (выдача инструкции/конфига AmneziaWG), веб-панель (деплой + ссылка + доработка мониторинга), второй VPS отложен. В docs/backup-restore.md добавлено про бэкап в Git при приватном репо.

## 2026-02-21 — Стратегия обхода блокировок РКН, выбор AmneziaWG, план развёртывания

- **Документ по стратегии обхода блокировок:**
  - Создан `docs/blocking-bypass-strategy.md` — контекст (что работает/блокируется в РФ 2026), варианты A/B/C/D (в т.ч. Shadowsocks + V2BOX), совет по провайдерам и доменам.
  - **Выбран вариант A (AmneziaWG):** один клиент AmneziaVPN на ПК и iOS/iPadOS; понятно пользователю; при блокировке РКН — добавить Xray в том же приложении.

- **РКН: начеку и легко перестраиваться:**
  - В ROADMAP_VPN.md добавлен раздел «РКН: быть начеку и легко перестраиваться» — документировать шаги, один клиент для пользователя, резерв Xray в Amnezia, при необходимости смена домена/провайдера.

- **Пошаговый план и инструкция развёртывания:**
  - Обновлён `docs/step-by-step-plan-bypass.md` — зафиксирован выбор A, упрощены шаги под AmneziaWG.
  - Создан `docs/amneziawg-deploy-instruction.md` — пошаговая инструкция: установка AmneziaVPN на ПК → добавление сервера eu1 по SSH → установка AmneziaWG через приложение → создание подключения → iOS/iPad по тому же приложению; раздел «Если РКН начнёт блокировать».

- **Обновление ROADMAP_VPN.md:**
  - Блок «Обход блокировок РКН»: выбор A отмечен как выполненный, следующие шаги — развернуть по инструкции, тест из России, при необходимости бот.
  - Раздел «Проблема eu1» сокращён до ссылок на AmneziaWG и резерв Xray.

- **SESSION_SUMMARY:**
  - Создан `SESSION_SUMMARY_2026-02-21.md` с контекстом сессии и замечаниями для следующего агента.

## 2026-02-20 — Улучшение UX и решение проблем тестирования

- **Улучшение UX в боте:**
  - Улучшены объяснения режимов "обычный VPN" и "VPN+GPT" в боте с понятными описаниями и эмодзи
  - Добавлена команда `/help` с подробной справкой о режимах VPN и типах профилей
  - Улучшены сообщения при выборе сервера и типа профиля
  - Добавлены визуальные индикаторы для лучшего понимания

- **Документация по диагностике проблем:**
  - Создан документ `docs/troubleshooting-multiple-devices.md` — диагностика проблемы с несколькими устройствами (плохо работает интернет при подключении с двух устройств)
  - Создан документ `docs/troubleshooting-ios-devices.md` — решение проблем VPN на iPhone без SIM и iPad
  - Создан документ `docs/troubleshooting-telegram-vpn-conflict.md` — решение конфликта VPN и Telegram proxy на iPhone
  - Создан скрипт `docs/scripts/monitor-server.sh.example` — мониторинг состояния VPN-сервера

- **Спецификация единого профиля:**
  - Создана спецификация `docs/specs/spec-04-unified-profile-all-services.md` с вариантами решения единого профиля для всех сервисов (YouTube + GPT + Telegram + сайты)
  - Исследованы 4 варианта решения, рекомендован гибридный вариант (WireGuard + Smart DNS + Shadowsocks)
  - Описана детальная реализация с чеклистом и рисками

- **Веб-панель мониторинга:**
  - Создана базовая структура веб-панели в `web/`
  - Реализовано Flask-приложение с API endpoints для мониторинга серверов, пользователей и статистики
  - Созданы HTML шаблоны, CSS стили и JavaScript для автообновления
  - Добавлена документация по установке и деплою

- **Изучение альтернатив:**
  - Создан документ `docs/vless-alternative.md` — изучение VLESS как альтернативы WireGuard
  - Сравнение VLESS с WireGuard по различным параметрам
  - Рекомендации по использованию VLESS в проекте

- **Обновление Roadmap:**
  - Обновлён `ROADMAP_VPN.md` с учётом всех выполненных задач
  - Отмечены выполненные задачи с датами
  - Добавлены новые разделы и обновлены существующие

## 2026-02-18 — Настройка WireGuard + Shadowsocks и клиентов

- **Сервер Fornex (Ubuntu 24.04)**
  - Установлен `shadowsocks-libev` и настроен клиентский конфиг `/etc/shadowsocks-libev/ss-wg.json` для подключения к Shadowsocks‑серверу `185.21.8.91:8388` (метод `aes-256-gcm`).
  - Запущен `ss-redir` как systemd‑сервис `ss-wg.service` (автозапуск, прослушивает `127.0.0.1:1081`).
  - В WireGuard‑конфиг `/etc/wireguard/wg0.conf` добавлены новые `Peer`:
    - Владелец iPhone: `10.1.0.4/32`.
    - Друг PC: `10.1.0.5/32`.
    - Друг iPhone: `10.1.0.6/32`.
    - Друг iPad: `10.1.0.7/32`.
  - Настроены iptables‑правила:
    - редирект всего TCP‑трафика на порты 80/443 от выбранных IP (`10.1.0.4/32`, `10.1.0.5/32`, `10.1.0.6/32`, `10.1.0.7/32`) на `127.0.0.1:1081` (Shadowsocks‑клиент);
    - разрешён форвардинг трафика интерфейса `wg0`.
  - Создана резервная копия основных конфигов:
    - `/etc/wireguard/wg0.conf`;
    - `/etc/wireguard/iphone.conf`;
    - `/etc/shadowsocks-libev/ss-wg.json`;
    - бэкапы сохранены в `/root/vpn-backups/2026-02-18/`.

- **Клиенты владельца**
  - **ПК (Windows)**:
    - Папка клиента Shadowsocks упорядочена (перенесена в отдельную директорию, например, `VPN.Shadowsocks`), проверено, что `Shadowsocks.exe` и `gui-config.json` работают корректно.
    - Текущий рабочий профиль WireGuard `client1` (от бота второго аккаунта) продолжает использоваться для обычного VPN.
  - **iPhone**:
    - Создан и импортирован новый профиль WireGuard `iphone`:
      - `Address = 10.1.0.4/32`, `DNS = 8.8.8.8`;
      - `Endpoint = <публичный IP Fornex>:51820`;
      - `AllowedIPs = 0.0.0.0/0`, `PersistentKeepalive = 25`.
    - Проверено, что при подключении профиля `iphone`:
      - ChatGPT работает;
      - обычные сайты идут через тот же сервер (с учётом ограничений/блокировок по IP Shadowsocks).

- **Клиенты друга** (по проектному допущению — успешно подключены)
  - **ПК (Friend PC)**:
    - Сгенерированы ключи и создан профиль WireGuard `friend-pc.conf`:
      - `Address = 10.1.0.5/32`, `DNS = 8.8.8.8`;
      - `Endpoint = <публичный IP Fornex>:51820`;
      - `AllowedIPs = 0.0.0.0/0`, `PersistentKeepalive = 25`.
  - **iPhone (Friend iPhone)**:
    - Профиль `friend-iphone.conf`:
      - `Address = 10.1.0.6/32`, остальные параметры аналогичны.
  - **iPad (Friend iPad)**:
    - Профиль `friend-ipad.conf`:
      - `Address = 10.1.0.7/32`, остальные параметры аналогичны.

- **Документация**
  - Создан файл `README_FOR_NEXT_AGENT.md` с описанием:
    - текущей архитектуры (WireGuard + Shadowsocks);
    - профилей владельца и друга;
    - расположения бэкапов конфигов;
    - ключевых правил безопасности и ограничений.
  - Создан `ROADMAP_VPN.md`:
    - зафиксировано текущее состояние (MVP 0.1);
    - намечены ближайшие и среднесрочные шаги (спеки, Telegram‑proxy, второй сервер, автоматизация через бота).

## 2026-02-18 — Установка Telegram MTProto Proxy

- **Сервер Fornex (Ubuntu 24.04)**
  - Установлен Docker (версия 29.2.1) для запуска контейнеров.
  - Развёрнут MTProto‑прокси через Docker‑контейнер `telegrammessenger/proxy:latest`:
    - контейнер: `mtproto-proxy` (автозапуск через `--restart=always`);
    - порт: `443/TCP` (маппинг `0.0.0.0:443->443/tcp`);
    - секрет: `29d11c61ea1b644d75299dd0706c2da3` (сгенерирован автоматически при запуске);
    - внешний IP: `185.21.8.91` (тот же, что у WireGuard‑сервера).
  - Сформирована ссылка подключения:
    - `tg://proxy?server=185.21.8.91&port=443&secret=29d11c61ea1b644d75299dd0706c2da3`;
    - альтернативная ссылка: `https://t.me/proxy?server=185.21.8.91&port=443&secret=29d11c61ea1b644d75299dd0706c2da3`;
    - ссылка сохранена в `/root/vpn-backups/2026-02-18/mtproto-link.txt`.
  - Проверена работа прокси:
    - контейнер запущен и работает стабильно;
    - пинг через прокси: ~45 мс (приемлемо для Telegram);
    - прокси работает независимо от WireGuard и Shadowsocks.

- **Клиенты**
  - **Владелец**: протестирован MTProto‑прокси на iPhone, подключение успешно, Telegram работает через прокси.
  - **Друг**: предоставлена ссылка подключения, прокси успешно настроен и работает на его устройствах.

- **Документация**
  - Создана спецификация `docs/specs/spec-02-telegram-mtproto-proxy.md`:
    - архитектура MTProto‑прокси;
    - требования и этапы реализации;
    - риски и митигация;
    - чеклист проверки.
  - Создана инструкция по установке `docs/mtproto-setup.md`:
    - пошаговая установка Docker (если не установлен);
    - запуск контейнера MTProto‑прокси;
    - получение секрета и формирование ссылки подключения;
    - настройка systemd (опционально);
    - тестирование на клиентах;
    - управление и устранение проблем.
  - Обновлены основные документы проекта:
    - `README_FOR_NEXT_AGENT.md`: добавлена информация о MTProto‑прокси в разделы "Серверы" и "Как этим пользоваться";
    - `ROADMAP_VPN.md`: отмечена выполненная задача по установке MTProto‑прокси.

## 2026-02-18 — Интеграция бота: инструкции, MTProto-ссылка, VPN+GPT

- **Команды бота**
  - Добавлена команда `/instruction` — пошаговая инструкция по подключению (ПК и iPhone/iPad); тексты загружаются из `docs/bot-instruction-texts/instruction_pc_short.txt` и `instruction_ios_short.txt`.
  - Добавлена команда `/proxy` — отправка ссылки MTProto‑прокси и краткой инструкции из `instruction_mtproto_short.txt`; ссылка читается из переменной окружения `MTPROTO_PROXY_LINK` (на Timeweb добавлена в `env_vars.txt`).
  - После успешной выдачи конфига по `/get_config` бот автоматически отправляет объединённую инструкцию (ПК + iOS).
  - В приветствии `/start` добавлены строки про `/instruction` и `/proxy`.

- **Конфигурация бота**
  - В `bot/config.py`: добавлены поля `base_dir`, `mtproto_proxy_link`; загрузка `MTPROTO_PROXY_LINK` из env (опционально).
  - В `docs/deployment.md`: раздел «Обновление бота на Timeweb» — напоминание, что `env_vars.txt` на сервере не в Git и новые переменные нужно добавлять вручную; команды для `git pull`, перезапуска сервиса и просмотра логов.

- **Опция VPN+GPT для Европы (eu1)**
  - При выборе сервера «Европа» в `/server` добавлен второй шаг: выбор типа профиля — «Обычный VPN» или «VPN+GPT (обход блокировок ChatGPT)».
  - Для VPN+GPT: выделение IP из пула **10.1.0.8–10.1.0.254**; после добавления peer в WireGuard бот по SSH на eu1 вызывает скрипт `add-ss-redirect.sh <IP>`, добавляющий iptables‑редирект TCP 80/443 на порт 1081 (ss-redir).
  - Имя конфига для VPN+GPT: `vpn_<id>_eu1_gpt.conf`; в сообщении бота явно указан тип «VPN+GPT».
  - В `bot/storage.py`: у `User` — поле `preferred_profile_type` (vpn / vpn_gpt); у `Peer` — поле `profile_type`; при регенерации конфига тип профиля сохраняется.
  - В `bot/wireguard_peers.py`: функции `_allocate_ip_in_pool()`, `_run_add_ss_redirect()`; в `create_peer_and_config_for_user()` добавлен параметр `profile_type`; опциональная переменная env `WG_EU1_ADD_SS_REDIRECT_SCRIPT` (по умолчанию `/opt/vpnservice/scripts/add-ss-redirect.sh`).

- **Скрипт add-ss-redirect.sh на eu1**
  - Пример скрипта: `docs/scripts/add-ss-redirect.sh.example`; развёртывание и путь описаны в `docs/deployment.md`.
  - На сервере eu1 (Fornex) скрипт развёрнут в `/opt/vpnservice/scripts/add-ss-redirect.sh`, выполнен `chmod +x`, проверен вызов с аргументом `10.1.0.8` и наличие правил в iptables.
  - На Timeweb в `env_vars.txt` добавлена переменная `WG_EU1_ADD_SS_REDIRECT_SCRIPT=/opt/vpnservice/scripts/add-ss-redirect.sh` (опционально, путь по умолчанию совпадает).

- **Документация и планы**
  - Спека `docs/specs/spec-03-bot-integration-instructions.md`: отмечены выполненные пункты (инструкции, MTProto, VPN+GPT, скрипт).
  - `ROADMAP_VPN.md`: отмечены выполненные задачи (выдача инструкции, команда /proxy, опция VPN+GPT в боте); оставлена задача «На сервере eu1 развернуть add-ss-redirect.sh» как выполненная по факту (скрипт развёрнут).

# DONE_LIST_VPN

История выполненных задач по проекту VPN.

## 2026-02-09

- Создана базовая структура документации для проекта VPN:
  - добавлен `ROADMAP_VPN.md` с этапами развития (MVP, бот, масштабирование, коммерциализация);
  - подготовлен шаблон для `SESSION_SUMMARY_2026-02-09.md` (см. файл сессии);
  - проект VPN интегрирован в центральные документы (`RULES_CURSOR.md`, `PROJECTS.md`, `ROAD_MAP_AI.md`, `QUICK_START_AGENT.md`, `docs/AGENT_PROMPTS.md`).
- Инициализирован отдельный Git-репозиторий для проекта VPN:
  - создан локальный репозиторий в папке `VPN/` (`git init`);
  - привязан к GitHub-репозиторию `nikkronos/vpnservice` (`git remote add origin`);
  - выполнен первый коммит с базовой структурой документации (`chore: initialize vpnservice repo structure`);
  - ветка переименована в `main` и отправлена на GitHub (`git push -u origin main`).
- Определена стратегия развёртывания:
  - первая нода будет развёрнута на существующем Timeweb-сервере (для тестирования и экономии средств);
  - в дальнейшем — миграция на отдельный VPS под VPN.
- Создана детальная инструкция по развёртыванию:
  - `VPN/docs/deployment.md` — пошаговое руководство по установке и настройке WireGuard на сервере;
  - включает генерацию ключей, конфигурацию сервера и клиентов, тестирование подключения.
- Развёрнута первая WireGuard-нода на существующем Timeweb-сервере (81.200.146.32):
  - установлен WireGuard, сгенерированы ключи сервера и клиента;
  - настроен интерфейс wg0, IP forwarding, UFW (порт 51820/UDP), systemd автозапуск;
  - создан конфиг клиента client1.conf, скопирован на Windows через scp.
- Успешное тестирование на Windows:
  - туннель «client1» подключён, внешний IP — 81.200.146.32;
  - ping 8.8.8.8: 0% потерь, ~10–15 мс;
  - Speedtest: ~91 Мбит/с вниз, ~88 Мбит/с вверх, пинг 10 мс.
- Успешное тестирование на iOS:
  - установлен qrencode на сервере, сгенерирован QR-код из client1.conf;
  - конфиг добавлен в WireGuard на iPhone через сканирование QR-кода;
  - подключение работает.

## 2026-02-11

- Реализован self-service через Telegram-бота:
  - спроектирована модель данных для пользователей (`users.json`) и VPN-подключений (`peers.json`);
  - добавлен модуль `bot/storage.py` с dataclass `Peer` и функциями для работы с peers;
  - добавлен модуль `bot/wireguard_peers.py` для интеграции с WireGuard (генерация ключей, подбор IP, добавление peer через `wg set`, формирование `.conf`);
  - переработан `bot/main.py` под сценарий self-service (команды `/start`, `/get_config`, `/my_config`, `/add_user`, `/users` с учётом новой модели данных).
- Настроены переменные окружения для VPN-проекта:
  - в `env_vars.txt` добавлены параметры `WG_SERVER_PUBLIC_KEY`, `WG_INTERFACE`, `WG_NETWORK_CIDR`, `WG_ENDPOINT_HOST`, `WG_ENDPOINT_PORT`, `WG_DNS`;
  - `WG_SERVER_PUBLIC_KEY` получен с помощью `wg show wg0 public-key` на сервере.
- Настроено обновление кода на сервере `/opt/vpnservice`:
  - сконфигурирован доступ к GitHub через Personal Access Token для `nikkronos/vpnservice`;
  - аккуратно разрешён конфликт между старым локальным `bot/storage.py` и новой версией из репозитория (старый файл сохранён как бэкап);
  - выполнен `git pull`, подтянуты новые файлы (`bot/main.py`, `bot/storage.py`, `bot/wireguard_peers.py`, `bot/__init__.py`, specs), перезапущен `vpn-bot.service`.
- Протестирован self-service для друзей:
  - владелец добавляет друга командой `/add_user` (ответом на сообщение или по Telegram ID);
  - друг пишет боту `/start` и `/get_config`, бот создаёт peer в WireGuard, сохраняет его в `peers.json` и отправляет конфигурационный файл `vpn_<telegram_id>.conf`;
  - как минимум один друг успешно подключился к VPN: YouTube и Instagram работают через туннель.
- Обновлены планы по развитию infrastructure и multi-node в `ROADMAP_VPN.md` (добавлены задачи по оценке нагрузки и внедрению нескольких нод/регионов).

## 2026-02-13

- Уточнены лимиты трафика у провайдера Timeweb:
  - подтверждено, что базовых ограничений по объёму трафика нет;
  - основное требование — не нарушать правила платформы (отсутствие незаконного контента, DDoS, спама и т.п.);
  - сделан вывод, что текущий VPS подходит для использования VPN друзьями и коллегами без жёстких лимитов по трафику.
- Доведена до рабочего состояния команда `/regen` (регенерация ключей и конфига WireGuard):
  - реализованы функции `_remove_peer_from_wireguard()` и `regenerate_peer_and_config_for_user()` в `bot/wireguard_peers.py`;
  - обновлён хендлер `/regen` в `bot/main.py`, который удаляет старый peer, создаёт новый с тем же IP и отправляет пользователю обновлённый `.conf`;
  - исправлена ошибка с отсутствующим импортом `find_peer_by_telegram_id`, из-за которой бот молчал при вызове `/regen`;
  - протестировано на боевом пользователе: новый конфиг успешно отработал, туннель продолжил работать.
- GitHub‑репозиторий `nikkronos/vpnservice` временно сделан публичным для упрощения деплоя (без постоянного ввода PAT); зафиксирована необходимость после завершения работ вернуть репозиторий в приватный режим и убедиться в отсутствии секретов в истории коммитов.

## 2026-02-14

- Добавлена вторая VPN-нода **eu1 (Европа)** на Fornex (Германия):
  - заказан VPS Cloud NVMe 1 (1 ядро, 1 ГБ RAM, 10 ГБ NVMe, безлимитный трафик) в локации Германия;
  - на сервере 185.21.8.91 установлен WireGuard (Ubuntu 24.04 LTS), настроен интерфейс wg0 в подсети 10.1.0.0/24, порт 51820/UDP, IP forwarding, UFW;
  - сгенерированы ключи сервера eu1, публичный ключ добавлен в конфигурацию бота.
- Настроен доступ бота (Timeweb) к ноде eu1 по SSH:
  - на Timeweb создан отдельный SSH-ключ для доступа к eu1;
  - публичный ключ добавлен в `authorized_keys` на Fornex (eu1);
  - в `env_vars.txt` на Timeweb добавлены переменные WG_EU1_* (SERVER_PUBLIC_KEY, INTERFACE, NETWORK_CIDR, ENDPOINT_HOST/PORT, DNS, SSH_HOST/USER/KEY_PATH).
- Логика бота обновлена ранее: `get_available_servers()` возвращает eu1 только при наличии WG_EU1_SERVER_PUBLIC_KEY и WG_EU1_ENDPOINT_HOST; переменные для нод используют формат WG_<SERVERID>_* (см. env_vars.example.txt).
- Успешная проверка в боте:
  - в `/server` отображаются две опции: «Россия (Timeweb)» и «Европа»;
  - пользователь выбрал «Европа», вызвал `/get_config` — бот создал peer на eu1 по SSH и отправил конфиг;
  - импорт конфига в WireGuard и подключение к ноде Европа работают; доступ к ChatGPT и другим EU-сервисам через eu1 обеспечен.
- Исправлена путаница с конфигами при переключении серверов:
  - имена файлов конфигов изменены с `vpn_<telegram_id>.conf` на `vpn_<telegram_id>_<server_id>.conf` (например, `vpn_123_main.conf` и `vpn_123_eu1.conf`);
  - в `bot/main.py` обновлены вызовы для `/get_config` и `/regen`, чтобы пользователи не перезаписывали и не путали конфиги для РФ и Европы.

## 2026-02-15

- Продолжена отладка ноды eu1 (Fornex): проблема «Получено 0, отправлено ок» не решена с прошлым агентом.
- Расширена документация по отладке eu1:
  - добавлены разделы 9–13 в `VPN/docs/eu1-setup-and-troubleshooting.md` (рекомендуемые проверки, обратный путь, финальные тесты, варианты обхода).
  - создан `VPN/docs/eu1-commands-step-by-step.md` — пошаговые команды для диагностики.
  - создан `VPN/docs/eu1-workarounds-fornex.md` — инструкции по обходным путям (ShadowSocks, Cloudflared, udp2raw, V2Ray).
- Добавлена опциональная поддержка MTU в клиентском конфиге:
  - в `bot/wireguard_peers.py` добавлен параметр `mtu` в конфиг ноды и в `_build_client_config()`.
  - если задан `WG_EU1_MTU` (например, 1280), в выдаваемый конфиг добавляется строка `MTU = 1280` в `[Interface]`.
  - обновлён `env_vars.example.txt` с примером `WG_EU1_MTU=1280`.
- Диагностика на Fornex:
  - исправлен пир с `AllowedIPs 10.1.0.0/24` → `10.1.0.2/32`.
  - добавлены правила iptables FORWARD в начало цепочки (wg0↔eth0, eth0→wg0 RELATED,ESTABLISHED).
  - rp_filter установлен в 0 для all и wg0.
  - выполнен tcpdump на eth0 (UDP 51820, 45 секунд) — пакетов от клиента к серверу не видно, но `wg show` показывает активный обмен (14.25 KiB received, 33.17 KiB sent).
- Вывод по eu1:
  - WireGuard UDP (порт 51820) на Fornex технически не работает для клиентов из России (блокировка/потеря трафика на маршруте Россия ↔ Fornex).
  - Сервер настроен корректно (все проверки пройдены), проблема вне зоны контроля.
  - Подготовлены варианты обходных путей для Fornex (ShadowSocks, Cloudflared, udp2raw, V2Ray) — см. `eu1-workarounds-fornex.md`.
- Обновлён `ROADMAP_VPN.md`: добавлена задача про проблему eu1 и варианты решения (обходные пути или миграция на другой провайдер).
- Fornex подтвердил: «С нашей стороны, ограничений нет.» — исходящий UDP с VPS до абонентских IP со стороны Fornex не блокируется.

