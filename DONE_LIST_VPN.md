# DONE_LIST_VPN

История выполненных задач по проекту VPN.

## 2026-02-09

- Создана базовая структура документации для проекта VPN:
  - добавлен `ROADMAP_VPN.md` с этапами развития (MVP, бот, масштабирование, коммерциализация);
  - подготовлен шаблон для `SESSION_SUMMARY_2026-02-09.md` (см. файл сессии);
  - проект VPN интегрирован в центральные документы (`RULES_CURSOR.md`, `PROJECTS.md`, `ROAD_MAP_AI.md`, `QUICK_START_AGENT.md`, `docs/AGENT_PROMPTS.md`).
- Инициализирован отдельный Git-репозиторий для проекта VPN:
  - создан локальный репозиторий в папке `VPN/` (`git init`);
  - привязан к GitHub-репозиторию `nikkronos/vpnservice` (`git remote add origin`);
  - выполнен первый коммит с базовой структурой документации (`chore: initialize vpnservice repo structure`);
  - ветка переименована в `main` и отправлена на GitHub (`git push -u origin main`).
- Определена стратегия развёртывания:
  - первая нода будет развёрнута на существующем Timeweb-сервере (для тестирования и экономии средств);
  - в дальнейшем — миграция на отдельный VPS под VPN.
- Создана детальная инструкция по развёртыванию:
  - `VPN/docs/deployment.md` — пошаговое руководство по установке и настройке WireGuard на сервере;
  - включает генерацию ключей, конфигурацию сервера и клиентов, тестирование подключения.
- Развёрнута первая WireGuard-нода на существующем Timeweb-сервере (81.200.146.32):
  - установлен WireGuard, сгенерированы ключи сервера и клиента;
  - настроен интерфейс wg0, IP forwarding, UFW (порт 51820/UDP), systemd автозапуск;
  - создан конфиг клиента client1.conf, скопирован на Windows через scp.
- Успешное тестирование на Windows:
  - туннель «client1» подключён, внешний IP — 81.200.146.32;
  - ping 8.8.8.8: 0% потерь, ~10–15 мс;
  - Speedtest: ~91 Мбит/с вниз, ~88 Мбит/с вверх, пинг 10 мс.
- Успешное тестирование на iOS:
  - установлен qrencode на сервере, сгенерирован QR-код из client1.conf;
  - конфиг добавлен в WireGuard на iPhone через сканирование QR-кода;
  - подключение работает.

## 2026-02-11

- Реализован self-service через Telegram-бота:
  - спроектирована модель данных для пользователей (`users.json`) и VPN-подключений (`peers.json`);
  - добавлен модуль `bot/storage.py` с dataclass `Peer` и функциями для работы с peers;
  - добавлен модуль `bot/wireguard_peers.py` для интеграции с WireGuard (генерация ключей, подбор IP, добавление peer через `wg set`, формирование `.conf`);
  - переработан `bot/main.py` под сценарий self-service (команды `/start`, `/get_config`, `/my_config`, `/add_user`, `/users` с учётом новой модели данных).
- Настроены переменные окружения для VPN-проекта:
  - в `env_vars.txt` добавлены параметры `WG_SERVER_PUBLIC_KEY`, `WG_INTERFACE`, `WG_NETWORK_CIDR`, `WG_ENDPOINT_HOST`, `WG_ENDPOINT_PORT`, `WG_DNS`;
  - `WG_SERVER_PUBLIC_KEY` получен с помощью `wg show wg0 public-key` на сервере.
- Настроено обновление кода на сервере `/opt/vpnservice`:
  - сконфигурирован доступ к GitHub через Personal Access Token для `nikkronos/vpnservice`;
  - аккуратно разрешён конфликт между старым локальным `bot/storage.py` и новой версией из репозитория (старый файл сохранён как бэкап);
  - выполнен `git pull`, подтянуты новые файлы (`bot/main.py`, `bot/storage.py`, `bot/wireguard_peers.py`, `bot/__init__.py`, specs), перезапущен `vpn-bot.service`.
- Протестирован self-service для друзей:
  - владелец добавляет друга командой `/add_user` (ответом на сообщение или по Telegram ID);
  - друг пишет боту `/start` и `/get_config`, бот создаёт peer в WireGuard, сохраняет его в `peers.json` и отправляет конфигурационный файл `vpn_<telegram_id>.conf`;
  - как минимум один друг успешно подключился к VPN: YouTube и Instagram работают через туннель.
- Обновлены планы по развитию infrastructure и multi-node в `ROADMAP_VPN.md` (добавлены задачи по оценке нагрузки и внедрению нескольких нод/регионов).

## 2026-02-13

- Уточнены лимиты трафика у провайдера Timeweb:
  - подтверждено, что базовых ограничений по объёму трафика нет;
  - основное требование — не нарушать правила платформы (отсутствие незаконного контента, DDoS, спама и т.п.);
  - сделан вывод, что текущий VPS подходит для использования VPN друзьями и коллегами без жёстких лимитов по трафику.
- Доведена до рабочего состояния команда `/regen` (регенерация ключей и конфига WireGuard):
  - реализованы функции `_remove_peer_from_wireguard()` и `regenerate_peer_and_config_for_user()` в `bot/wireguard_peers.py`;
  - обновлён хендлер `/regen` в `bot/main.py`, который удаляет старый peer, создаёт новый с тем же IP и отправляет пользователю обновлённый `.conf`;
  - исправлена ошибка с отсутствующим импортом `find_peer_by_telegram_id`, из-за которой бот молчал при вызове `/regen`;
  - протестировано на боевом пользователе: новый конфиг успешно отработал, туннель продолжил работать.
- GitHub‑репозиторий `nikkronos/vpnservice` временно сделан публичным для упрощения деплоя (без постоянного ввода PAT); зафиксирована необходимость после завершения работ вернуть репозиторий в приватный режим и убедиться в отсутствии секретов в истории коммитов.

## 2026-02-14

- Добавлена вторая VPN-нода **eu1 (Европа)** на Fornex (Германия):
  - заказан VPS Cloud NVMe 1 (1 ядро, 1 ГБ RAM, 10 ГБ NVMe, безлимитный трафик) в локации Германия;
  - на сервере 185.21.8.91 установлен WireGuard (Ubuntu 24.04 LTS), настроен интерфейс wg0 в подсети 10.1.0.0/24, порт 51820/UDP, IP forwarding, UFW;
  - сгенерированы ключи сервера eu1, публичный ключ добавлен в конфигурацию бота.
- Настроен доступ бота (Timeweb) к ноде eu1 по SSH:
  - на Timeweb создан отдельный SSH-ключ для доступа к eu1;
  - публичный ключ добавлен в `authorized_keys` на Fornex (eu1);
  - в `env_vars.txt` на Timeweb добавлены переменные WG_EU1_* (SERVER_PUBLIC_KEY, INTERFACE, NETWORK_CIDR, ENDPOINT_HOST/PORT, DNS, SSH_HOST/USER/KEY_PATH).
- Логика бота обновлена ранее: `get_available_servers()` возвращает eu1 только при наличии WG_EU1_SERVER_PUBLIC_KEY и WG_EU1_ENDPOINT_HOST; переменные для нод используют формат WG_<SERVERID>_* (см. env_vars.example.txt).
- Успешная проверка в боте:
  - в `/server` отображаются две опции: «Россия (Timeweb)» и «Европа»;
  - пользователь выбрал «Европа», вызвал `/get_config` — бот создал peer на eu1 по SSH и отправил конфиг;
  - импорт конфига в WireGuard и подключение к ноде Европа работают; доступ к ChatGPT и другим EU-сервисам через eu1 обеспечен.
- Исправлена путаница с конфигами при переключении серверов:
  - имена файлов конфигов изменены с `vpn_<telegram_id>.conf` на `vpn_<telegram_id>_<server_id>.conf` (например, `vpn_123_main.conf` и `vpn_123_eu1.conf`);
  - в `bot/main.py` обновлены вызовы для `/get_config` и `/regen`, чтобы пользователи не перезаписывали и не путали конфиги для РФ и Европы.

## 2026-02-15

- Продолжена отладка ноды eu1 (Fornex): проблема «Получено 0, отправлено ок» не решена с прошлым агентом.
- Расширена документация по отладке eu1:
  - добавлены разделы 9–13 в `VPN/docs/eu1-setup-and-troubleshooting.md` (рекомендуемые проверки, обратный путь, финальные тесты, варианты обхода).
  - создан `VPN/docs/eu1-commands-step-by-step.md` — пошаговые команды для диагностики.
  - создан `VPN/docs/eu1-workarounds-fornex.md` — инструкции по обходным путям (ShadowSocks, Cloudflared, udp2raw, V2Ray).
- Добавлена опциональная поддержка MTU в клиентском конфиге:
  - в `bot/wireguard_peers.py` добавлен параметр `mtu` в конфиг ноды и в `_build_client_config()`.
  - если задан `WG_EU1_MTU` (например, 1280), в выдаваемый конфиг добавляется строка `MTU = 1280` в `[Interface]`.
  - обновлён `env_vars.example.txt` с примером `WG_EU1_MTU=1280`.
- Диагностика на Fornex:
  - исправлен пир с `AllowedIPs 10.1.0.0/24` → `10.1.0.2/32`.
  - добавлены правила iptables FORWARD в начало цепочки (wg0↔eth0, eth0→wg0 RELATED,ESTABLISHED).
  - rp_filter установлен в 0 для all и wg0.
  - выполнен tcpdump на eth0 (UDP 51820, 45 секунд) — пакетов от клиента к серверу не видно, но `wg show` показывает активный обмен (14.25 KiB received, 33.17 KiB sent).
- Вывод по eu1:
  - WireGuard UDP (порт 51820) на Fornex технически не работает для клиентов из России (блокировка/потеря трафика на маршруте Россия ↔ Fornex).
  - Сервер настроен корректно (все проверки пройдены), проблема вне зоны контроля.
  - Подготовлены варианты обходных путей для Fornex (ShadowSocks, Cloudflared, udp2raw, V2Ray) — см. `eu1-workarounds-fornex.md`.
- Обновлён `ROADMAP_VPN.md`: добавлена задача про проблему eu1 и варианты решения (обходные пути или миграция на другой провайдер).
- Fornex подтвердил: «С нашей стороны, ограничений нет.» — исходящий UDP с VPS до абонентских IP со стороны Fornex не блокируется.

