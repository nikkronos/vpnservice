# VPN / Proxy проект — кратко для следующего агента

## Что это за проект

- **Цель**: личный VPN/Proxy‑сервис для владельца и друзей, который:
  - даёт быстрый обычный VPN через WireGuard;
  - умеет обходить блокировки ChatGPT и других сервисов через связку WireGuard → Shadowsocks;
  - предоставляет Telegram‑proxy (MTProto) для обхода блокировок Telegram;
  - в перспективе будет дополняться коммерческими тарифами.
- **Код** этого проекта живёт в отдельном репозитории GitHub `nikkronos/vpnservice`. Папка `Projects/VPN/` в этом монорепозитории служит для документации и спецификаций.

## Текущее состояние (2026‑02‑18)

### Серверы

- **VPN‑сервер Fornex (Ubuntu 24.04)**:
  - Поднят WireGuard‑сервер `wg0`:
    - адрес сервера: `10.1.0.1/24`;
    - порт: `51820/UDP`;
    - NAT и форвардинг настроены через `PostUp`/`PostDown` в `wg0.conf`.
  - Установлен клиент **Shadowsocks** (`shadowsocks-libev`):
    - конфиг клиента: `/etc/shadowsocks-libev/ss-wg.json`;
    - локальный редирект‑порт: `127.0.0.1:1081`;
    - подключается к внешнему Shadowsocks‑серверу `185.21.8.91:8388` (`aes-256-gcm`).
  - Сервис `ss-redir` оформлен как `systemd`‑юнит `ss-wg.service` и запускается автоматически.
  - iptables‑правила:
    - для выбранных IP клиентов WireGuard (см. ниже) весь TCP‑трафик на порты 80/443 редиректится на `127.0.0.1:1081`;
    - таким образом, HTTP/HTTPS этих клиентов идёт через Shadowsocks, а всё остальное — напрямую через сервер.
  - Установлен **Telegram MTProto Proxy** (Docker‑контейнер `telegrammessenger/proxy`):
    - контейнер: `mtproto-proxy` (автозапуск через `--restart=always`);
    - порт: `443/TCP`;
    - секрет: `29d11c61ea1b644d75299dd0706c2da3`;
    - ссылка подключения: `tg://proxy?server=185.21.8.91&port=443&secret=29d11c61ea1b644d75299dd0706c2da3`;
    - внешний IP: `185.21.8.91` (тот же, что у WireGuard‑сервера);
    - ссылка сохранена в `/root/vpn-backups/2026-02-18/mtproto-link.txt`.

### Клиенты и профили (высокоуровнево)

- **Владелец (ты)**:
  - **ПК (Windows)**:
    - Профиль `client1` — WireGuard‑профиль, выданный Telegram‑ботом (обычный VPN через Fornex‑сервер, без обязательного Shadowsocks).
    - Клиент **Shadowsocks для Windows** (`Shadowsocks.exe`), настроенный на `185.21.8.91:8388` (тот же пароль, что на сервере). Используется поверх `client1` для ChatGPT.
  - **iPhone**:
    - Профиль `client1` — WireGuard от бота (обычный VPN).
    - Профиль `iphone` — новый WireGuard‑профиль:
      - адрес клиента: `10.1.0.4/32`;
      - `AllowedIPs = 0.0.0.0/0`;
      - DNS: `8.8.8.8`;
      - трафик HTTP/HTTPS с этого адреса на сервере редиректится через `ss-redir` → Shadowsocks → `185.21.8.91`.
    - Поведение:
      - включён только `iphone` → GPT и другие HTTPS‑ресурсы идут через Shadowsocks (тот же эффект, что V2RayTun, но без второго VPN);
      - включён `client1` → обычный VPN без обязательного Shadowsocks.

- **Друг** (предполагаем, что всё успешно подключено):
  - **ПК (Friend PC)**:
    - Профиль от бота — обычный VPN (аналог `client1`).
    - Профиль `friend-pc`:
      - адрес: `10.1.0.5/32`;
      - `AllowedIPs = 0.0.0.0/0`, DNS: `8.8.8.8`;
      - HTTP/HTTPS редиректится через Shadowsocks.
  - **iPhone (Friend iPhone)**:
    - Профиль от бота — обычный VPN.
    - Профиль `friend-iphone`:
      - адрес: `10.1.0.6/32`;
      - те же настройки, редирект через Shadowsocks.
  - **iPad (Friend iPad)**:
    - Профиль от бота — обычный VPN.
    - Профиль `friend-ipad`:
      - адрес: `10.1.0.7/32`;
      - те же настройки, редирект через Shadowsocks.

### Резервные копии конфигов на сервере

- Вручную создана директория бэкапов:
  - `/root/vpn-backups/2026-02-18/`
  - там лежат:
    - `wg0.conf`;
    - `iphone.conf`;
    - `ss-wg.json`.
- При изменении конфигов WireGuard/Shadowsocks рекомендуется создавать новые дата‑директории в `/root/vpn-backups/YYYY-MM-DD/` перед правками.

## Как этим пользоваться (для владельца и друга)

- **Обычный VPN (всё, кроме GPT)**:
  - у владельца: включать профили WireGuard, выданные Telegram‑ботом (`client1` на ПК и iPhone); при необходимости на ПК можно дополнительно включать Shadowsocks‑клиент.
  - у друга: включать профили от бота на всех устройствах.
- **VPN + рабочий GPT (обход блокировок)**:
  - у владельца:
    - на ПК: `client1` + клиент Shadowsocks (как раньше);
    - на iPhone: включать профиль `iphone` (и выключать остальные VPN/прокси на устройстве).
  - у друга:
    - на ПК/iPhone/iPad: включать наши профили `friend-pc`, `friend-iphone`, `friend-ipad` соответственно (без V2RayTun).
- **Telegram через MTProto‑прокси** (обход блокировок Telegram):
  - у владельца и друга:
    - в Telegram (iOS/Android/Desktop): добавить MTProto‑прокси через ссылку `tg://proxy?server=185.21.8.91&port=443&secret=29d11c61ea1b644d75299dd0706c2da3`;
    - прокси работает независимо от VPN (можно использовать только прокси для Telegram, без включения VPN);
    - пинг через прокси: ~45 мс (приемлемо для Telegram).

## Что планируется дальше (высокоуровнево)

- Оформить этот дизайн как спеки в `docs/specs/` (архитектура WireGuard+Shadowsocks+MTProto, сценарии подключения, чеклисты).
- Добавить:
  - второй/резервный VPN‑сервер (например, отдельный EU‑сервер только под Shadowsocks/WireGuard);
  - автоматическую выдачу инструкций и ссылки MTProto через бота (см. docs/specs/spec-03-bot-integration-instructions.md и docs/bot-instruction-texts/).
- **Бот:** для выдачи ссылки MTProto в переменных окружения бота (на сервере, где крутится бот) добавить `MTPROTO_PROXY_LINK=tg://proxy?server=185.21.8.91&port=443&secret=29d11c61ea1b644d75299dd0706c2da3` (или читать из env_vars.txt). Тексты инструкций для пользователей лежат в `docs/bot-instruction-texts/`.
- Вынести рабочие скрипты/ansible‑ролли/инструкции в отдельный репозиторий `nikkronos/vpnservice` (или синхронизировать с существующим).

## Критические замечания для следующего агента

1. **Не трогать пароли и ключи** в этом репозитории — все реальные значения хранятся на сервере / в переменных окружения и НЕ должны попадать в Git.
2. **Перед изменением конфигов на сервере**:
   - сделать бэкап в `/root/vpn-backups/YYYY-MM-DD/`;
   - проверить, что `ss-wg.service` активен и слушает `127.0.0.1:1081`;
   - проверить, что контейнер `mtproto-proxy` работает: `sudo docker ps | grep mtproto-proxy`.
3. **Не менять адреса уже выданных клиентов** без крайней необходимости — это сломает существующие конфиги владельца и друга.
4. При разработке новой логики (MTProto, второй сервер, новые клиенты) сначала обновляй спецификацию в `docs/specs/`, потом уже вноси изменения на серверах/в коде.

# README_FOR_NEXT_AGENT — Проект VPN

## Кратко о проекте

- **Что это:** Собственный VPN/Proxy сервис с управлением через Telegram-бота.
- **Для кого:** В первую очередь — владелец, друзья и коллеги; в перспективе — платный сервис для клиентов.
- **Основные приоритеты:**
  - высокая скорость и адекватный пинг;
  - простое подключение (Windows и iOS через стандартные клиенты WireGuard);
  - лёгкое восстановление при сбоях;
  - максимум автоматизации через бота.

## Где что лежит

- `ROADMAP_VPN.md` — дорожная карта проекта (этапы: подготовка, MVP, бот, масштабирование, коммерциализация).
- `DONE_LIST_VPN.md` — история выполненных задач.
- `SESSION_SUMMARY_YYYY-MM-DD.md` — файл сессии (актуален только для последней сессии).
- `docs/` — база знаний проекта (архитектура, безопасность, онбординг и т.д.).

## Как начинать работу

1. **Прочитай общие правила:**
   - `RULES_CURSOR.md` — общие правила работы с проектами.
   - `docs/AGENT_PROMPTS.md` — полная инструкция для агента (особенно разделы про проекты и документацию).

2. **Пойми контекст VPN-проекта:**
   - Прочитай `ROADMAP_VPN.md` — какие этапы запланированы и что уже в приоритете.
   - Пролистай `DONE_LIST_VPN.md`, чтобы понять историю решений.
   - Ознакомься с последним `SESSION_SUMMARY_YYYY-MM-DD.md` в папке `VPN/`.

3. **Изучи базу знаний VPN (когда появится):**
   - `VPN/docs/architecture.md` — общая схема (WireGuard-ноды, backend, Telegram-бот).
   - `VPN/docs/security.md` — требования к ключам, логам, секретам.
   - `VPN/docs/agent-onboarding.md` — онбординг для агентов.

## Общие технические решения (на старте)

- **Протокол:** WireGuard как основной VPN-протокол (MVP).
- **Клиенты:** официальные клиенты WireGuard на Windows и iOS.
- **Интерфейс для пользователей:** Telegram-бот по аналогии с `@hitvpnbot`, `@barinvpn_bot`, `@avoVPN_bot`.
- **Репозиторий:** отдельный Git-репозиторий для папки `VPN/` (аналогично проекту `xxx/`).

## Что важно соблюдать

- **Безопасность:**
  - Не хранить секреты и приватные ключи в Git.
  - Использовать `env_vars.txt` / `.env` и общие правила из `RULES_CURSOR.md` и `docs/security.md`.
- **Документация:**
  - При каждой сессии обновлять:
    - `SESSION_SUMMARY_YYYY-MM-DD.md` — только текущая сессия;
    - `DONE_LIST_VPN.md` — переносить результаты прошлых сессий и добавлять новые задачи;
    - `ROADMAP_VPN.md` — отмечать выполненные пункты и актуализировать планы.
- **Единый стиль:**
  - Следовать паттернам из `docs/patterns.md` (общий стиль кода и структуры).
  - Строить документацию по тем же шаблонам, что и другие проекты в репозитории.

## С чего логично продолжить

- Инициализировать отдельный Git-репозиторий в папке `VPN/` и связать его с GitHub.
- Создать `VPN/docs/architecture.md`, `VPN/docs/security.md`, `VPN/docs/agent-onboarding.md`.
- Спланировать и реализовать Этап 1 (MVP с одной WireGuard-нодой) по шагам из `ROADMAP_VPN.md`.

