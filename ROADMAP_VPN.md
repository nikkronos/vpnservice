# ROADMAP_VPN — план развития VPN/Proxy проекта

## 1. Текущее состояние (MVP 0.1)

- Есть один VPN‑сервер на Fornex (Ubuntu 24.04):
  - WireGuard‑сервер `wg0` (`10.1.0.1/24`, порт `51820/UDP`).
  - Клиент Shadowsocks (`shadowsocks-libev` → `ss-redir`) c конфигом `/etc/shadowsocks-libev/ss-wg.json`, локальный порт `1081`.
  - iptables‑редирект HTTP/HTTPS для выбранных клиентов WireGuard через `ss-redir`.
- Настроены профили:
  - Владелец:
    - ПК: WireGuard‑профиль от Telegram‑бота + Windows‑клиент Shadowsocks.
    - iPhone: `client1` (от бота) + `iphone` (WireGuard через Shadowsocks).
  - Друг:
    - ПК: профиль от бота + `friend-pc`.
    - iPhone: профиль от бота + `friend-iphone`.
    - iPad: профиль от бота + `friend-ipad`.
- Есть резервная копия `wg0.conf`, `iphone.conf` и `ss-wg.json` в `/root/vpn-backups/2026-02-18/`.

## 2. Ближайшие цели (MVP 0.2)

- [x] **Документация и спеки**
  - [x] Завершить архитектурную спецификацию WireGuard+Shadowsocks (docs/specs/spec-01-architecture-wg-ss.md).
  - [x] Описать чеклист добавления нового клиента (Windows, iOS, iPadOS, Android) (docs/checklist-add-client.md).
  - [x] Описать процедуру резервного копирования и восстановления конфигов сервера (docs/backup-restore.md).

- [x] **Упрощение онбординга друзей**
  - [x] Сформировать шаблонные инструкции для клиентов:
    - [x] «Как подключиться на ПК (WireGuard + опционально Shadowsocks)» (docs/client-instructions-pc.md).
    - [x] «Как подключиться на iPhone/iPad (WireGuard)» (docs/client-instructions-ios.md).
  - [x] Условно зафиксировать нотацию имён профилей: `VPN RU`, `VPN GPT`, `Friend VPN`, `Friend VPN GPT` и т.п. (docs/profile-names.md).

- [x] **Проектная интеграция**
  - [ ] Синхронизировать эту документацию с отдельным репозиторием `nikkronos/vpnservice` (репозиторий уже используется; коммиты и push из папки `Projects/VPN/`).
  - [x] Добавить описание сервера Fornex в `docs/deployment.md` (путь, сервисы, юниты, команды проверки).

- [x] **Улучшение UX в боте** — 2026-02-20
  - [x] Улучшены объяснения режимов "обычный VPN" и "VPN+GPT" в боте с понятными описаниями
  - [x] Добавлена команда `/help` с подробной справкой о режимах VPN
  - [x] Улучшены сообщения при выборе сервера и типа профиля
  - [x] Добавлены эмодзи и визуальные индикаторы для лучшего понимания

- [x] **Документация по диагностике проблем** — 2026-02-20
  - [x] Создан документ `docs/troubleshooting-multiple-devices.md` — диагностика проблемы с несколькими устройствами
  - [x] Создан документ `docs/troubleshooting-ios-devices.md` — решение проблем VPN на iPhone без SIM и iPad
  - [x] Создан документ `docs/troubleshooting-telegram-vpn-conflict.md` — решение конфликта VPN и Telegram proxy
  - [x] Создан скрипт `docs/scripts/monitor-server.sh.example` — мониторинг состояния сервера

- [x] **Веб-панель мониторинга** — 2026-02-21
  - [x] Создана базовая структура веб-панели (`web/`), Flask + API, шаблоны, статус серверов, статистика пользователей.
  - [x] **Деплой веб-панели на сервере:** развёрнута на Timeweb (порт 5001, vpn-web.service), URL: http://81.200.146.32:5001. Зафиксировано в docs/deployment.md.
  - [x] **Доработать панель:** блоки «Сервисы» (WireGuard, AmneziaWG, Shadowsocks, MTProto), «Пользователи (сводка)», «Трафик по пользователям» (rx/tx с main и eu1), подсказки ко всем блокам.
  - [x] **Интервал обновления и диагностика** — 2026-02-22: автообновление с 30 сек изменено на 5 мин (снижение нагрузки); в блоке «Трафик» выводится время последнего обновления данных с бэкенда. В web/README.md добавлена диагностика «если трафик не меняется».
  - [x] **Трафик на панели (eu1):** для eu1 с AmneziaWG используется `awg show <interface> dump` (интерфейс из AMNEZIAWG_EU1_INTERFACE, по умолчанию awg0); нормализация public_key при сопоставлении с peers.json. Если трафик не менялся — проверить на сервере панели переменную AMNEZIAWG_EU1_INTERFACE и доступ по SSH к eu1.

- [x] **Поддержка Android** — 2026-02-22
  - [x] Инструкция для пользователей: docs/client-instructions-android.md (WireGuard для России, AmneziaVPN/AmneziaWG для Европы).
  - [x] Короткий текст для бота: docs/bot-instruction-texts/instruction_android_short.txt.
  - [x] Бот: /instruction и /start охватывают ПК, iPhone/iPad и Android; после выдачи конфига (в т.ч. AmneziaWG) упоминается Android; fallback-инструкция AmneziaWG дополнена шагом для Android.

- [ ] **Анализ конкурентов** (оценка — позже)
  - [ ] Протестировать ботов: @Vpn_Save_Bot, @space_connect_bot, @barinvpn_bot, @servers_space_bot, @hitvpnbot, @flexiblevpn_bot.
  - [ ] Заполнить чеклист и раздел «Что взять» в docs/competitors-analysis.md.
  - [ ] Внедрить приоритетные улучшения в бот и панель (по результатам анализа).

- [x] **Изучение альтернатив** — 2026-02-20
  - [x] Создан документ `docs/vless-alternative.md` — изучение VLESS как альтернативы WireGuard
  - [x] Сравнение VLESS с WireGuard по различным параметрам
  - [x] Рекомендации по использованию VLESS в проекте

- [x] **Улучшение совместимости сервисов** — 2026-02-20
  - [x] Создана спецификация `spec-04-unified-profile-all-services.md` с вариантами решения единого профиля для всех сервисов
  - [x] Исследованы варианты: умная маршрутизация через DNS, улучшенный Shadowsocks, V2Ray/Xray, гибридное решение
  - [x] Рекомендован вариант 4 (гибридный): WireGuard + Smart DNS + Shadowsocks
  - [x] Улучшены DNS настройки: Cloudflare (1.1.1.1) + Google (8.8.8.8) как резервный
  - [x] Создан документ `optimization-multiple-devices.md` с рекомендациями
  - [ ] **Задача**: Реализовать единый VPN‑профиль, обеспечивающий одновременную работу:
    - [ ] YouTube (видео, без блокировок);
    - [ ] ChatGPT (обход блокировок);
    - [ ] Telegram (работа через VPN, без необходимости отдельного MTProto‑прокси);
    - [ ] Обычные сайты (без ограничений).
  - [ ] **Цель**: Сделать так, чтобы **одной кнопкой** можно было подключиться ко всем сервисам (как у крупных VPN провайдеров)
  - [ ] **Реализация** (следующий этап):
    - [ ] Настроить DNS-сервер на VPN-сервере (dnsmasq)
    - [ ] Создать список доменов для Shadowsocks (ChatGPT и др.)
    - [ ] Настроить iptables правила для маршрутизации по доменам
    - [ ] Обновить клиентские конфиги с DNS настройками
    - [ ] Обновить бота для поддержки универсального профиля
  - [ ] **Приоритет**: Высокий (ключевая задача для улучшения UX и достижения MVP).
  - [ ] **Важно**: Проблема с несколькими устройствами решается через единый профиль, не через использование разных серверов (избегать "плодить сущности").

- [ ] **Обход блокировок РКН (eu1 и устойчивость)** — приоритет: высокий
  - [x] Задокументировать стратегию и варианты (docs/blocking-bypass-strategy.md) — 2026-02-21.
  - [x] Пошаговый план (docs/step-by-step-plan-bypass.md) — от него отталкиваемся — 2026-02-21.
  - [x] **Выбрано: A (AmneziaWG)** — один клиент AmneziaVPN на ПК и iOS/iPadOS, обфускация, при блокировке можно добавить Xray в том же приложении (docs/blocking-bypass-strategy.md, docs/step-by-step-plan-bypass.md).
  - [x] Развернуть AmneziaWG на eu1 по инструкции (docs/amneziawg-deploy-instruction.md) — выполнено, подключение из России работает.
  - [x] Тест с iPhone/iPad (конфиг через «Поделиться» → AmneziaWG) — работает.
  - [x] Инструкция для пользователей: docs/client-instructions-amneziawg.md (импорт через «Поделиться» на iOS).
  - [x] **Доработать бота:** обновить инструкции в Telegram-боте — выдавать инструкцию по AmneziaWG (ПК + iOS через «Поделиться»), при возможности — выдавать конфиг/ссылку Amnezia — 2026-02-21.
    - [x] Для Европы (eu1) бот больше не выдаёт WireGuard конфиги; выдаётся инструкция AmneziaWG и при настройке скрипта на eu1 — готовый AmneziaWG .conf.
    - [x] Добавлены спек spec-05-bot-amneziawg-eu1.md, пример скрипта amneziawg-add-client.sh.example, проверка на eu1 (amneziawg-eu1-discovery.md).
    - [x] Автоматизация: добавлены скрипты add-client и remove-client (docs/scripts), поддержка /regen для AmneziaWG в боте; пошаговая настройка — docs/amneziawg-bot-automation-setup.md. Развернуть скрипты на eu1 и задать переменные на Timeweb по этой инструкции.
  - **Цель:** поставить VPN на рельсы — стабильная работа из РФ. РКН: быть начеку, перестройка по документации — без сложностей (см. раздел «РКН: быть начеку» выше).

## 3. Среднесрочные цели (MVP 0.3–0.4)

- [x] **Telegram‑proxy (MTProto)**
  - [x] Выбрать и установить MTProto‑сервер на Fornex (Docker‑контейнер `telegrammessenger/proxy`).
  - [x] Настроить автозапуск через `--restart=always` в Docker.
  - [x] Сформировать и задокументировать ссылку подключения `tg://proxy?...` для друзей.
  - [x] Протестировать подключение на iOS/Android клиентах (владелец и друг).
  - [x] Описать сценарии использования в документации.

- [ ] **Второй/резервный сервер** — отложено (без монетизации второй VPS по деньгам не планируется)
  - [ ] Когда будет монетизация — поднять дополнительный сервер (EU или др.) с AmneziaWG/WireGuard + Shadowsocks.
  - [ ] Описать стратегию переключения и процедуру миграции клиентов.

- [ ] **Автоматизация через бота (инструкции и интеграция)**
  - [x] Описать интеграцию с Telegram‑ботом: инструкции, MTProto, опция VPN+GPT (docs/specs/spec-03-bot-integration-instructions.md).
  - [x] Подготовить короткие тексты инструкций для бота (docs/bot-instruction-texts/): ПК, iOS, MTProto.
  - [x] Добавить пример скрипта добавления редиректа на сервере (docs/scripts/add-ss-redirect.sh.example).
  - [x] В боте: выдавать пошаговую инструкцию после /get_config и/или по команде /instruction (ПК / iOS).
  - [x] В боте: команда /proxy — отправка MTPROTO_PROXY_LINK и краткой инструкции.
  - [x] В боте (eu1): опция «VPN+GPT» при выдаче конфига — создание peer с IP из пула 10.1.0.8–254, вызов add-ss-redirect.sh на сервере по SSH.
  - [ ] На сервере eu1: развернуть add-ss-redirect.sh (см. docs/deployment.md), проверить вызов по SSH из бота.

## 4. Долгосрочные идеи

- [x] Логи и мониторинг:
  - [x] Базовый мониторинг доступности серверов и сервисов (WireGuard, Shadowsocks, MTProto) — веб-панель создана.
  - [x] Ненавязчивая статистика нагрузки (без логирования персональных данных) — реализовано в веб-панели.
  - [ ] Улучшение веб-панели: графики нагрузки, история подключений, алерты при проблемах.
- [ ] Поддержка платных тарифов / лимитов (скорость, количество устройств).
- [ ] Масштабирование до нескольких сотен пользователей (структура подсетей, управление ключами).
- [ ] Интеграция с платежными системами для автоматической оплаты подписок.
- [ ] Мобильное приложение для управления VPN (опционально).

## 5. Правила обновления ROADMAP

- При **выполнении задачи**:
  - переносить короткое описание выполненного шага в `DONE_LIST_VPN.md` с датой;
  - здесь помечать задачу как `[x]`.
- При появлении новых идей:
  - добавлять их в разделы «Ближайшие» или «Среднесрочные» в виде задач, а не реализовывать сразу.

# ROADMAP_VPN

## РКН: быть начеку и легко перестраиваться

**Важно:** Роскомнадзор может блокировать или ломать VPN. Нужно **постоянно быть готовыми** к тому, что текущая схема перестанет работать, и **перестройка не должна быть сложной**.

- **Документировать** все шаги развёртывания и смены протокола/сервера (чтобы повторить или изменить за минуты/часы, а не дни).
- **Один клиент для пользователя** (AmneziaVPN): при смене протокола или ноды мы меняем конфиг/сервер на своей стороне; пользователь по-прежнему открывает одно приложение и подключается.
- **Резервный вариант в той же экосистеме:** если AmneziaWG начнут резать — в том же приложении Amnezia можно добавить протокол Xray (VLESS/Reality) и выдать новый конфиг; приложение менять не нужно.
- **При необходимости** — смена домена, смена провайдера VPS, развёртывание того же стека на новой ноде по готовой инструкции.

---

## Цели проекта

- Создать собственный VPN/Proxy сервис с упором на:
  - высокую скорость и адекватный пинг;
  - простоту подключения на Windows и iOS;
  - лёгкое восстановление при сбоях;
  - удобное управление через Telegram-бота.
- Сначала использовать для себя, друзей и коллег, затем при необходимости масштабировать до коммерческого продукта.

## Этапы развития

### Этап 0 — Подготовка

- [x] Определить название репозитория на GitHub: **`vpnservice`** (nikkronos/vpnservice).
- [x] Инициализировать отдельный Git-репозиторий в папке `VPN/` и привязать к GitHub.
- [x] Уточнить целевые регионы/провайдеров VPS:
  - **Первая нода:** существующий Timeweb-сервер (для тестирования и экономии средств);
  - **В дальнейшем:** отдельный VPS под VPN (когда будет готово и протестировано).

### Этап 1 — MVP для себя

- [x] Развернуть первую WireGuard-ноду (VPS-сервер — существующий Timeweb).
- [x] Настроить базовую конфигурацию WireGuard.
- [x] Сгенерировать конфиг/QR для владельца и протестировать:
  - [x] Windows-клиент WireGuard;
  - [x] iOS-клиент WireGuard (QR-код через qrencode).
- [x] Зафиксировать минимальные требования к скорости и пингу:
  - пинг ~10–15 мс, скорость ~91 Мбит/с вниз / ~88 Мбит/с вверх (тест на Windows).

### Этап 2 — Telegram-бот (self-service)

- [x] Создать Telegram-бота по аналогии с существующими VPN-сервисами (`@hitvpnbot`, `@barinvpn_bot`, `@avoVPN_bot`).
- [x] Реализовать команды:
  - [x] `/start` и базовая авторизация;
  - [x] `/get_config` — выдача конфигурации (через персональный `.conf`);
  - [x] `/regen` — регенерация ключа/конфига (удаление старого peer, создание нового с новыми ключами);
  - [x] `/status` — базовый статус доступа.
- [x] Связать бота с backend-логикой, управляющей WireGuard (создание peers и генерация конфигов через локальные утилиты `wg`).
- [x] Добавить поддержку нескольких пользователей (друзья, коллеги) через команды `/add_user` и `/users` (без срока окончания доступа на текущем этапе).

### Этап 3 — Надёжность и масштабирование до десятков пользователей

- [x] Добавить ещё 1–2 VPN-ноды (разные регионы/провайдеры): развёрнута нода **eu1** (Fornex, Германия, 185.21.8.91), бот создаёт пиры на eu1 по SSH.
- [x] Реализовать выбор сервера в боте (основной/запасной или список регионов) — команда `/server` с inline-кнопками для выбора между РФ и EU.
- [ ] **Проблема eu1 (Fornex):** WireGuard UDP не работает для клиентов из России. Сервер сохраняем. **Решение — AmneziaWG** (развёртывание по docs/amneziawg-deploy-instruction.md). Резерв: в том же приложении Amnezia добавить Xray (docs/blocking-bypass-strategy.md). Доп. обходы: docs/eu1-workarounds-fornex.md.
- [ ] Настроить health-check:
  - [ ] мониторинг доступности нод (ping, CPU, нагрузка);
  - [ ] уведомления в отдельный тех-бот/канал при падении ноды.
- [ ] Подготовить инструкции:
  - [ ] «Как восстановить ноду за N минут»;
  - [ ] «Как перевести пользователей на другую ноду».
#### Вопросы инфраструктуры и нагрузки

- [x] Уточнены лимиты трафика у провайдера Timeweb: **базовых ограничений по трафику нет**, главное — соблюдение правил платформы (запрет незаконного контента, DDoS, спама и т.п.).
- [ ] Оценить типичный сценарий использования (сколько людей, сколько одновременно активно пользуются).
- [ ] Оценить примерный месячный трафик на одного активного пользователя (мессенджеры, видео, игры).
- [ ] Сопоставить ожидаемую суммарную нагрузку с тарифами провайдеров VPS (скорость канала, CPU/RAM при высокой нагрузке).
- [ ] Определить порог, после которого требуется выносить VPN на отдельный сервер (или добавлять вторую ноду).
- [ ] Зафиксировать стратегию масштабирования: какие планы по увеличению канала/количества нод при росте числа пользователей.

### Этап 4 — Коммерциализация (опционально)

- [ ] Спроектировать тарифы (лимиты по времени/трафику/устройствам).
- [ ] Выбрать платёжное решение (Telegram Payments, внешние провайдеры и т.п.).
- [ ] Реализовать:
  - [ ] напоминания о продлении;
  - [ ] автоматическое продление по оплате;
  - [ ] базовую аналитику (активные подписки, нагрузка на сервера).

## Ссылки и контекст

- **Обход блокировок РКН:** `docs/blocking-bypass-strategy.md` — стратегия, варианты A/B/C/D, совет по провайдерам и доменам.
- **Пошаговый план (от него отталкиваемся):** `docs/step-by-step-plan-bypass.md` — от выбора варианта до рабочего VPN и инструкций.
- Общий AI roadmap: `ROAD_MAP_AI.md` (раздел про VPN/Proxy сервис).
- Общие правила и паттерны: `RULES_CURSOR.md`, `docs/AGENT_PROMPTS.md`, `docs/patterns.md`.

