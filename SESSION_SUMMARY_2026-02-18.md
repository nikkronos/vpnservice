# Резюме сессии 2026-02-18 — VPN/Proxy

## Контекст работы

- Цель сессии — привести в порядок личный VPN/Proxy‑сервис с учётом блокировок (в т.ч. ChatGPT и потенциальной блокировки Telegram), а также сделать его удобным для владельца и друга.
- Исходное состояние:
  - Рабочий WireGuard‑сервер на Fornex, которым пользуются несколько человек через профили, выданные Telegram‑ботом.
  - Отдельный Shadowsocks‑сервер `185.21.8.91:8388`, через который ChatGPT работает, но через один только WireGuard — нет.
  - На ПК владельца связка WireGuard + Shadowsocks уже использовалась вручную.
- Задача — сделать так, чтобы:
  - на iPhone владельца и устройствах друга работал GPT через один VPN‑профиль (без параллельного V2RayTun);
  - при этом сохранить обычные VPN‑профили от бота для повседневного использования;
  - зафиксировать архитектуру и текущее состояние в документации.

## Выполненные задачи в этой сессии

1. **Shadowsocks‑клиент на VPN‑сервере**
   - Установлен `shadowsocks-libev` на Fornex‑сервер (Ubuntu 24.04).
   - Создан конфиг `/etc/shadowsocks-libev/ss-wg.json` с параметрами Shadowsocks‑сервера `185.21.8.91:8388` (`aes-256-gcm`, общий пароль с Windows‑клиентом).
   - Запущен `ss-redir` как systemd‑сервис `ss-wg.service` (автозапуск, порт `127.0.0.1:1081`).
   - Проверено подключение через `curl https://chat.openai.com` (получен ответ от Cloudflare).

2. **Интеграция WireGuard + Shadowsocks**
   - В `wg0.conf` добавлены новые `Peer` для:
     - iPhone владельца (`10.1.0.4/32`);
     - ПК друга (`10.1.0.5/32`);
     - iPhone друга (`10.1.0.6/32`);
     - iPad друга (`10.1.0.7/32`).
   - Настроены iptables:
     - изначально редирект HTTP/HTTPS на `127.0.0.1:1081` делался для всей подсети `10.1.0.0/24`, затем сузили до точечных адресов клиентов (`/32`), чтобы не ломать остальной трафик;
     - добавлены правила FORWARD для интерфейса `wg0`.
   - Созданы клиентские конфиги:
     - `iphone.conf` (владелец);
     - `friend-pc.conf`, `friend-iphone.conf`, `friend-ipad.conf`.
   - Проверено:
     - на iPhone владельца профиль `iphone` успешно подключается;
     - ChatGPT работает через один WireGuard‑туннель (без V2RayTun);
     - обычные сайты ведут себя так же, как через IP Shadowsocks‑сервера (в т.ч. учитываются существующие блокировки/ограничения).

3. **Клиенты владельца и друга**
   - Зафиксирована схема профилей:
     - Владелец:
       - ПК: `client1` (от бота) + Shadowsocks‑клиент.
       - iPhone: `client1` (от бота) — обычный VPN; `iphone` — VPN+Shadowsocks (GPT).
     - Друг:
       - ПК/iPhone/iPad: по два профиля — от бота (обычный VPN) и наши (`friend-pc`, `friend-iphone`, `friend-ipad`) для VPN+Shadowsocks.
   - Конфиги друга подготовлены и отправлены; считается, что он успешно подключит профили (допущение зафиксировано).

4. **Резервное копирование**
   - Создана папка бэкапов `/root/vpn-backups/2026-02-18/`.
   - Скопированы:
     - `/etc/wireguard/wg0.conf`;
     - `/etc/wireguard/iphone.conf`;
     - `/etc/shadowsocks-libev/ss-wg.json`.

5. **Документация**
   - В `Projects/VPN/` создана структура и заполнены файлы:
     - `README_FOR_NEXT_AGENT.md` — краткое описание проекта, текущей архитектуры и профилей.
     - `ROADMAP_VPN.md` — roadmap с текущим состоянием (MVP 0.1), ближайшими и среднесрочными задачами (спеки, Telegram‑proxy, второй сервер, автоматизация через бота).
     - `DONE_LIST_VPN.md` — зафиксированы изменения этой сессии.

## Важные изменения в конфигурации

- **WireGuard**
  - В `wg0.conf` добавлены новые `Peer` и включены точечные `AllowedIPs` (`10.1.0.4/32`, `10.1.0.5/32`, `10.1.0.6/32`, `10.1.0.7/32`).
  - Адреса клиентов:
    - Владелец iPhone: `10.1.0.4/32`.
    - Друг PC: `10.1.0.5/32`.
    - Друг iPhone: `10.1.0.6/32`.
    - Друг iPad: `10.1.0.7/32`.
  - Для этих адресов трафик HTTP/HTTPS на сервере идёт через `ss-redir`.

- **Shadowsocks**
  - Настроен клиентский конфиг `/etc/shadowsocks-libev/ss-wg.json`.
  - Сервис `ss-wg.service` добавлен в systemd и запускается автоматически.

- **iptables**
  - Добавлены правила в таблицу `nat` (`PREROUTING`) для редиректа TCP 80/443 от указанных IP на локальный порт `1081`.
  - Добавлены правила `FORWARD` для интерфейса `wg0`.

## Критические правила для следующего агента

1. **Не менять выданные адреса клиентов** (`10.1.0.4`, `10.1.0.5`, `10.1.0.6`, `10.1.0.7`), чтобы не сломать существующие профили владельца и друга.
2. **Перед изменениями на сервере**:
   - сделать новый бэкап в `/root/vpn-backups/YYYY-MM-DD/`;
   - проверить статус `ss-wg.service` и работу `ss-redir`.
3. **Не коммитить реальные пароли и ключи** в репозитории — все секреты должны оставаться только на сервере/в локальных файлах окружения.
4. При добавлении новых клиентов или серверов:
   - сначала обновить `ROADMAP_VPN.md` и/или спецификации в `docs/specs/`;
   - только затем менять конфиги на сервере.

