# Резюме сессии 2026-02-22 — VPN

## Контекст работы

- VPN на eu1 (Fornex): на ПК работал через AmneziaWG; на телефоне и у друзей — подключение было, интернета не было. Россия (main) без проблем.
- Задача: «чистый сброс» только на eu1 — остановить и убрать конфиги AmneziaWG (и старый WireGuard wg0), оставить MTProto и Shadowsocks, затем проверить работу через AmneziaVPN с ПК и телефона.

## Выполненные задачи в этой сессии

1. **План и команды**
   - Создан `docs/eu1-clean-slate-plan.md` — что оставляем (MTProto, Shadowsocks), что сбрасываем (AmneziaWG), фазы 1–5.
   - Создан `docs/eu1-clean-slate-commands.md` — команды для копирования (бэкапы, остановка, установка с ПК, при необходимости — Фаза 4).
   - В `README_FOR_NEXT_AGENT.md` добавлен блок про план чистого сброса eu1 и ссылка на документы.

2. **Чистый сброс на eu1 (Fornex)**
   - **Фаза 1:** бэкап на eu1: `/root/eu1-backup-20260222` (wireguard, amnezia, iptables-save, ss-tulnp, wg-services).
   - **Фаза 2:** остановлены и отключены `awg-quick@awg0` и `wg-quick@wg0`; конфиг AmneziaWG (`awg0.conf`) перенесён в бэкап; копия `/etc/amnezia` в бэкап. В `/etc/wireguard/` остались wg0.conf и старые клиентские конфиги (не трогали). MTProto (Docker, порт 443) и контейнер amnezia-awg2 (порт 48100) не останавливали.
   - **Фаза 3:** сервер уже был в AmneziaVPN; повторно не добавляли. Выполнен экспорт для iOS (Поделиться VPN → формат для iOS). Импорт на телефон — подключение и интернет работают. На ПК включён VPN — интернет работает.

3. **Итог**
   - ПК и телефон (iOS) работают через AmneziaWG на eu1. Чистый сброс завершён успешно. При необходимости выдачи конфигов друзьям — экспорт через «Поделиться VPN» в AmneziaVPN или настройка бота по `docs/amneziawg-bot-automation-setup.md`.

4. **Бот: выдача конфигов AmneziaWG (Docker)**
   - На eu1 развёрнуты скрипты `amneziawg-add-client-docker.sh` и `amneziawg-remove-client-docker.sh` (контейнер `amnezia-awg2`, порт 48100). На Timeweb в env заданы `AMNEZIAWG_EU1_ADD_CLIENT_SCRIPT` и `AMNEZIAWG_EU1_REMOVE_CLIENT_SCRIPT` (пути к *-docker.sh). Бот по /get_config и /regen для «Европа» выдаёт .conf.
   - Конфиг сервера в контейнере: `/opt/amnezia/awg/awg0.conf`. В скрипт добавлено извлечение параметров обфускации (Jc, Jmin, Jmax, S1–S4, H1–H4) из этого файла и подстановка в клиентский конфиг — без них клиент не подключался (таймаут). После обновления скрипта конфиги от бота содержат эти параметры.
   - На eu1 добавлено правило iptables: `iptables -I INPUT -p udp --dport 48100 -j ACCEPT` (ufw не установлен).

5. **Текущее состояние (пауза, без доработок)**
   - **ПК:** VPN через AmneziaWG на eu1 работает (подключение и интернет).
   - **Телефон (конфиг от бота):** подключение устанавливается (handshake есть, «Последнее рукопожатие 10 с назад»), но трафик почти не идёт (получено 368 B, отправлено ~144 KiB) — сайты не грузятся. Владелец предполагает блокировку по аналогии с прошлым опытом по WireGuard; дополнительные исправления пока не вносим.
   - **Вопрос на обдумывание:** почему нельзя просто дублировать логику того, что работает на ПК, на телефон? На ПК работает конфиг, созданный/экспортированный **приложением AmneziaVPN** («Поделиться VPN»). На телефон ранее дублировали именно этот экспорт из приложения — и тогда работало. Конфиг от бота генерируется нашим скриптом (ключи + копирование Jc, Jmin, Jmax, S1–S4, H1–H4 из серверного конфига). Возможные отличия: (1) формат или дополнительные поля в экспорте приложения (например, I1 и др.), которые мы не воспроизводим; (2) сетевая разница (ПК и телефон в разных сетях). Дальше: зафиксировать, при необходимости сравнить экспорт из приложения с выводом нашего скрипта или снова выдать телефону конфиг через «Поделиться VPN» и проверить — без новых правок кода.

## Важные замечания для следующего агента

- **eu1:** AmneziaWG обслуживается контейнером Docker `amnezia-awg2` (порт 48100). Сервисы `awg-quick@awg0` и `wg-quick@wg0` отключены; конфиги awg0 и копия amnezia — в `/root/eu1-backup-20260222`. Конфиг в контейнере: `/opt/amnezia/awg/awg0.conf`.
- **Выдача конфигов:** бот выдаёт AmneziaWG .conf через скрипты `amneziawg-add-client-docker.sh` и `amneziawg-remove-client-docker.sh` на eu1 (раздел «Вариант: AmneziaWG в Docker» в `docs/amneziawg-bot-automation-setup.md`). В конфиг подставляются параметры обфускации из серверного awg0.conf.
- **Проблема на телефоне:** конфиг от бота — handshake есть, трафик не грузится. Не чинить дальше без решения: документировано, пауза. Идея: сравнить с экспортом из приложения «Поделиться VPN» или повторить выдачу через приложение.
- **Варианты дальнейших действий:** описаны в `docs/eu1-phone-config-open-question.md` (раздел «Варианты дальнейших действий») — 6 вариантов для следующего агента. Владелец раздал другу конфиг через «Поделиться VPN» для проверки позже.
- **План и команды на будущее:** `docs/eu1-clean-slate-plan.md`, `docs/eu1-clean-slate-commands.md`.
