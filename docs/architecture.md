# Архитектура проекта VPN (черновик)

## Цели архитектуры

- Обеспечить:
  - высокую скорость и низкий пинг;
  - простое подключение для конечного пользователя (Windows, iOS);
  - предсказуемое поведение и лёгкое восстановление при сбоях;
  - масштабирование от единиц пользователей до десятков и выше.

## Общая схема (уровни)

1. **Клиенты (Users)**
   - Устройства пользователей:
     - Windows (официальный клиент WireGuard).
     - iOS (официальный клиент WireGuard).
   - Пользователь получает конфиг/QR через Telegram-бота и импортирует его в клиент.

2. **Control Plane (управляющая плоскость)**
   - Backend-сервис VPN-проекта:
     - хранит информацию о пользователях и их доступах;
     - управляет конфигурацией WireGuard-пиров (создание, обновление, отзыв);
     - предоставляет API для Telegram-бота.
   - Telegram-бот:
     - интерфейс для пользователя (команды: `/start`, `/get_config`, `/regen`, `/status`, и т.п.);
     - общается с backend’ом по HTTP/API.

3. **Data Plane (плоскость трафика)**
   - Один или несколько VPS-серверов с развернутым WireGuard:
     - каждый сервер — отдельная нода;
     - на ноде настроены интерфейсы WireGuard и список пиров (пользователей).
   - Трафик пользователей шифруется и идёт через эти ноды.

## Компоненты подробнее

### 1. Telegram-бот

- Основные функции:
  - авторизация пользователя (по инвайт-коду/ID, списку разрешённых и т.д.);
  - выдача конфигураций и QR-кодов;
  - показ статуса доступа (активен/истёк, дата окончания);
  - управление (регенерация ключа, выбор сервера/региона).
- Технически:
  - реализуется на Python (aiogram/pyTelegramBotAPI, по аналогии с существующими ботами);
  - не напрямую лезет в WireGuard — всё через backend API.

### 2. Backend VPN

- Отвечает за:
  - логику пользователей и подписок;
  - управление peers на WireGuard-нодах (создание/удаление/обновление);
  - генерацию конфигов и QR-кодов;
  - мониторинг состояния нод (health-check).
- Возможная реализация:
  - Python (FastAPI/Flask) или лёгкий сервис со скриптами и CLI-вызовами WireGuard;
  - хранение данных в SQLite/PostgreSQL (зависит от масштаба).

### 3. WireGuard-ноды

- Каждая нода:
  - поднята на отдельном VPS;
  - имеет:
    - конфигурацию WireGuard (серверный ключ, порт, список пиров);
    - systemd-сервис для автозапуска и перезапуска;
    - скрипты/утилиты для быстрой реконфигурации.
- Связь с backend’ом:
  - через SSH/CLI или через отдельный агент/службу на ноде (по API/HTTP).

## Масштабирование и надёжность

- На уровне MVP:
  - одна нода WireGuard;
  - ручное переключение/восстановление по инструкциям.
- На следующем этапе:
  - несколько нод в разных регионах;
  - выбор ноды пользователем в боте;
  - health-check и уведомления:
    - ping до ноды;
    - мониторинг загрузки;
    - алерты в отдельный тех-бот/канал.

## Связь с документацией

- Подробный план задач см. в `ROADMAP_VPN.md`.
- История принятия решений и контекст — в `SESSION_SUMMARY_YYYY-MM-DD.md` и `DONE_LIST_VPN.md`.
- Дополнительные правила и общие паттерны — в `RULES_CURSOR.md`, `docs/AGENT_PROMPTS.md`, `docs/patterns.md`, `docs/security.md` (из корня).

