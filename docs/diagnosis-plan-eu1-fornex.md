# План диагностики проблемы eu1 (Fornex)

## Текущая ситуация

**Проблема:** eu1 (Fornex, 185.21.8.91) работает плохо из России:
- GPT открывается (Shadowsocks работает частично)
- Instagram открывается, но грузится медленно
- Всё остальное не открывается
- И VPN+GPT, и Unified профили работают одинаково плохо

**Что уже известно:**
- WireGuard UDP (51820) не работает из России (пакеты не доходят до сервера)
- Shadowsocks (ss-redir на 127.0.0.1:1081) настроен и работает частично
- Fornex подтвердил: с их стороны ограничений нет
- Уже пробовали: исправления пира, iptables FORWARD, rp_filter, tcpdump
- **КРИТИЧНО:** Когда клиент включает VPN, SSH-соединение с сервером обрывается (весь трафик идёт через VPN, но VPN не работает)
- WireGuard handshake проходит (13 секунд назад), есть transfer (268 Б получено, 15.55 КБ отправлено), но ping 10.1.0.1 не проходит (100% потерь)
- TCP до Fornex работает (ping 185.21.8.91 проходит, порт 8388 открыт)
- UDP до Fornex не работает (WireGuard не проходит)

## План диагностики (по приоритету)

### Этап 1: Диагностика текущего состояния (15-20 минут)

**Цель:** Понять, что именно не работает и где проблема.

#### 1.1 Проверка Shadowsocks сервера (внешний сервер, к которому подключается ss-redir)

**Вопрос:** К какому внешнему Shadowsocks серверу подключается ss-redir на eu1?

**Действия:**
- [ ] Проверить конфиг `/etc/shadowsocks-libev/ss-wg.json` на eu1
- [ ] Узнать IP и порт внешнего Shadowsocks сервера
- [ ] Проверить доступность этого сервера из России напрямую (без WireGuard)
- [ ] Проверить скорость/качество подключения к этому серверу

**Ожидаемый результат:** Если внешний Shadowsocks сервер сам работает плохо из России — это объясняет проблему.

#### 1.2 Проверка маршрутизации до eu1

**Действия:**
- [ ] С клиента из России: `traceroute 185.21.8.91`
- [ ] С клиента из России: `mtr 185.21.8.91` (10-20 пакетов)
- [ ] Проверить, где теряются пакеты (на каком хопе)
- [ ] Проверить ping до 185.21.8.91 (ICMP может работать, когда UDP не работает)

**Ожидаемый результат:** Понять, на каком участке маршрута блокируется/теряется трафик.

#### 1.3 Проверка работы WireGuard туннеля

**Действия:**
- [ ] На eu1: `wg show` — проверить статистику (received/sent)
- [ ] На клиенте: проверить, есть ли handshake в WireGuard
- [ ] На клиенте: `ping 10.1.0.1` (внутри VPN-сети)
- [ ] На клиенте: `curl -v http://10.1.0.1` (если есть веб-сервер на сервере)

**Ожидаемый результат:** Понять, работает ли WireGuard туннель вообще или полностью не работает.

#### 1.4 Проверка работы ss-redir на eu1

**Действия:**
- [ ] На eu1: `systemctl status shadowsocks-libev-local@ss-wg.service`
- [ ] На eu1: `ss -tlnp | grep 1081` — слушается ли порт
- [ ] На eu1: `journalctl -u shadowsocks-libev-local@ss-wg.service -n 50` — логи
- [ ] На eu1: `curl -v --socks5 127.0.0.1:1081 http://httpbin.org/ip` — работает ли ss-redir локально

**Ожидаемый результат:** Убедиться, что ss-redir работает и может подключаться к внешнему серверу.

#### 1.5 Проверка DNS (клиент и сервер)

**Вопрос:** Резолвятся ли домены и через какой DNS идёт трафик?

**На клиенте (под VPN):**
- [ ] `nslookup chat.openai.com` — резолвится ли домен
- [ ] `nslookup google.com` — резолвится ли обычный домен
- [ ] Узнать, какой DNS используется в конфиге WireGuard (1.1.1.1, 8.8.8.8 и т.п.)
- [ ] При необходимости: `dig chat.openai.com @1.1.1.1` — проверить резолв через конкретный DNS

**На eu1:**
- [ ] `getent ahosts chat.openai.com` — резолв с сервера
- [ ] `getent ahosts google.com` — резолв обычного домена

**Ожидаемый результат:** Если DNS не резолвится или резолвит неправильно — сайты не откроются даже при рабочем туннеле.

#### 1.6 Проверка MTU (размер пакетов)

**Вопрос:** Не теряются ли большие пакеты из‑за MTU?

**На клиенте (под VPN):**
- [ ] Проверить, задан ли MTU в конфиге WireGuard (например `MTU = 1280`)
- [ ] `ping -s 1400 10.1.0.1` — пинг большим пакетом внутри VPN
- [ ] `ping -s 1280 10.1.0.1` — пинг с меньшим размером
- [ ] Сравнить: если 1400 не проходит, а 1280 проходит — возможно, нужно снизить MTU в конфиге

**На eu1:**
- [ ] `ip link show wg0` — посмотреть MTU интерфейса wg0
- [ ] При необходимости: снизить MTU на wg0 или в клиентском конфиге (1280 или 1200)

**Ожидаемый результат:** Если большие пакеты не доходят — снижение MTU может улучшить стабильность (особенно на проблемных маршрутах).

### Этап 2: Определение корневой причины (10-15 минут)

**Цель:** Понять, в чём именно проблема.

#### 2.1 Анализ результатов этапа 1

**Вопросы:**
- [ ] Если внешний Shadowsocks сервер недоступен/медленный из России → проблема в сервере Shadowsocks, не в Fornex
- [ ] Если маршрутизация до 185.21.8.91 теряется на российском провайдере → проблема в блокировке/маршрутизации на уровне РФ
- [ ] Если WireGuard туннель не работает вообще → проблема в UDP блокировке (уже известно)
- [ ] Если ss-redir не работает локально → проблема в конфигурации Shadowsocks на eu1
- [ ] Если DNS не резолвится или резолвит неправильно → проблема в DNS (см. вариант D)
- [ ] Если большие пакеты не проходят, а маленькие — да → попробовать снизить MTU (см. вариант E)

#### 2.2 Тест: Shadowsocks напрямую (без WireGuard)

**Действия:**
- [ ] На клиенте из России: подключиться к внешнему Shadowsocks серверу напрямую (без WireGuard)
- [ ] Проверить скорость и доступность сайтов через прямой Shadowsocks

**Ожидаемый результат:** Если прямой Shadowsocks работает хорошо, а через WireGuard+ss-redir плохо → проблема в WireGuard туннеле или маршрутизации внутри VPN.

### Этап 3: Решения (в зависимости от результатов диагностики)

#### Вариант A: Проблема во внешнем Shadowsocks сервере

**Решение:** Найти другой Shadowsocks сервер или настроить свой.

**Действия:**
- [ ] Найти альтернативный Shadowsocks сервер (другой IP/провайдер)
- [ ] Обновить конфиг `/etc/shadowsocks-libev/ss-wg.json` на eu1
- [ ] Перезапустить ss-redir
- [ ] Протестировать

#### Вариант B: Проблема в маршрутизации до Fornex (UDP блокируется)

**Решение:** Использовать обходные пути для WireGuard.

**Варианты:**
1. **WireGuard через TCP (Cloudflared Tunnel)**
   - Плюсы: Cloudflare имеет хорошую доступность из России
   - Минусы: Требует настройки Cloudflared на клиенте и сервере
   - Сложность: Средняя

2. **Обфускация UDP (udp2raw или phantun)**
   - Плюсы: Сохраняет WireGuard, но обфусцирует UDP в TCP
   - Минусы: Требует дополнительного софта на клиенте
   - Сложность: Средняя-высокая

3. **Миграция на другой провайдер/ASN**
   - Плюсы: Решает проблему на корневом уровне
   - Минусы: Требует нового сервера и миграции
   - Сложность: Средняя (но требует времени и денег)

#### Вариант C: Проблема в конфигурации ss-redir

**Решение:** Исправить конфигурацию Shadowsocks.

**Действия:**
- [ ] Проверить метод шифрования, пароль, сервер
- [ ] Проверить логи ss-redir на ошибки
- [ ] Возможно, пересоздать конфиг

#### Вариант D: Проблема в DNS

**Решение:** Использовать надёжный DNS в клиентском конфиге.

**Действия:**
- [ ] В конфиге WireGuard на клиенте: `DNS = 1.1.1.1, 8.8.8.8` (или другой рабочий DNS)
- [ ] Проверить, что DNS не блокируется провайдером
- [ ] При необходимости: использовать DNS-over-HTTPS или другой обход

#### Вариант E: Проблема в MTU (большие пакеты не проходят)

**Решение:** Снизить MTU в клиентском конфиге WireGuard.

**Действия:**
- [ ] В конфиге WireGuard на клиенте добавить: `MTU = 1280` (или 1200, если 1280 не помогает)
- [ ] Перезапустить туннель
- [ ] Протестировать доступность сайтов
- [ ] На eu1 в env бота можно задать `WG_EU1_MTU=1280`, чтобы новые конфиги выдавались с этим MTU

#### Вариант F: Проблема в маршрутизации внутри VPN (после WireGuard)

**Решение:** Проверить и исправить iptables/NAT правила.

**Действия:**
- [ ] Проверить все iptables правила на eu1
- [ ] Проверить NAT и форвардинг
- [ ] Возможно, проблема в том, что трафик не доходит до ss-redir

## Оценка плана

### Плюсы плана:
✅ Не повторяет уже сделанное (не проверяет то, что уже проверяли)  
✅ Систематический подход: от диагностики к решению  
✅ Конкретные команды и действия  
✅ Учитывает разные варианты проблемы  

### Минусы плана:
⚠️ Требует доступа к клиенту из России для тестов  
⚠️ Может потребоваться доступ к внешнему Shadowsocks серверу (если он не наш)  
⚠️ Некоторые решения (миграция, Cloudflared) требуют времени  

### Риски:
- Если внешний Shadowsocks сервер недоступен/медленный — это не проблема Fornex, а проблема сервера Shadowsocks
- Если проблема в блокировке UDP на уровне российского провайдера — обходные пути могут быть сложными
- Миграция на другой провайдер — самое надёжное, но требует времени и денег

## Порядок выполнения (пошагово)

1. **Шаг 1.1** — Проверка внешнего Shadowsocks сервера (конфиг на eu1, доступность из России)
2. **Шаг 1.2** — Проверка маршрутизации до eu1 (traceroute, mtr, ping)
3. **Шаг 1.3** — Проверка WireGuard туннеля (wg show, handshake, ping 10.1.0.1)
4. **Шаг 1.4** — Проверка ss-redir на eu1 (статус, порт 1081, логи, curl через socks5)
5. **Шаг 1.5** — Проверка DNS (nslookup/dig на клиенте, getent на eu1)
6. **Шаг 1.6** — Проверка MTU (ping с разным размером пакета, MTU в конфиге)
7. **Этап 2** — Анализ результатов и выбор варианта решения (A–F)
8. **Этап 3** — Выполнение выбранного варианта

После каждого шага — зафиксировать результат и решить: переходить к следующему шагу или сразу к решению.

## Рекомендации

1. **Начать с шага 1.1** — проверить внешний Shadowsocks сервер (это самое простое и быстрое)
2. **Если внешний сервер работает плохо** — это объясняет проблему, и решение — найти другой сервер
3. **Если внешний сервер работает хорошо** — тогда проблема в маршрутизации/блокировке до Fornex, и нужны обходные пути или миграция
4. **DNS и MTU** — быстрые проверки; если DNS не резолвит или большие пакеты не проходят — можно сразу пробовать варианты D и E

## Следующие шаги

После выполнения шага 1.1 — зафиксировать результат и перейти к шагу 1.2 (или к решению, если причина уже ясна).
