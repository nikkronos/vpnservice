# Открытый вопрос: конфиг от бота на телефоне — handshake есть, трафик не грузится

**Дата:** 2026-02-22. Дополнительные исправления не вносим — документируем и оставляем на обдумывание.

## Факты

- **ПК:** VPN через AmneziaWG на eu1 (контейнер amnezia-awg2, порт 48100) работает — подключение и интернет есть. Конфиг получен/создан через приложение AmneziaVPN (сервер добавлен вручную, «Поделиться VPN» для экспорта).
- **Телефон (конфиг от бота):** тот же сервер, конфиг выдаётся ботом (скрипт amneziawg-add-client-docker.sh на eu1). Подключение устанавливается (handshake, «Последнее рукопожатие 10 с назад»), но трафик почти не идёт (получено ~368 B) — сайты не грузятся.
- Ранее на телефон **дублировали конфиг через экспорт из приложения** («Поделиться VPN» → iOS) — тогда на телефоне всё работало.

## Вопрос

Почему нельзя просто дублировать логику того, что работает на ПК, на телефон?

- На ПК работает конфиг, который создаёт/экспортирует **приложение AmneziaVPN**.
- Конфиг от бота генерируется **нашим скриптом**: ключи (wg genkey) + копирование из серверного `/opt/amnezia/awg/awg0.conf` параметров обфускации (Jc, Jmin, Jmax, S1–S4, H1–H4) в секцию [Interface] клиента.

Возможные причины расхождения:

1. **Формат/поля:** экспорт из приложения может содержать дополнительные поля (например, I1 в виде hex-блока и др.), которые мы не воспроизводим в скрипте. Сравнение экспорта приложения с выводом скрипта — следующий шаг для проверки.
2. **Сеть:** ПК и телефон в разных сетях; на одной трафик до/от 185.21.8.91 может проходить, на другой — блокироваться или резаться (владелец предполагал блокировку по аналогии с WireGuard; просил не углубляться в операторов/провайдеров).

## Что сделать дальше (без правок кода)

- Сравнить конфиг, экспортированный из AmneziaVPN («Поделиться VPN»), с конфигом, который выдаёт скрипт (построчно): какие поля есть только в экспорте приложения?
- Либо снова выдать конфиг на телефон через «Поделиться VPN» с ПК и проверить — если с этим конфигом трафик на телефоне пойдёт, разница именно в формате/содержимом конфига.

---

## Варианты дальнейших действий (для следующего агента)

**Контекст:** На телефоне с конфигом от бота — handshake есть, трафик не грузится. На ПК и при экспорте из приложения «Поделиться VPN» работало. Владелец раздал другу конфиг через «Поделиться VPN» для проверки позже. Ниже варианты, из которых можно выбрать один или комбинировать.

### Вариант 1. Не использовать бота для Европы — только экспорт из приложения

Друзьям и на телефон выдавать конфиг только через AmneziaVPN: «Поделиться VPN» → файл или ссылку отправить вручную. Бот для Европы не использовать или оставить только инструкцию «напиши владельцу, получи конфиг вручную».

**Плюсы:** Тот же формат, что на ПК; раз с телефона работало при экспорте из приложения — высокая вероятность, что и сейчас будет.  
**Минусы:** Нет самообслуживания через бота; владелец раздаёт конфиги вручную.

---

### Вариант 2. Сравнить формат: экспорт приложения vs вывод скрипта

На ПК в AmneziaVPN экспортировать конфиг («Поделиться VPN» → сохранить .conf). Открыть файл и построчно сравнить с конфигом, который выдаёт скрипт (на eu1: `/opt/vpnservice/scripts/amneziawg-add-client-docker.sh 10.1.0.97` → сохранить вывод). Искать отличия: лишние строки в [Interface] (I1, комментарии и т.д.), разный порядок полей, другое написание (PublicKey vs Publickey).

**Плюсы:** Понятно, чего не хватает в нашем конфиге.  
**Минусы:** Нужно время; если разница только в «магии» приложения (бинарный/специфичный формат), скриптом это не всегда повторить.

---

### Вариант 3. Проверить телефон конфигом из приложения

Без правок скрипта: с ПК «Поделиться VPN» → создать конфиг для телефона, импортировать этот .conf на телефон и проверить — есть ли handshake и грузится ли трафик.

**Плюсы:** Быстро проверяет гипотезу «проблема в формате конфига от бота, а не в сети/блокировке». Если с экспортом приложения на том же телефоне и той же сети всё грузится — значит, дело в отличии конфига.  
**Минусы:** Не решает задачу «бот сам выдаёт рабочий конфиг».

---

### Вариант 4. Другой протокол в Amnezia (Xray)

В документации заложен запасной вариант: если AmneziaWG режут, в том же приложении Amnezia на eu1 поднять протокол Xray (VLESS/Reality и т.п.) и раздавать конфиги для него. Бот тогда дорабатывать под выдачу конфигов Xray (или ссылок), а не AmneziaWG.

**Плюсы:** Другой трафик, другой порт; иногда обходит блокировки, которые режут именно AmneziaWG.  
**Минусы:** Нужна настройка на сервере, другие скрипты/логика в боте; пользователям по-прежнему Amnezia, но другой протокол внутри.

---

### Вариант 5. Эталонный конфиг из приложения — шаблон для скрипта

Один раз экспортировать из приложения рабочий конфиг (только [Interface] без приватного ключа: список полей и порядок, включая I1 и прочее). В скрипте на сервере не только подставлять Jc, Jmin, S1–S4, H1–H4, но и воспроизводить структуру/поля из этого эталона (например, добавлять I1 из эталона или пустым, если приложение так делает).

**Плюсы:** Максимально приближает конфиг от бота к тому, что выдаёт приложение.  
**Минусы:** Нужно разобрать эталон; I1 и подобное могут быть привязаны к сессии/клиенту и не подходить для «шаблона».

---

### Вариант 6. Ничего не менять

ПК — как сейчас (приложение + при необходимости «Поделиться VPN»). Телефон/друзья — либо конфиг вручную из приложения, либо через бота с пониманием, что на части сетей/устройств трафик может не пойти. Документация и открытый вопрос зафиксированы.

**Плюсы:** Нет лишних изменений.  
**Минусы:** MVP «бот выдаёт рабочий конфиг всем» не достигнут для сценария «телефон + конфиг от бота».

---

**Рекомендация на следующий шаг:** сначала вариант 3 (проверить телефон конфигом из «Поделиться VPN»). Если с ним трафик пойдёт — осмысленно делать вариант 2 (сравнение формата) и при необходимости вариант 5 (подогнать скрипт под эталон из приложения).

## Связанные документы

- `SESSION_SUMMARY_2026-02-22.md` — контекст сессии и пауза.
- `docs/scripts/amneziawg-add-client-docker.sh.example` — текущий скрипт (обфускация из `/opt/amnezia/awg/awg0.conf`).
- `docs/amneziawg-bot-automation-setup.md` — настройка бота для выдачи конфигов (вариант Docker).
