# Нода eu1 (Европа, Fornex): настройка и отладка

Документ описывает всё, что сделано по развёртыванию и отладке европейской ноды eu1 на Fornex (185.21.8.91), а также текущее состояние и нерешённую проблему.

---

## 1. Цель

- **main** — Timeweb (РФ), 81.200.146.32, подсеть 10.0.0.0/24.
- **eu1** — Fornex (Германия), 185.21.8.91, подсеть 10.1.0.0/24; пиры добавляются по SSH с Timeweb.

При выборе «Европа» в боте и `/get_config` пользователь должен получать конфиг с Endpoint 185.21.8.91 и выходить в интернет через Fornex (доступ к ChatGPT и др.).

---

## 2. Изменения в коде бота (Timeweb)

### 2.1. wireguard_peers.py

- **Fallback для SSH:** для ноды не `main` при отсутствии `WG_<ID>_SSH_HOST` в env используется `endpoint_host` (и при необходимости `ssh_user = "root"`).
- **Исправлена переменная `prefix`:** в сообщениях об ошибках для `main` использовалась необъявленная переменная — задаётся единообразно для обеих веток.
- **Логирование:** при создании пира логируются `telegram_id`, `server_id`, `ssh_host`, `network_cidr`.
- **Проверка wg_ip:** в `_add_peer_to_wireguard` добавлена проверка на пустой `wg_ip` (иначе на сервере мог появиться peer с `allowed ips: (none)`).

### 2.2. Конфиг клиента

- В выдаваемом конфиге: `Address = 10.1.0.x/24`, `Endpoint = 185.21.8.91:51820`, `AllowedIPs = 0.0.0.0/0`, `DNS = 1.1.1.1` (или из env).

### 2.3. Хранение пиров

- Один peer на пользователя в `peers.json` (ключ — `telegram_id`). Для eu1 в записи хранится `server_id: "eu1"` и `wg_ip` из подсети 10.1.0.0/24.

---

## 3. Очистка данных (обнуление eu1)

### 3.1. Fornex — удаление всех пиров с wg0

```bash
# Подключение с Timeweb (или с ПК без VPN)
ssh -i /root/.ssh/id_ed25519_eul root@185.21.8.91

# Удалить всех пиров одной командой
wg show wg0 | grep 'peer:' | awk '{print $2}' | while read pk; do wg set wg0 peer "$pk" remove; done

# Проверка
wg show wg0
```

### 3.2. Timeweb — удаление записей eu1 из peers.json

```bash
cd /opt/vpnservice/bot/data
cp peers.json peers.json.bak
python3 -c "
import json
p = json.load(open('peers.json'))
to_del = [k for k, v in p.items() if v.get('server_id') == 'eu1']
for k in to_del:
    del p[k]
open('peers.json','w').write(json.dumps(p, ensure_ascii=False, indent=2))
print('Удалено записей eu1:', len(to_del), to_del)
"
```

После этого при выборе «Европа» и `/get_config` бот создаёт новый peer с 10.1.0.x.

---

## 4. Настройка Fornex (сервер eu1)

### 4.1. IP forwarding

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
grep -q 'net.ipv4.ip_forward' /etc/sysctl.d/99-wireguard.conf 2>/dev/null || echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.d/99-wireguard.conf
```

### 4.2. Конфиг WireGuard /etc/wireguard/wg0.conf

- **Address:** `10.1.0.1/24`
- **ListenPort:** `51820`
- **PrivateKey:** ключ сервера
- **PostUp:** NAT и FORWARD для выхода клиентов в интернет и приёма трафика на wg0:

```bash
PostUp = iptables -t nat -A POSTROUTING -s 10.1.0.0/24 -o eth0 -j MASQUERADE; iptables -A FORWARD -i wg0 -o eth0 -j ACCEPT; iptables -A FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -s 10.1.0.0/24 -o eth0 -j MASQUERADE; iptables -D FORWARD -i wg0 -o eth0 -j ACCEPT; iptables -D FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

Если основной интерфейс не `eth0`, заменить в PostUp/PostDown (узнать: `ip route show default`).

### 4.3. Firewall (iptables) на Fornex

- **UDP 51820** — входящий трафик WireGuard:

```bash
iptables -I INPUT 1 -p udp --dport 51820 -j ACCEPT
```

- **Трафик с интерфейса wg0** — для доступа к самому серверу (в т.ч. SSH) с VPN-клиентов:

```bash
iptables -I INPUT 1 -i wg0 -j ACCEPT
```

- **Сохранение правил:**

```bash
apt-get install -y iptables-persistent 2>/dev/null
netfilter-persistent save
```

### 4.4. Конфиг пиров в wg0.conf

- У каждого пира должен быть **ровно один** блок `[Peer]` с `PublicKey` и `AllowedIPs = 10.1.0.x/32` (или один адрес из 10.1.0.0/24). Дубликаты по одному и тому же PublicKey с разными AllowedIPs (например один с `(none)`, второй с 10.1.0.2/32) — объединить в один блок с нужным AllowedIPs и убрать лишний блок.

### 4.5. Перезапуск WireGuard

```bash
systemctl restart wg-quick@wg0
wg show wg0
```

---

## 5. Проверки на Fornex (команды для копирования)

```bash
# Конфиг и активность сервиса
wg show wg0 && echo '---' && grep -E '^\[|Address |AllowedIPs' /etc/wireguard/wg0.conf && systemctl is-active wg-quick@wg0

# Адрес интерфейса
ip -4 addr show wg0

# Правила INPUT (первые строки)
iptables -L INPUT -n -v --line-numbers | head -10

# Правила FORWARD
iptables -L FORWARD -n -v --line-numbers | head -15

# NAT POSTROUTING
iptables -t nat -L POSTROUTING -n -v
```

---

## 6. Текущее состояние и нерешённая проблема

### Что работает

- Бот на Timeweb добавляет пиров на eu1 по SSH (ключ `id_ed25519_eul`, хост 185.21.8.91).
- На Fornex: wg0 поднят, Address 10.1.0.1/24, пиры с allowed ips 10.1.0.2/32 и 10.1.0.0/24.
- Firewall: INPUT — ACCEPT для udp dpt:51820 и для интерфейса wg0; FORWARD — правила wg0↔eth0 в начале цепочки; NAT — MASQUERADE для выхода в eth0.
- Клиентский конфиг: AllowedIPs = 0.0.0.0/0, Endpoint = 185.21.8.91:51820, DNS = 1.1.1.1.
- При правильном ключе пира на сервере: handshake и двусторонний UDP-обмен по 51820 (tcpdump на eth0 показывает пакеты от клиента и от сервера). Туннель на уровне WireGuard поднимается.

### Что не работает

- С телефона и с ПК при включённом VPN: сайты не открываются (грузятся без результата), `ping 10.1.0.1` — 100% потерь.
- В клиенте WireGuard: «Получено» почти всегда 0 или очень мало (92–364 Б), «Отправлено» растёт (десятки КБ). Ответы от сервера до клиента почти не доходят.
- При включении VPN на ПК текущая SSH-сессия к 185.21.8.91 обрывается; новое подключение по SSH к 185.21.8.91 с включённым VPN «висит» (без второго ПК отлаживать нельзя).

### Направления, которые пробовали (без успеха)

- **MTU на клиенте:** 1280 — подключается, но сайты не грузятся; 1240 и 1200 — ошибка «Unable to configure adapter network settings» в Windows WireGuard.
- **TCPMSS на Fornex:** `--clamp-mss-to-pmtu` и `--set-mss 1200` в FORWARD (mangle) для wg0 — правила добавлены и сохранены, сайты по‑прежнему не открываются.

---

## 7. Переменные env на Timeweb для eu1

В `/opt/vpnservice/env_vars.txt` должны быть заданы (пример):

```text
WG_EU1_SERVER_PUBLIC_KEY=...
WG_EU1_INTERFACE=wg0
WG_EU1_NETWORK_CIDR=10.1.0.0/24
WG_EU1_ENDPOINT_HOST=185.21.8.91
WG_EU1_ENDPOINT_PORT=51820
WG_EU1_DNS=1.1.1.1
WG_EU1_SSH_HOST=185.21.8.91
WG_EU1_SSH_USER=root
WG_EU1_SSH_KEY_PATH=/root/.ssh/id_ed25519_eul
# Опционально: MTU в клиентском конфиге (например 1280). Если задан WG_EU1_MTU, в выдаваемый .conf попадёт строка MTU = <значение>.
# WG_EU1_MTU=1280
```

При отсутствии `WG_EU1_SSH_HOST` бот использует fallback на `endpoint_host`.

---

## 8. Диагностика с двумя ПК (итоги сессии)

Диагностика проводилась так: один человек на Fornex (SSH, tcpdump), второй — на своём ПК с включённым VPN eu1. Так можно смотреть трафик на сервере, не теряя SSH при включении VPN у пользователя.

### 8.1. Несовпадение публичного ключа (O vs 0)

На сервере у пира был публичный ключ с **цифрой 0** в Base64 (например `...Ta0pmGc7E0=`). В приложении WireGuard у пользователя отображался ключ с **латинской буквой O** (`...TaOpmGc7E0=`). После замены пира на сервере на ключ с **буквой O** (как в клиенте) появились handshake и двусторонний UDP на eth0 (tcpdump). **Вывод:** при «Received 0 B» и отсутствии handshake в первую очередь сверять ключ по символам O/0 и 1/l.

### 8.2. tcpdump на Fornex (при активном VPN у пользователя)

- **eth0, udp port 51820:** пакеты в обе стороны (клиент ↔ 185.21.8.91:51820) — UDP туннеля работает.
- **wg0:** виден DNS-запрос к 1.1.1.1, TCP handshake (SYN → 104.18.19.125:443, SYN-ACK, ACK). После этого сервер шлёт FIN — соединение закрывается без обмена данными. В SYN клиент объявляет MSS 1240.

То есть до сервера Fornex трафик доходит, handshake завершается, но дальше обмен данными не идёт; ответы до клиента не доходят (в WireGuard у пользователя «Получено» ≈ 0).

### 8.3. Попытки по MTU/MSS

- **Клиент (Windows WireGuard):** MTU 1280 — туннель поднимается, сайты не грузятся; MTU 1240 и 1200 — ошибка «Unable to configure adapter network settings».
- **Сервер (Fornex) iptables mangle FORWARD для wg0:**
  - Вариант 1: `TCPMSS --clamp-mss-to-pmtu` для `-o wg0` и `-i wg0` (TCP SYN).
  - Вариант 2: удалить clamp, добавить `TCPMSS --set-mss 1200` для `-o wg0` и `-i wg0`.
  - После каждого изменения: `netfilter-persistent save`.
- **Результат:** оба варианта не устранили проблему — сайты по‑прежнему не открываются.

### 8.4. Ошибка «1240»

Пользователь упоминал «ошибка 1240». Она может быть связана с сетевым/прокси-ошибком Windows или с тем, что клиент объявляет MSS 1240 в SYN; фиксированная причина в рамках этой сессии не установлена.

### 8.5. Краткий вывод

Туннель WireGuard устанавливается, handshake есть, UDP по 51820 в обе стороны есть. TCP handshake до целевого сервера (через Fornex) завершается, затем соединение закрывается без обмена данными; с клиента почти ничего не приходит (Received ≈ 0). Уменьшение MTU на клиенте (1240/1200) на Windows недоступно из‑за ошибки адаптера; MSS clamping / set-mss на сервере не помогли. Причина, по которой после handshake не идёт обмен данными и сайты не грузятся, не найдена. Возможные следующие шаги: проверка с другого клиента (другой ПК, Android/iOS), углублённый разбор пути и MTU/MSS (в т.ч. значение 1240).

---

## 9. Рекомендуемые проверки при «сайты не открываются»

Когда туннель поднимается (handshake есть), но трафик от сервера до клиента не идёт («Получено» ≈ 0), по шагам проверь следующее на Fornex (185.21.8.91). Желательно делать это с **второго ПК** (без VPN), чтобы SSH не обрывался при включении VPN у пользователя.

### 9.1. Reverse path filter (rp_filter)

Строгая проверка обратного пути может дропать ответы, пришедшие на «неожиданный» интерфейс.

```bash
# Текущие значения
sysctl net.ipv4.conf.all.rp_filter
sysctl net.ipv4.conf.default.rp_filter
sysctl net.ipv4.conf.eth0.rp_filter
sysctl net.ipv4.conf.wg0.rp_filter 2>/dev/null || true
```

Если для `wg0` или для `all`/`default` стоит `1` (strict), попробовать временно ослабить **только для теста**:

```bash
# Временно (до перезагрузки)
sysctl -w net.ipv4.conf.wg0.rp_filter=0
sysctl -w net.ipv4.conf.all.rp_filter=0
# Проверить с клиента: открываются ли сайты, есть ли «Получено» в WireGuard
```

Если помогло — зафиксировать в `/etc/sysctl.d/99-wireguard.conf`:

```bash
echo 'net.ipv4.conf.wg0.rp_filter=0' >> /etc/sysctl.d/99-wireguard.conf
sysctl -p /etc/sysctl.d/99-wireguard.conf
```

### 9.2. Полный дамп iptables

Убедиться, что нет лишних правил, режущих ESTABLISHED/RELATED для wg0 или ответы из eth0 в wg0.

```bash
iptables-save
```

Проверить:

- **FORWARD:** есть ACCEPT для `-i wg0 -o eth0` и для `-i eth0 -o wg0 -m state --state RELATED,ESTABLISHED` (или аналог), и нет DROP перед ними для этого трафика.
- **INPUT:** есть ACCEPT для `-i wg0` и для `-p udp --dport 51820`.
- **OUTPUT:** нет правил, блокирующих исходящий трафик в wg0.

### 9.3. Конфиг пиров на eu1

У каждого пира должен быть **ровно один** `AllowedIPs = 10.1.0.x/32`. Дубликаты по одному PublicKey или запись `10.1.0.0/24` вместо конкретного /32 могут ломать маршрутизацию.

```bash
wg show wg0
grep -E '^\[Peer\]|PublicKey|AllowedIPs' /etc/wireguard/wg0.conf
```

При необходимости удалить лишние пиры (см. разд. 3.1) и заново выдать конфиг через бота (`/get_config` для Европы).

### 9.4. Панель Fornex

- В панели управления VPS проверить, что нет «облачного» firewall или анти-DDoS, режущего исходящий трафик или ответы на порт 51820.
- Убедиться, что исходящий трафик с VPS не ограничен по портам/protocol.

### 9.5. Чеклист диагностики (копировать по шагам)

| # | Действие | Команда / где смотреть |
|---|----------|------------------------|
| 1 | Подключиться к Fornex (с ПК **без** VPN) | `ssh -i /root/.ssh/id_ed25519_eul root@185.21.8.91` |
| 2 | Проверить rp_filter | `sysctl net.ipv4.conf.all.rp_filter net.ipv4.conf.wg0.rp_filter` |
| 3 | При rp_filter=1 — временно отключить для wg0 | `sysctl -w net.ipv4.conf.wg0.rp_filter=0` |
| 4 | Полный дамп firewall | `iptables-save` (проверить FORWARD/INPUT/OUTPUT) |
| 5 | Пиры: только 10.1.0.x/32 | `wg show wg0` и `grep AllowedIPs /etc/wireguard/wg0.conf` |
| 6 | На другом ПК/телефоне включить VPN eu1, открыть сайт | Проверить «Получено» в клиенте WireGuard |
| 7 | При успехе — зафиксировать rp_filter в sysctl | См. 9.1 |

---

## 10. Если всё сделали, а сайты не открываются (Received ≈ 0)

По выводу диагностики часто видны две вещи.

### 10.1. Пиры с AllowedIPs 10.1.0.0/24 — неверно

На сервере у каждого пира должен быть **только** `AllowedIPs = 10.1.0.x/32`. Если у какого‑то пира указано `10.1.0.0/24`, маршрутизация ответов ломается: сервер не может однозначно решить, какому пиру отправить ответ.

**Что сделать на Fornex:** удалить пира с `10.1.0.0/24`, оставить только пиров с `10.1.0.x/32`. Твой рабочий пир (после `/regen`) должен остаться с одним адресом, например `10.1.0.2/32`.

### 10.2. UFW и FORWARD

На сервере включён UFW (видны цепочки `ufw-before-forward`, `ufw-user-forward` и т.д.). Если политика по умолчанию для FORWARD — **DENY**, пакеты могут дропаться в UFW до твоих правил iptables.

**Что сделать на Fornex:** явно разрешить форвард для WireGuard (или проверить, что default forward не DENY). Команды — в п. 10.4 ниже.

### 10.3. Удаление пира с AllowedIPs 10.1.0.0/24 (на Fornex)

Подключиться по SSH (с ПК **без** VPN), затем:

```bash
# Посмотреть пиров и их allowed ips
wg show wg0

# Найти публичный ключ пира, у которого allowed ips: 10.1.0.0/24 (не 10.1.0.x/32)
# Удалить только этого пира (подставь PublicKey из вывода wg show):
wg set wg0 peer <PublicKey_пира_с_10.1.0.0/24> remove

# Проверка: у всех оставшихся пиров должно быть 10.1.0.x/32
wg show wg0
```

Если не уверен, какой ключ кому принадлежит: пир с `10.1.0.2/32` — это твой текущий конфиг после `/regen`; пир с `10.1.0.0/24` нужно удалить.

### 10.4. Разрешить FORWARD в UFW (на Fornex)

Выполнять на Fornex после подключения по SSH:

```bash
# Статус и политики по умолчанию (смотреть Default: forward)
ufw status verbose | head -20
```

Если видишь `Default: forward (deny)` или forward не разрешён:

```bash
# Разрешить маршрутизацию между wg0 и eth0
ufw allow in on wg0 out on eth0
ufw allow in on eth0 out on wg0

# Или короче: разрешить forward для подсети VPN (подставь свой интерфейс, если не eth0)
ufw route allow in on wg0 out on eth0
ufw route allow in on eth0 out on wg0

ufw reload
```

Проверка:

```bash
ufw status verbose | grep -A5 Forward
```

После этого снова включить VPN на клиенте и проверить «Получено» и открытие сайтов.

---

## 11. Обратный путь не работает (return path broken)

**Симптомы:** туннель поднимается (handshake есть), «Отправлено» растёт, «Получено» почти не меняется (~90–250 Б). Пинг 8.8.8.8 при включённом VPN — 100% потерь. SSH к 185.21.8.91 при включённом VPN — «Connection aborted». На сервере в iptables FORWARD видно, что ответный трафик (eth0→wg0) идёт, но до клиента не доходит.

**Вывод:** исходящий трафик (клиент → сервер → интернет) работает; ответы (интернет → сервер → туннель → клиент) по пути до клиента теряются или доходят лишь частично. Проблема не в ключах (handshake есть) и не в личном кабинете Fornex (сервер «Работает», облачный Firewall в панели выключен).

**Провайдер/роутер клиента — не причина.** Проверено с трёх разных сетей: ты (один провайдер/роутер), друг (другой провайдер/роутер), третий человек с телефона (мобильный интернет). Везде одна и та же картина — сайты не открываются, «Получено» почти не растёт. Исключаем вариант «виноват конкретный роутер или провайдер у клиента».

**tcpdump (сессия с прошлым агентом):** на eth0 по UDP 51820 наблюдался двусторонний обмен — часть пакетов от сервера к клиенту уходила (21 пакет в обе стороны). При этом до клиента доходила лишь малая часть («Получено» ~90–250 Б). Итог: сервер часть ответов шлёт, большая часть до клиента не доходит — либо теряются по пути (MTU/фрагментация), либо не все пакеты формируются/отправляются на сервере. На wg0 при загрузке 1.1.1.1: DNS и TCP handshake (SYN/SYN-ACK/ACK) видны, затем сервер шлёт FIN — до обмена данными дело не доходит; клиент объявлял MSS 1240. MTU 1240/1200 на клиенте (Windows) давали ошибку настройки адаптера.

### Что уже проверено на сервере

- Peer: только `AllowedIPs = 10.1.0.x/32`, пир с `10.1.0.0/24` исправлен/удалён.
- iptables FORWARD: в начале цепочки ACCEPT для wg0↔eth0 и eth0→wg0 (RELATED,ESTABLISHED).
- rp_filter: 0 для all и wg0.
- ip_forward: 1.
- NAT POSTROUTING: MASQUERADE для 10.1.0.0/24 → eth0.
- Маршрут: `ip route get 8.8.8.8 iif wg0 from 10.1.0.2` — через eth0.

### Проверки без второго ПК (один пользователь)

1. **Другая сеть** — *не применимо как гипотеза:* проверено с трёх разных сетей (два провайдера/ПК + третий с телефона), везде то же поведение.
2. **Windows Firewall:** временно отключить брандмауэр Windows, снова включить VPN, проверить пинг и SSH к 185.21.8.91. *Проверено: не помогло.*
3. **Вопрос в поддержку Fornex:** в панели есть «Тикеты» — при возможности описать, что исходящий трафик с VPS есть, но UDP-ответы с порта 51820 до абонентского IP не доходят; спросить про фильтрацию исходящего трафика. База знаний Fornex (например, GeoIP в Nginx) к VPN/egress не относится. *Ответ Fornex: «С нашей стороны, ограничений нет.» — исходящий UDP с VPS до абонентских IP со стороны Fornex не блокируется.*

### Уточнение: шлёт ли сервер ответы (когда будет SSH)

При наличии доступа по SSH (без VPN или со второго устройства) на Fornex выполнить, подставив внешний IP клиента:

```bash
tcpdump -i eth0 -n 'udp port 51820' -c 20
```

Клиент с этим IP включает VPN и делает ping 8.8.8.8. В выводе должны появиться пакеты с `dst <IP_клиента>`. Если пакеты есть — сервер шлёт, потеря по пути; если нет — проблема в отправке с сервера (WireGuard/маршрутизация).

---

## 12. Финальные тесты и вывод (февраль 2026)

### 12.1. Результаты tcpdump (45 секунд, активный VPN у клиента)

**На Fornex (eth0, UDP 51820):**
- Захвачено: только сообщение `tcpdump: listening...`, итоговая статистика не видна в логе.
- `grep "178.252.127.208"` (IP клиента) — **пусто** (0 совпадений).
- `grep "185.21.8.91.*178.252.127.208"` (сервер → клиент) — **пусто**.
- `grep "178.252.127.208.*185.21.8.91"` (клиент → сервер) — **пусто**.

**На Fornex (`wg show wg0`):**
- После теста: `transfer: 14.25 KiB received, 33.17 KiB sent`.
- `latest handshake: 1 minute ago` (обновился с «2 days ago»).
- `endpoint: 178.252.127.208:63155` (обновился на IP клиента).

**У клиента (WireGuard):**
- `Получено: 252 Б` (почти не изменилось).
- `Отправлено: 9.63 КБ` (или больше).
- `Последнее рукопожатие: 13 сек назад`.
- Пинг 8.8.8.8 — **100% потерь**.

### 12.2. Парадокс и вывод

**Парадокс:** `wg show` на сервере показывает активный обмен (14.25 KiB received, 33.17 KiB sent), но:
- tcpdump на eth0 не показывает пакетов от клиента к серверу за 45 секунд активного теста.
- У клиента «Получено» почти не растёт (252 Б), пинг не проходит.

**Вывод:** WireGuard на сервере **считает**, что обменивается данными с клиентом (handshake обновляется, transfer растёт), но:
1. Либо пакеты от клиента до сервера теряются **до** eth0 (блокируются/режутся по пути — РКН, провайдер клиента, магистраль).
2. Либо пакеты от сервера к клиенту теряются **после** eth0 (на пути до клиента — РКН, провайдер клиента, магистраль).
3. Либо оба направления частично блокируются/теряются, и только handshake/keepalive проходят.

**Контекст:**
- Проверено с **трёх разных сетей** (два провайдера/ПК + мобильный интернет) — везде та же картина.
- Другой крупный VPN показывает тот же симптом («Получено 0, отправлено ок»).
- Fornex подтвердил: «С нашей стороны, ограничений нет».
- РКН сейчас замедляет работу VPN‑сервисов.

**Итог:** eu1 на Fornex (185.21.8.91, UDP 51820) **технически не работает для клиентов из России** в текущих условиях. Проблема не в конфигурации сервера (все проверки пройдены), а в **маршруте между Россией и этой нодой** (блокировка/потеря UDP‑трафика на уровне магистрали или провайдеров).

---

## 13. Варианты обхода для Fornex (не теряя оплаченный месяц)

Если Fornex уже оплачен на месяц, можно попробовать обходные пути без переезда на другой VPS:

### 13.1. WireGuard через TCP (через Nginx/Cloudflared)

WireGuard по умолчанию работает по UDP. Можно обернуть его в TCP через туннель:

**Вариант A: Cloudflared Tunnel (Cloudflare Tunnel)**
- На Fornex установить `cloudflared`, создать туннель.
- WireGuard слушает локально (127.0.0.1:51820), cloudflared проксирует через TCP 443.
- Клиент подключается к Cloudflare, Cloudflare проксирует на Fornex.
- **Плюсы:** бесплатно, обходит блокировки UDP, Cloudflare маскирует трафик.
- **Минусы:** дополнительный хоп, возможен overhead.

**Вариант B: Nginx TCP proxy**
- На Fornex настроить Nginx как TCP‑прокси для WireGuard.
- WireGuard слушает локально, Nginx принимает TCP на внешнем порту (например, 443) и проксирует на локальный UDP 51820.
- **Плюсы:** полный контроль, без внешних зависимостей.
- **Минусы:** WireGuard через TCP работает медленнее, нужна поддержка TCP в клиенте (не все клиенты поддерживают).

### 13.2. Обфускация UDP (udp2raw, phantun)

Обфускация WireGuard UDP в TCP или другой протокол:

**udp2raw:**
- На сервере: `udp2raw` оборачивает UDP WireGuard в TCP или UDP с обфускацией.
- На клиенте: `udp2raw` клиент разворачивает обратно.
- **Плюсы:** сохраняет производительность UDP, обходит простые блокировки.
- **Минусы:** нужна установка на клиенте (не встроено в WireGuard), сложнее настройка.

**phantun:**
- Аналогично udp2raw, но проще в настройке.
- **Плюсы:** проще, чем udp2raw.
- **Минусы:** всё равно нужна установка на клиенте.

### 13.3. Альтернативный протокол (ShadowSocks, V2Ray/Xray)

Вместо WireGuard использовать протоколы, которые лучше обходят блокировки:

**ShadowSocks:**
- Простой SOCKS5‑прокси с шифрованием.
- **Плюсы:** хорошо обходит блокировки, простой в настройке, есть клиенты для Windows/iOS.
- **Минусы:** не VPN (нет маршрутизации), нужно настраивать прокси в приложениях.

**V2Ray/Xray:**
- Продвинутый прокси с множеством протоколов и обфускацией.
- **Плюсы:** очень хорошо обходит блокировки, много вариантов обфускации.
- **Минусы:** сложнее в настройке, нужны специальные клиенты.

### 13.4. Проверка с не-российского IP

Перед переключением на обходные пути стоит **исключить проблему на стороне Fornex/сети**:

- Попросить кого‑то из‑за границы (не из России) подключиться к eu1 и проверить, работает ли VPN.
- Если работает — проблема точно в маршруте Россия ↔ Fornex.
- Если не работает — проблема может быть на стороне Fornex или в конфигурации.

### 13.5. Рекомендация

**Краткосрочно (чтобы не терять месяц Fornex):**
1. Попробовать **ShadowSocks** на Fornex (самый простой вариант, ~30 минут настройки).
2. Если ShadowSocks работает — значит, проблема именно в UDP WireGuard, можно дальше пробовать обфускацию WireGuard.

**Долгосрочно:**
- Рассмотреть **миграцию EU‑ноды на другой провайдер/ASN** (не Fornex), если проблема сохраняется.
- Или использовать **Cloudflared Tunnel** как постоянное решение (бесплатно, обходит блокировки).

---

*Документ составлен по итогам сессий отладки eu1 (февраль 2026).*
