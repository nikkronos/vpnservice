# eu1 (Fornex): текущий статус и известные ограничения

Документ фиксирует состояние по результатам нескольких сессий. **Не использовать для повторения одних и тех же шагов диагностики.**

## Известное ограничение

При включённом VPN на сервере eu1 (185.21.8.91), профиль **Unified** или **VPN+GPT**:

- Туннель WireGuard поднимается (handshake, передача данных в клиенте видны).
- На сервере трафик форвардится (правила FORWARD для wg0 обрабатывают пакеты).
- **Пинг до 8.8.8.8 с клиента даёт 100% потерь.**
- **Сайты не открываются.**

Это наблюдалось стабильно в нескольких сессиях. Причина, по всей видимости, на стороне маршрута/провайдера (Fornex) или блокировок, а не только в локальной настройке iptables на eu1.

## Что уже сделано на eu1 (не дублировать)

1. **FORWARD:** В начало цепочки вставлены правила:
   - `iptables -I FORWARD 1 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT`
   - `iptables -I FORWARD 1 -i wg0 -o eth0 -j ACCEPT`
   (чтобы трафик wg0 обрабатывался до цепочек Docker.)

2. **INPUT:** В начало цепочки вставлено:
   - `iptables -I INPUT 1 -m state --state ESTABLISHED,RELATED -j ACCEPT`
   (для прохождения ответов после MASQUERADE.)

3. **POSTROUTING:** Есть правило MASQUERADE для выхода в eth0 (источник 0.0.0.0/0 или 10.1.0.0/24).

4. **Shadowsocks:** Сервис `shadowsocks-libev-redir@ss-wg` (конфиг ss-wg.json), слушает 127.0.0.1:1081. Не использовать `@config` (это серверный конфиг).

5. **Unified профиль:** ipset `unified_ss_dst`, правило PREROUTING для 10.1.0.20–50, порты 80/443 → 1081.

## Что сделано в боте

- `/server_exec <server_id> <command>` — выполнение команд на сервере по SSH (команда через stdin, кавычки из Telegram снимаются).
- При смене типа профиля (например, на «Универсальный») по `/get_config` или `/regen` бот пересоздаёт peer с нужным типом и пулом IP (Unified: 10.1.0.20–50, файл `_unified.conf`).
- В `docs/deployment.md` описаны FORWARD, INPUT, сервис ss-redir@ss-wg.

## Рекомендации для пользователя

- Использовать сервер **main** (Timeweb) для стабильного доступа в интернет через VPN.
- Для eu1 рассмотреть миграцию на другого хостинг-провайдера, если нужен именно EU-выход.

## Ссылки

- Обзор и правила: `README_FOR_NEXT_AGENT.md`
- Деплой и iptables: `docs/deployment.md`
- План диагностики (исторический): `docs/diagnosis-plan-eu1-fornex.md`
