# Оптимизация VPN для работы с несколькими устройствами

## Проблема

При подключении с двух устройств одновременно интернет работает хуже, хотя нагрузка на сервере не меняется.

## Возможные причины (не связанные с ресурсами сервера)

### 1. Пропускная способность канала провайдера

**Проблема:** Провайдер TimeWeb может ограничивать пропускную способность на уровне сети, а не CPU/RAM.

**Проверка:**
```bash
# Установить speedtest-cli
apt install speedtest-cli

# Проверить скорость сервера
speedtest-cli

# Проверить скорость при одном подключении vs двух
# (подключить одно устройство, проверить скорость, затем подключить второе)
```

**Решение:**
- Если скорость сервера низкая (<50 Мбит/с) — проблема в тарифном плане TimeWeb
- Рассмотреть использование сервера Fornex для одного из устройств (распределение нагрузки)

### 2. Оптимизация настроек WireGuard

**Проблема:** Настройки WireGuard могут быть не оптимальны для нескольких одновременных подключений.

**Решения:**

#### A. Оптимизация MTU

MTU (Maximum Transmission Unit) влияет на эффективность передачи данных. Неоптимальный MTU может вызывать фрагментацию пакетов и снижение скорости.

**Проверка текущего MTU:**
```bash
# На сервере
ip link show wg0

# На клиенте (Windows)
netsh interface ipv4 show subinterfaces

# На клиенте (iOS)
# MTU отображается в приложении WireGuard
```

**Оптимизация:**
- Для большинства случаев оптимальный MTU для WireGuard: **1420**
- Если есть проблемы с подключением — попробовать **1280** (более консервативный вариант)

**Реализация:**
- Добавить MTU в конфиг сервера `/etc/wireguard/wg0.conf`:
  ```
  [Interface]
  MTU = 1420
  ```
- Бот уже поддерживает MTU в клиентских конфигах (через переменную `WG_MTU` или `WG_MAIN_MTU`)

#### B. Оптимизация PersistentKeepalive

PersistentKeepalive определяет, как часто клиент отправляет keepalive пакеты для поддержания соединения.

**Текущее значение:** 25 секунд (в коде бота)

**Рекомендации:**
- Для стабильных соединений: **25 секунд** (текущее значение) — оптимально
- Для нестабильных соединений: **15 секунд** — более частые keepalive
- Для экономии трафика: **60 секунд** — реже, но может быть проблемы с NAT

**Изменение:**
- Можно добавить параметр в `_build_client_config()` для настройки keepalive
- Или оставить 25 секунд как оптимальное значение

### 3. Оптимизация маршрутизации трафика

**Проблема:** При нескольких подключениях трафик может конфликтовать на уровне маршрутизации.

**Решения:**

#### A. Использование разных серверов для разных устройств

**Рекомендация:** Распределить устройства между серверами:
- Устройство 1 → сервер "Россия" (TimeWeb)
- Устройство 2 → сервер "Европа" (Fornex)

**Преимущества:**
- Нет конкуренции за ресурсы одного сервера
- Разные маршруты трафика
- Лучшая производительность

#### B. Оптимизация DNS

**Проблема:** Медленный DNS может замедлять работу интернета.

**Текущее значение:** `8.8.8.8` (Google DNS)

**Альтернативы:**
- `1.1.1.1` (Cloudflare DNS) — часто быстрее
- `9.9.9.9` (Quad9) — с защитой от вредоносных сайтов
- Локальный DNS на сервере (если настроен)

**Изменение:**
- Можно добавить несколько DNS серверов в конфиг:
  ```
  DNS = 1.1.1.1, 8.8.8.8
  ```

### 4. Оптимизация iptables правил

**Проблема:** Много правил iptables или неоптимальные правила могут замедлять трафик.

**Проверка:**
```bash
# Количество правил
sudo iptables -t nat -L PREROUTING -n | wc -l
sudo iptables -L FORWARD -n | wc -l

# Проверить, нет ли лишних правил
sudo iptables -t nat -L PREROUTING -n -v
```

**Оптимизация:**
- Убедиться, что правила применяются только к нужным IP
- Использовать `-m conntrack` для оптимизации обработки установленных соединений
- Минимизировать количество правил

### 5. Проблема на стороне клиента

**Возможные причины:**
- Конфликт маршрутизации на клиентском устройстве
- Проблемы с DNS на клиенте
- Ограничения провайдера клиента

**Решения:**
- Использовать разные DNS на разных устройствах
- Проверить настройки сети на клиентских устройствах
- Попробовать подключиться с разных сетей (Wi-Fi vs мобильный интернет)

## Рекомендации по реализации

### Приоритет 1: Быстрые улучшения

1. **Добавить поддержку нескольких DNS серверов:**
   - Изменить `DNS = 8.8.8.8` на `DNS = 1.1.1.1, 8.8.8.8`
   - Cloudflare DNS часто быстрее Google DNS

2. **Оптимизировать MTU:**
   - Добавить MTU = 1420 в конфиг сервера (если не установлен)
   - Убедиться, что клиентские конфиги тоже имеют оптимальный MTU

3. **Рекомендовать использование разных серверов:**
   - Обновить инструкции для пользователей
   - Добавить в бот рекомендацию использовать разные серверы для разных устройств

### Приоритет 2: Среднесрочные улучшения

1. **Добавить настройку keepalive:**
   - Сделать keepalive настраиваемым через переменные окружения
   - Оптимизировать значение для разных типов соединений

2. **Оптимизировать iptables:**
   - Проверить и оптимизировать правила для Shadowsocks
   - Использовать более эффективные правила

3. **Мониторинг пропускной способности:**
   - Добавить проверку скорости в веб-панель
   - Отслеживать скорость при разных количествах подключений

### Приоритет 3: Долгосрочные улучшения

1. **Реализовать единый профиль:**
   - См. `specs/spec-04-unified-profile-all-services.md`
   - Умная маршрутизация может улучшить производительность

2. **Добавить балансировку нагрузки:**
   - Автоматическое распределение устройств между серверами
   - Мониторинг нагрузки и автоматическое переключение

## Чеклист для диагностики

При проблемах с несколькими устройствами проверь:

- [ ] Скорость сервера (`speedtest-cli`)
- [ ] MTU на сервере и клиентах
- [ ] Количество правил iptables
- [ ] Использование DNS (попробовать разные DNS)
- [ ] Пинг до сервера с обоих устройств
- [ ] Потеря пакетов (`mtr` или `ping -f`)
- [ ] Работает ли лучше при использовании разных серверов

## Связанные документы

- `troubleshooting-multiple-devices.md` — общая диагностика
- `specs/spec-04-unified-profile-all-services.md` — единый профиль
- `deployment.md` — информация о серверах
