#!/bin/bash
# Скрипт для eu1: добавление клиента AmneziaWG, когда AmneziaWG запущен в Docker (контейнер amnezia-awg2).
# Развернуть на eu1: /opt/vpnservice/scripts/amneziawg-add-client-docker.sh
# Вызов ботом по SSH: amneziawg-add-client-docker.sh <client_ip>
# Вывод: первая строка PUBKEY=<публичный_ключ>, далее — клиентский .conf
#
# Требования на eu1: Docker, контейнер amnezia-awg2 (образ amnezia-awg2), wireguard-tools (wg genkey).
# Порт для клиентов: 48100 (как в docker ps: 0.0.0.0:48100->48100/udp).

set -e

# === Настройки (заполнить под свой сервер) ===
CONTAINER_NAME="${AWG_DOCKER_CONTAINER:-amnezia-awg2}"
AWG_INTERFACE="${AWG_INTERFACE:-awg0}"
ENDPOINT_HOST="${ENDPOINT_HOST:-185.21.8.91}"
ENDPOINT_PORT="${ENDPOINT_PORT:-48100}"
DNS="${DNS:-1.1.1.1, 8.8.8.8}"

CLIENT_IP="${1:?Usage: $0 <client_ip>}"
CLIENT_IP="${CLIENT_IP%%/*}"

# Генерация ключей на хосте (wireguard-tools)
if ! command -v wg &>/dev/null; then
  echo "PUBKEY=ERROR" >&2
  echo "Ошибка: не найден wg. Установи wireguard-tools: apt install wireguard-tools" >&2
  exit 1
fi
PRIVATE_KEY=$(wg genkey)
PUBLIC_KEY=$(echo "$PRIVATE_KEY" | wg pubkey)

# Добавление peer внутрь контейнера
if ! docker exec "$CONTAINER_NAME" awg set "$AWG_INTERFACE" peer "$PUBLIC_KEY" allowed-ips "${CLIENT_IP}/32" 2>/dev/null; then
  echo "PUBKEY=ERROR" >&2
  echo "Ошибка: не удалось добавить peer в контейнер $CONTAINER_NAME (интерфейс $AWG_INTERFACE). Проверь: docker exec $CONTAINER_NAME awg show" >&2
  exit 1
fi

# Публичный ключ сервера из контейнера
SERVER_PUBLIC_KEY=$(docker exec "$CONTAINER_NAME" awg show "$AWG_INTERFACE" public-key 2>/dev/null || true)
if [[ -z "$SERVER_PUBLIC_KEY" ]]; then
  echo "PUBKEY=ERROR" >&2
  echo "Ошибка: не удалось получить public-key из контейнера." >&2
  exit 1
fi

# Параметры обфускации AmneziaWG из конфига сервера (JunkPacketCount, Jmin, Jmax, S1, S2, H1-H4).
# Без них клиент от бота не подключается к серверу, поднятому приложением AmneziaVPN.
AWG_OBFUSCATION=""
for conf_path in /opt/amnezia/awg/awg0.conf /etc/amneziawg/awg0.conf /etc/amneziawg/.conf /etc/wireguard/awg0.conf; do
  RAW=$(docker exec "$CONTAINER_NAME" cat "$conf_path" 2>/dev/null || true)
  if [[ -n "$RAW" ]]; then
    # Секция [Interface]: выводим только строки обфускации (не PrivateKey, Address, ListenPort). Jc = JunkPacketCount; S3, S4 тоже бывают.
    AWG_OBFUSCATION=$(echo "$RAW" | sed -n '/^\[Interface\]/,/^\[/p' | grep -E '^\s*(JunkPacketCount|Jc|Jmin|Jmax|S1|S2|S3|S4|H1|H2|H3|H4)\s*=' | grep -v '^\s*#' | sed 's/^[[:space:]]*//')
    [[ -n "$AWG_OBFUSCATION" ]] && break
  fi
done

# Вывод для бота: первая строка PUBKEY=, далее — клиентский .conf (порт 48100 для клиентов)
echo "PUBKEY=$PUBLIC_KEY"
echo "[Interface]"
echo "PrivateKey = $PRIVATE_KEY"
echo "Address = ${CLIENT_IP}/32"
echo "DNS = $DNS"
if [[ -n "$AWG_OBFUSCATION" ]]; then
  echo "$AWG_OBFUSCATION"
fi
echo ""
echo "[Peer]"
echo "PublicKey = $SERVER_PUBLIC_KEY"
echo "Endpoint = ${ENDPOINT_HOST}:${ENDPOINT_PORT}"
echo "AllowedIPs = 0.0.0.0/0"
echo "PersistentKeepalive = 25"
