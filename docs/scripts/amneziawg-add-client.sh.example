#!/bin/bash
# Скрипт для eu1: добавление клиента AmneziaWG и вывод клиентского .conf
# Развернуть на eu1: /opt/vpnservice/scripts/amneziawg-add-client.sh
# Вызов ботом по SSH: amneziawg-add-client.sh <client_ip>
# Вывод: первая строка PUBKEY=<публичный_ключ>, далее — клиентский .conf
#
# Перед использованием: выполни проверку на eu1 (docs/amneziawg-eu1-discovery.md),
# затем задай переменные ниже или через env на eu1.

set -e

# === Настройки (заполнить после проверки на eu1) ===
AWG_INTERFACE="${AWG_INTERFACE:-awg0}"                    # Интерфейс AmneziaWG (awg show / ip link)
AWG_SERVER_CONF="${AWG_SERVER_CONF:-/etc/wireguard/awg0.conf}"  # Путь к серверному конфигу (для ListenPort)
ENDPOINT_HOST="${ENDPOINT_HOST:-185.21.8.91}"              # Публичный IP или домен eu1
ENDPOINT_PORT="${ENDPOINT_PORT:-51820}"
DNS="${DNS:-1.1.1.1, 8.8.8.8}"

CLIENT_IP="${1:?Usage: $0 <client_ip>}"
# Убираем маску, если передали 10.1.0.5/32
CLIENT_IP="${CLIENT_IP%%/*}"

# Проверка: awg или wg
if command -v awg &>/dev/null; then
  WG_CMD=awg
elif command -v wg &>/dev/null; then
  WG_CMD=wg
else
  echo "PUBKEY=ERROR" >&2
  echo "Ошибка: не найден awg или wg. Установи AmneziaWG (awg) на сервере." >&2
  exit 1
fi

# Генерация ключей
PRIVATE_KEY=$($WG_CMD genkey)
PUBLIC_KEY=$(echo "$PRIVATE_KEY" | $WG_CMD pubkey)

# Добавление peer в AmneziaWG
if ! $WG_CMD set "$AWG_INTERFACE" peer "$PUBLIC_KEY" allowed-ips "${CLIENT_IP}/32" 2>/dev/null; then
  echo "PUBKEY=ERROR" >&2
  echo "Ошибка: не удалось добавить peer в $AWG_INTERFACE. Проверь интерфейс и права." >&2
  exit 1
fi

# Публичный ключ сервера и порт
SERVER_PUBLIC_KEY=$($WG_CMD show "$AWG_INTERFACE" public-key)
if [[ -f "$AWG_SERVER_CONF" ]]; then
  LISTEN_PORT=$(grep -E '^ListenPort\s*=' "$AWG_SERVER_CONF" 2>/dev/null | head -1 | sed 's/.*=\s*//' | tr -d ' \r')
fi
LISTEN_PORT="${LISTEN_PORT:-$ENDPOINT_PORT}"

# Вывод для бота: первая строка PUBKEY=, далее — клиентский .conf
echo "PUBKEY=$PUBLIC_KEY"
echo "[Interface]"
echo "PrivateKey = $PRIVATE_KEY"
echo "Address = ${CLIENT_IP}/32"
echo "DNS = $DNS"
echo ""
echo "[Peer]"
echo "PublicKey = $SERVER_PUBLIC_KEY"
echo "Endpoint = ${ENDPOINT_HOST}:${LISTEN_PORT}"
echo "AllowedIPs = 0.0.0.0/0"
echo "PersistentKeepalive = 25"
