#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ VPN-—Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./check-server-load.sh

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ VPN-—Å–µ—Ä–≤–µ—Ä–∞ ==="
echo "–î–∞—Ç–∞: $(date)"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π WireGuard
echo "--- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WireGuard ---"
if systemctl is-active --quiet wg-quick@wg0; then
    echo "‚úÖ WireGuard –∞–∫—Ç–∏–≤–µ–Ω"
    echo ""
    echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∏—Ä–æ–≤:"
    sudo wg show wg0 | grep -c "peer" || echo "0"
    echo ""
    echo "–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∏—Ä–∞–º:"
    sudo wg show wg0 dump | awk 'NR>1 {
        peer = substr($1,1,20) "..."
        rx = $6
        tx = $7
        last_handshake = $5
        printf "Peer: %s | RX: %s bytes | TX: %s bytes | Last handshake: %s\n", peer, rx, tx, last_handshake
    }'
else
    echo "‚ùå WireGuard –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
fi
echo ""

# 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
echo "--- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ ---"
echo "CPU –∏ RAM:"
top -bn1 | grep -E "Cpu|Mem|Swap" | head -3
echo ""
echo "Load average:"
uptime | awk -F'load average:' '{print $2}'
echo ""

# 3. –°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
echo "--- –°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ---"
echo "–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WireGuard (UDP 51820):"
sudo ss -unp | grep 51820 | wc -l
echo ""
echo "–û–±—â–∏–π —Å–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥):"
if command -v iftop >/dev/null 2>&1; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ iftop –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: apt install iftop"
else
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo iftop -i eth0"
fi
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
echo "--- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ ---"
if command -v speedtest-cli >/dev/null 2>&1; then
    echo "–ó–∞–ø—É—Å–∫ speedtest (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)..."
    speedtest-cli --simple
else
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ speedtest-cli –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏: apt install speedtest-cli"
fi
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –ø–æ—Ç—Ä–µ–±–ª—è—é—â–∏—Ö —Ä–µ—Å—É—Ä—Å—ã
echo "--- –¢–æ–ø –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é CPU ---"
ps aux --sort=-%cpu | head -10
echo ""
echo "--- –¢–æ–ø –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é RAM ---"
ps aux --sort=-%mem | head -10
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ iptables –ø—Ä–∞–≤–∏–ª (–º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫)
echo "--- –ü—Ä–∞–≤–∏–ª–∞ iptables (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) ---"
echo "PREROUTING (NAT):"
sudo iptables -t nat -L PREROUTING -n | wc -l
echo "FORWARD:"
sudo iptables -L FORWARD -n | wc -l
echo ""

echo "=== –ö–æ–Ω–µ—Ü –æ—Ç—á—ë—Ç–∞ ==="
echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "- –ï—Å–ª–∏ CPU/RAM –∑–∞–≥—Ä—É–∂–µ–Ω—ã >80% - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π –º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã"
echo "- –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∏–∑–∫–∞—è - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
echo "- –ï—Å–ª–∏ –º–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª iptables - —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫"
