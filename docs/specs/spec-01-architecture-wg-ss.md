# Спецификация: Архитектура WireGuard + Shadowsocks

## Цель

Описать текущую архитектуру VPN‑сервиса: WireGuard‑сервер на Fornex и интеграцию с Shadowsocks для обхода блокировок (ChatGPT и др.). Документ служит базой для понимания системы и дальнейших изменений.

## Обзор

- **WireGuard** — основной VPN: клиенты подключаются к серверу Fornex, весь трафик идёт через него.
- **Shadowsocks** — дополнительный туннель: для выбранных клиентов HTTP/HTTPS на сервере редиректится через `ss-redir` во внешний Shadowsocks‑сервер (`185.21.8.91:8388`), чтобы обходить блокировки по IP (например, ChatGPT).
- **MTProto** — отдельный Telegram‑прокси; см. `spec-02-telegram-mtproto-proxy.md`.

## Архитектура (схема)

```
Клиент (ПК / iPhone / iPad)
    │
    │ WireGuard (UDP 51820)
    ▼
Сервер Fornex (wg0, 10.1.0.1/24)
    │
    ├─ Трафик клиентов БЕЗ редиректа (10.1.0.2, 10.1.0.3, …)
    │      → NAT → eth0 → интернет (напрямую)
    │
    └─ Трафик клиентов С редиректом (10.1.0.4, 10.1.0.5, 10.1.0.6, 10.1.0.7)
           → iptables PREROUTING (TCP 80/443) → REDIRECT → 127.0.0.1:1081
           → ss-redir (shadowsocks-libev)
           → Shadowsocks‑сервер 185.21.8.91:8388 (aes-256-gcm)
           → интернет
```

## Компоненты на сервере Fornex (Ubuntu 24.04)

### 1. WireGuard (`wg0`)

- **Конфиг**: `/etc/wireguard/wg0.conf`
- **Подсеть**: `10.1.0.0/24`
- **Адрес сервера**: `10.1.0.1/24`
- **Порт**: `51820/UDP`
- **PostUp/PostDown**: NAT (MASQUERADE) для `10.1.0.0/24` через `eth0`, правила FORWARD для `wg0` ↔ `eth0`

**Клиентские адреса (примеры)**:

| Устройство   | Адрес      | Редирект через SS |
|-------------|------------|--------------------|
| Владелец ПК (client1) | 10.1.0.2/32 | нет  |
| Друг (широкий peer)   | 10.1.0.0/24 | нет  |
| Владелец iPhone      | 10.1.0.4/32 | да   |
| Друг PC              | 10.1.0.5/32 | да   |
| Друг iPhone          | 10.1.0.6/32 | да   |
| Друг iPad            | 10.1.0.7/32 | да   |

### 2. Shadowsocks‑клиент (ss-redir)

- **Пакет**: `shadowsocks-libev`
- **Конфиг**: `/etc/shadowsocks-libev/ss-wg.json`
- **Режим**: `ss-redir` (transparent proxy)
- **Локальный порт**: `127.0.0.1:1081`
- **Внешний сервер**: `185.21.8.91:8388`, метод `aes-256-gcm`
- **Сервис**: `ss-wg.service` (systemd), автозапуск

### 3. iptables (редирект)

- **Таблица**: `nat`, цепочка `PREROUTING`
- **Правило**: входящий трафик с интерфейса `wg0`, источник `10.1.0.4/32`, `10.1.0.5/32`, `10.1.0.6/32`, `10.1.0.7/32`, протокол TCP, порты назначения 80, 443 → `REDIRECT` на порт `1081`
- **Цель**: направить HTTP/HTTPS выбранных клиентов в `ss-redir`, остальной трафик — как обычно (NAT через eth0)

### 4. Резервные копии

- **Директория**: `/root/vpn-backups/YYYY-MM-DD/`
- **Файлы**: `wg0.conf`, клиентские `.conf` (например, `iphone.conf`), `ss-wg.json`, при необходимости `mtproto-link.txt`
- **Правило**: перед изменениями конфигов создавать новую дата‑директорию и копировать туда текущие файлы

## Профили и сценарии использования

- **«Обычный VPN»**: профили от Telegram‑бота (client1 и аналоги) — трафик идёт через WireGuard напрямую (NAT на сервере), без Shadowsocks.
- **«VPN + GPT»**: наши профили (`iphone`, `friend-pc`, `friend-iphone`, `friend-ipad`) — трафик идёт через WireGuard, HTTP/HTTPS редиректится через Shadowsocks; подходит для обхода блокировок ChatGPT (и ограничений по IP), при этом YouTube/Telegram могут вести себя иначе в зависимости от IP Shadowsocks‑сервера.
- **«Только Telegram»**: MTProto‑прокси (отдельная ссылка), без включения VPN.

## Ограничения и известные проблемы

- **Совместимость сервисов**: один профиль не обеспечивает одновременно беспроблемную работу YouTube, ChatGPT, Telegram и всех сайтов так, как у крупных VPN‑провайдеров; поведение зависит от IP (WireGuard vs Shadowsocks) и блокировок. Задача по улучшению зафиксирована в ROADMAP (раздел «Улучшение совместимости сервисов»).
- **Не менять выданные адреса** (`10.1.0.4`–`10.1.0.7`) без необходимости — это сломает существующие конфиги.
- **Секреты** (ключи WireGuard, пароль Shadowsocks, секрет MTProto) не хранить в Git; они лежат на сервере и в локальных `env_vars` / бэкапах.

## Зависимости

- Для работы редиректа должны быть запущены: `wg-quick@wg0`, `ss-wg.service`.
- Проверка: `systemctl status wg-quick@wg0`, `systemctl status ss-wg.service`, `iptables -t nat -L PREROUTING -n | grep 1081`.

## Связанные документы

- `README_FOR_NEXT_AGENT.md` — текущее состояние и профили
- `docs/mtproto-setup.md` — установка MTProto
- `spec-02-telegram-mtproto-proxy.md` — спецификация MTProto‑прокси
- `ROADMAP_VPN.md` — планы и приоритеты
