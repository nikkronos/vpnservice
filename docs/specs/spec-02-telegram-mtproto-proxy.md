# Спецификация: Telegram MTProto Proxy

## Цель

Настроить MTProto‑прокси на VPN‑сервере Fornex для обхода потенциальной блокировки Telegram в РФ. Прокси должен работать параллельно с WireGuard и Shadowsocks, не мешая им.

## Требования

- **Сервер**: Fornex (Ubuntu 24.04), тот же, где работает WireGuard + Shadowsocks
- **Порт**: Выбрать свободный порт (например, `443` или `8443` для TCP)
- **Протокол**: MTProto (Telegram‑нативный протокол)
- **Автозапуск**: systemd‑сервис
- **Мониторинг**: Логи через journalctl

## Архитектура

```
Telegram клиент (iOS/Android/Desktop)
    ↓ tg://proxy?server=...&port=...&secret=...
MTProto Proxy (Fornex сервер, порт 443/8443)
    ↓
Telegram серверы (через интернет)
```

**Важно**: MTProto‑прокси работает **отдельно** от WireGuard и Shadowsocks:
- Пользователь может использовать только MTProto для Telegram (без VPN)
- Или использовать VPN (WireGuard) для всего трафика, включая Telegram
- Или комбинировать: VPN для всего + MTProto как резерв для Telegram

## Выбор решения

**Рекомендуется**: Docker‑контейнер `telegrammessenger/proxy` (официальный от Telegram)

**Преимущества**:
- Простая установка и обновление
- Автоматическая генерация секрета и ссылки подключения
- Поддержка статистики и мониторинга
- Активная поддержка от Telegram

**Альтернатива**: Нативный `mtproto-proxy` (Erlang), если Docker недоступен

## Технические детали

### Параметры прокси

- **Secret**: Автоматически генерируется при первом запуске
- **Port**: `443` (TCP) — стандартный HTTPS порт для маскировки, или `8443` если 443 занят
- **Tag**: Опционально, для статистики (можно использовать имя сервера или локацию)

### Ссылка подключения

Формат: `tg://proxy?server=<IP>&port=<PORT>&secret=<SECRET>`

Пример: `tg://proxy?server=81.200.146.32&port=443&secret=ee...`

## Этапы реализации

1. **Установка Docker** (если не установлен)
2. **Запуск MTProto‑прокси контейнера**
3. **Настройка systemd для автозапуска**
4. **Генерация ссылки подключения**
5. **Тестирование с Telegram клиента**
6. **Документация для пользователей**

## Риски и митигация

- **Риск**: Порт 443 может быть занят другим сервисом
  - **Митигация**: Проверить `netstat -tuln | grep 443` перед установкой, использовать `8443` при необходимости
- **Риск**: Docker может быть не установлен
  - **Митигация**: Добавить шаг установки Docker в инструкцию
- **Риск**: Прокси может быть заблокирован провайдером
  - **Митигация**: Использовать порт 443 (HTTPS) для маскировки, при необходимости добавить obfuscation

## Чеклист проверки

- [ ] Docker установлен и работает
- [ ] MTProto‑контейнер запущен и слушает нужный порт
- [ ] systemd‑сервис создан и включён для автозапуска
- [ ] Ссылка `tg://proxy?...` сгенерирована и работает
- [ ] Тест подключения через Telegram на iOS/Android успешен
- [ ] Логи доступны через `journalctl`
- [ ] Документация обновлена (README, инструкции для друзей)

## Следующие шаги после реализации

- Добавить мониторинг доступности прокси
- Подготовить инструкции для друзей (как добавить прокси в Telegram)
- Рассмотреть возможность автоматической выдачи ссылок через Telegram‑бота
