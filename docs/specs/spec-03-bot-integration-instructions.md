# Спецификация: интеграция VPN-бота с инструкциями и профилями

## Цель

Подключить текущего Telegram-бота VPN к новой инфраструктуре (WireGuard + Shadowsocks, MTProto) так, чтобы:
1. **Автоматическая инструкция** — пользователь получал пошаговую, работающую инструкцию по подключению (ПК / iPhone–iPad), без ручной работы с ключами для сотен людей.
2. **Выдача конфигов** — остаётся как есть (`/get_config`, `/regen`, `/server`), при необходимости добавляется опция «VPN+GPT» для Европы (eu1).
3. **MTProto-прокси** — бот выдаёт ссылку/инструкцию по подключению Telegram через прокси (одна команда или раздел в инструкции).

## Текущее состояние бота (из DONE_LIST)

- Бот на Timeweb: команды `/start`, `/get_config`, `/my_config`, `/add_user`, `/users`, `/regen`, `/server`.
- Выбор сервера: «Россия (Timeweb)» и «Европа» (eu1, Fornex 185.21.8.91).
- Конфиги: `vpn_<telegram_id>_<server_id>.conf` (например `vpn_123_eu1.conf`).
- Создание peer на eu1 по SSH (wireguard_peers, env: WG_EU1_*).

## Требования к «инструкции, которая работает»

1. **После `/get_config`** (или по отдельной команде, например `/help` или «Инструкция») пользователь получает короткую пошаговую инструкцию:
   - **ПК (Windows):** установить WireGuard → импорт файла → подключиться (ссылка на полную инструкцию при необходимости).
   - **iPhone / iPad:** установить WireGuard → импорт из файла/буфера/QR → включить туннель.
2. Текст инструкции должен быть **фиксированным** (шаблон в коде или в конфиге), чтобы его можно было править и версионировать.
3. Инструкция **не должна содержать** ручную работу с ключами/конфигами на сервере — только действия в клиенте WireGuard на устройстве пользователя.

## Компоненты интеграции

### 1. Автоматическая выдача инструкции

- **Когда показывать:** после успешной выдачи конфига (`/get_config`) и/или по команде типа `/instruction` или кнопке «Как подключиться».
- **Содержание:** краткие шаги для выбранной платформы. Платформу можно спросить кнопками («ПК (Windows)», «iPhone / iPad») или выдать оба варианта.
- **Источник текста:** шаблоны в коде бота или отдельные файлы (например, `bot/instructions_pc.txt`, `bot/instructions_ios.txt`), заполняемые из `docs/client-instructions-pc.md` и `docs/client-instructions-ios.md` (без Markdown-разметки для Telegram).

Рекомендация: хранить тексты в репозитории (например, `bot/instructions/` или в `docs/` в виде plain text), бот при старте или по требованию читает их и отправляет пользователю.

### 2. Выдача ссылки MTProto-прокси

- **Когда показывать:** по команде типа `/proxy` или «Ссылка для Telegram», или один раз после `/start` (кратко: «Для Telegram при блокировках: /proxy»).
- **Что выдавать:** одну и ту же ссылку `tg://proxy?server=...&port=443&secret=...` (и при необходимости короткую инструкцию: «Настройки → Прокси → вставь ссылку»).
- **Конфигурация:** ссылка хранится в переменной окружения (например, `MTPROTO_PROXY_LINK`) или в конфиге бота; не хардкодить в коде.

### 3. Опция «VPN+GPT» для Европы (eu1)

- **Смысл:** при выборе сервера «Европа» пользователь может выбрать тип профиля:
  - **Обычный VPN** — peer создаётся как сейчас, трафик идёт напрямую через eu1 (без редиректа через Shadowsocks).
  - **VPN+GPT** — peer создаётся с IP из «пула редиректа» (например, следующий свободный 10.1.0.x); на сервере eu1 для этого IP добавляется правило iptables (редирект TCP 80/443 на 1081). В результате HTTP/HTTPS пользователя идёт через Shadowsocks (ChatGPT и др. работают).
- **Реализация на сервере eu1:**
  - Скрипт (например, `/opt/vpnservice/scripts/add-ss-redirect.sh <IP>`) добавляет правило:  
    `iptables -t nat -A PREROUTING -i wg0 -s <IP>/32 -p tcp -m multiport --dports 80,443 -j REDIRECT --to-ports 1081`
  - При создании peer типа «VPN+GPT» бот по SSH вызывает этот скрипт с IP нового peer.
  - Пул IP: зарезервировать диапазон для «VPN+GPT» (например, 10.1.0.8–10.1.0.254), при создании peer выбирать следующий свободный IP из этого диапазона (проверка по `wg show` или по локальному списку в боте).
- **Реализация в боте:**
  - После выбора «Европа» показывать выбор: «Обычный VPN» / «VPN+GPT (обход блокировок ChatGPT)».
  - При выборе «VPN+GPT»: создать peer с IP из пула редиректа, по SSH выполнить `add-ss-redirect.sh <IP>`, выдать конфиг как обычно.
  - Имена конфигов можно различать, например: `vpn_<id>_eu1.conf` (обычный), `vpn_<id>_eu1_gpt.conf` (VPN+GPT), чтобы пользователь не путал.

### 4. Нотация профилей в боте

- В сообщениях бота использовать понятные названия: «Обычный VPN», «VPN+GPT», «Ссылка для Telegram» (см. `docs/profile-names.md`).
- В инструкции явно указать: «Этот конфиг — VPN+GPT» или «Обычный VPN», чтобы пользователь понимал, чего ожидать.

## Чеклист реализации

- [ ] Добавить в бота шаблоны/файлы с текстом инструкции для ПК и для iOS (на основе `docs/client-instructions-pc.md`, `docs/client-instructions-ios.md`).
- [ ] Реализовать выдачу инструкции после `/get_config` и/или по команде/кнопке «Как подключиться» (с выбором ПК / iPhone–iPad при необходимости).
- [ ] Добавить переменную окружения `MTPROTO_PROXY_LINK` (или аналог) и команду/кнопку «Ссылка для Telegram» — отправка ссылки и краткой инструкции по добавлению прокси в Telegram.
- [ ] (Опционально) Для eu1: добавить выбор «Обычный VPN» / «VPN+GPT»; при «VPN+GPT» — выделение IP из пула редиректа, создание peer, вызов на сервере скрипта добавления iptables, выдача конфига с пояснением «VPN+GPT».
- [ ] На сервере eu1: создать скрипт `add-ss-redirect.sh <IP>` и (при необходимости) `remove-ss-redirect.sh <IP>`, документировать в `docs/deployment.md`.
- [ ] Протестировать сценарий: новый пользователь → `/start` → выбор сервера → выбор типа (если eu1) → `/get_config` → получение конфига и инструкции → подключение по инструкции → проверка работы; отдельно проверить выдачу MTProto-ссылки и подключение Telegram через прокси.

## Риски и митигация

- **Инструкция устаревает:** хранить тексты в репозитории, при изменении документации обновлять шаблоны в боте и деплоить.
- **Путаница между «Обычный VPN» и «VPN+GPT»:** явно подписывать тип профиля в сообщении бота и в имени файла конфига.
- **Сотни пользователей:** бот уже создаёт peer по SSH; пул IP для VPN+GPT (10.1.0.8–254) достаточен для сотен пользователей; при необходимости можно завести вторую подсеть или второй интерфейс.

## Связанные документы

- `docs/client-instructions-pc.md` — полная инструкция для ПК
- `docs/client-instructions-ios.md` — полная инструкция для iPhone/iPad
- `docs/mtproto-client-instructions.md` — инструкция по MTProto-прокси
- `docs/profile-names.md` — нотация профилей
- `docs/deployment.md` — сервер eu1, сервисы, скрипты
- `README_FOR_NEXT_AGENT.md` — текущее состояние инфраструктуры
