# Реализация единого профиля (Unified) — пошаговый план

## Цель

Одна кнопка для всех сервисов: YouTube, ChatGPT, Telegram, обычные сайты. Без изменения поведения существующих профилей «Обычный VPN» и «VPN+GPT».

## Принцип безопасности

- **Не менять** существующие правила iptables для клиентов 10.1.0.4–10.1.0.7 и 10.1.0.8–254 (VPN+GPT).
- **Добавить** только новый пул IP и новые правила для типа «Универсальный».
- Все изменения на сервере — **дополнительные** (новые скрипты, ipset, одна новая цепочка/правила).

## Архитектура

### Текущее состояние (не трогаем)

- **Обычный VPN**: peer без редиректа (трафик напрямую через NAT).
- **VPN+GPT**: peer с IP из пула 10.1.0.8–254; для каждого такого IP есть правило: весь TCP 80/443 → REDIRECT на 1081 (ss-redir).

### Новое (только добавление)

- **Универсальный (Unified)**:
  - Пул IP на eu1: **10.1.0.20–10.1.0.50** (отдельно от VPN+GPT).
  - Для этих IP редирект **не** всего 80/443, а только трафика **в IP из списка «заблокированных»** (ChatGPT и т.п.).
  - Список задаётся через домены → резолв в IP → ipset `unified_ss_dst`.
  - Одна группа правил iptables: источник 10.1.0.20–10.1.0.50, назначение в ipset, порты 80/443 → REDIRECT 1081.
  - Остальной трафик (YouTube, Telegram, обычные сайты) идёт напрямую через NAT (без ss-redir).

### Пул IP на eu1 (Fornex)

| Тип профиля   | Пул октетов   | Примечание                          |
|---------------|----------------|-------------------------------------|
| VPN+GPT       | 8–19, 51–254   | Как сейчас, но не занимаем 20–50    |
| Unified       | 20–50          | Только маршрутизация через ipset    |

Существующие peer'ы с IP 10.1.0.8–19 и 10.1.0.51–254 продолжают работать как раньше (редирект всего 80/443). Новые VPN+GPT получают IP из 8–19 или 51–254. Новые Unified — из 20–50.

## Шаги реализации

### 1. Сервер eu1 (Fornex): ipset и правила (один раз)

- Установить `ipset`: `apt install -y ipset`
- Создать set для IP назначений, куда редиректим через SS:
  - `ipset create unified_ss_dst hash:ip family inet -exist`
- Одна группа правил (добавлять вручную или скриптом, **не** в PostUp wg0, чтобы не сломать текущий конфиг):
  - Для трафика с wg0 от 10.1.0.20–10.1.0.50 в порты 80/443 с назначением в `unified_ss_dst`:
    - `iptables -t nat -A PREROUTING -i wg0 -m iprange --src-range 10.1.0.20-10.1.0.50 -p tcp -m set --match-set unified_ss_dst dst -m multiport --dports 80,443 -j REDIRECT --to-ports 1081`
- Сохранить ipset и правила (при перезагрузке восстанавливать):
  - `ipset save > /etc/ipset.conf` (или отдельный файл), восстановление в скрипте или systemd.
  - Правила iptables — через `iptables-persistent` или скрипт в `/etc/network/if-up.d/` / отдельный unit.

### 2. Скрипт обновления списка IP (домены → ipset)

- Список доменов (только те, что нужно вести через SS, например ChatGPT):
  - `openai.com`, `chat.openai.com`, `chatgpt.com`, `platform.openai.com`, …
- Скрипт (например `update-unified-ss-ips.sh`):
  - Разрешает домены через `getent hosts` или `dig`/`host`.
  - Очищает `unified_ss_dst` и заполняет полученными IPv4.
  - Запуск по cron раз в час (или раз в сутки).
- Скрипт **не** трогает существующие правила для 10.1.0.4–7 и 10.1.0.8–19, 51–254.

### 3. Бот: новый тип профиля «Unified»

- В `wireguard_peers.py`:
  - Для eu1 ввести тип `profile_type="unified"`.
  - Выделение IP для Unified только из пула 20–50 (отдельная функция или параметр пула).
  - Для VPN+GPT при выделении IP **исключать** октеты 20–50 (чтобы пул VPN+GPT фактически был 8–19 и 51–254).
  - При создании peer с `profile_type="unified"` **не** вызывать `add-ss-redirect.sh` (редирект только через ipset).
- В `main.py`:
  - В `/server` для eu1 добавить третью кнопку «Универсальный» (или заменить один из вариантов по твоему выбору; лучше добавить третью опцию, чтобы не ломать текущий выбор).
  - При выборе «Универсальный» сохранять `preferred_profile_type="unified"`.
  - При выдаче конфига для unified подставлять DNS, например `10.1.0.1, 1.1.1.1` (опционально; можно оставить как у остальных).

### 4. Клиентский конфиг

- Для Unified в конфиге WireGuard можно оставить те же поля, что и для VPN+GPT; единственное отличие — на сервере для этого IP не вешается «полный» редирект 80/443, только через ipset.
- DNS в конфиге: по желанию `10.1.0.1, 1.1.1.1` (если на сервере поднимем dnsmasq — можно использовать 10.1.0.1 первым).

### 5. Документация и откат

- В `README_FOR_NEXT_AGENT.md` и `docs/deployment.md` описать:
  - что такое профиль Unified;
  - что на eu1 нужно один раз поднять ipset и правило для 10.1.0.20–10.1.0.50;
  - что скрипт обновления ipset должен запускаться по cron.
- Откат: удалить правило iptables для 10.1.0.20–10.1.0.50 и ipset; бот перестаёт выдавать Unified (оставить только Обычный и VPN+GPT). Существующие клиенты 10.1.0.4–7 и 8–19, 51–254 не затронуты.

## Чеклист перед внедрением

- [ ] На eu1 сделан бэкап `/etc/wireguard/wg0.conf` и текущих iptables.
- [ ] Установлен ipset, создан `unified_ss_dst`, добавлено одно правило PREROUTING для 10.1.0.20–10.1.0.50.
- [ ] Скрипт обновления ipset проверен вручную, добавлен в cron.
- [ ] В боте добавлен тип Unified и пул 20–50, без вызова add-ss-redirect для Unified.
- [ ] Для VPN+GPT пул изменён на 8–19 и 51–254 (исключён 20–50).
- [ ] Проверка: новый пользователь с Unified получает конфиг, подключается, ChatGPT идёт через SS, YouTube/Telegram — напрямую.

## Риски и митигация

- **Риск:** опечатка в диапазоне 10.1.0.20–10.1.0.50 и задели чужие IP.  
  **Митигация:** правило явно с `--src-range 10.1.0.20-10.1.0.50` и `--match-set unified_ss_dst dst`; больше никаких правил для этих IP не добавляем.

- **Риск:** забыли сохранить ipset/iptables — после перезагрузки Unified перестаёт работать.  
  **Митигация:** документировать восстановление ipset и одного правила (скрипт или systemd).

- **Риск:** домены ChatGPT меняют IP — часть трафика перестаёт идти через SS.  
  **Митигация:** периодический перезапуск скрипта обновления ipset (cron раз в час/день).
