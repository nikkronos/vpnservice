# Спецификация: Единый профиль для всех сервисов

## Цель

Реализовать единый VPN-профиль, который обеспечивает одновременную работу:
- YouTube (видео, без блокировок)
- ChatGPT (обход блокировок)
- Telegram (работа через VPN, без необходимости отдельного MTProto-прокси)
- Обычные сайты (без ограничений)

Как у крупных VPN-провайдеров — один профиль для всего.

## Текущая проблема

Сейчас VPN работает либо для одного сервиса (GPT), либо для другого (YouTube), либо для третьего (Telegram), но не для всех одновременно.

**Текущие профили:**
- **Обычный VPN**: трафик через WireGuard напрямую → YouTube работает, ChatGPT может не работать (если заблокирован по IP)
- **VPN+GPT**: трафик через WireGuard, HTTP/HTTPS через Shadowsocks → ChatGPT работает, но может быть медленнее для YouTube
- **MTProto proxy**: отдельно для Telegram → конфликтует с VPN на iPhone

## Предлагаемое решение

### Вариант 1: Умная маршрутизация через DNS и Split Tunneling

**Идея:** Использовать DNS для определения, какой трафик идёт через Shadowsocks, а какой напрямую.

**Реализация:**
1. Настроить DNS-сервер на VPN-сервере, который резолвит домены
2. Для доменов ChatGPT и заблокированных сайтов → маршрутизация через Shadowsocks
3. Для остальных доменов → маршрутизация напрямую через WireGuard

**Преимущества:**
- Один профиль для всего
- Автоматическое определение маршрута по домену
- Оптимизация скорости (не весь трафик через Shadowsocks)

**Недостатки:**
- Сложная настройка DNS и маршрутизации
- Может быть медленнее из-за DNS-резолвинга
- Требует поддержки списка доменов

### Вариант 2: Улучшенный Shadowsocks сервер с лучшим IP

**Идея:** Использовать Shadowsocks сервер с IP, который не заблокирован для YouTube и других сервисов.

**Реализация:**
1. Найти или настроить Shadowsocks сервер с IP, который работает для всех сервисов
2. Настроить VPN+GPT профиль так, чтобы весь трафик шёл через этот Shadowsocks
3. Убедиться, что IP не заблокирован для YouTube, ChatGPT, Telegram

**Преимущества:**
- Простая реализация (уже есть инфраструктура)
- Один профиль для всего
- Не требует изменений в клиентских приложениях

**Недостатки:**
- Зависит от внешнего Shadowsocks сервера
- Может быть медленнее из-за двойного туннелирования
- Нужен качественный Shadowsocks сервер

### Вариант 3: V2Ray/Xray с гибкой маршрутизацией

**Идея:** Использовать V2Ray/Xray вместо WireGuard для более гибкой маршрутизации трафика.

**Реализация:**
1. Настроить V2Ray/Xray сервер с правилами маршрутизации
2. Настроить клиент V2Ray на устройствах
3. Правила маршрутизации:
   - ChatGPT домены → через Shadowsocks
   - YouTube домены → напрямую
   - Telegram → напрямую
   - Остальное → по умолчанию

**Преимущества:**
- Гибкая маршрутизация по доменам/IP
- Хорошая обфускация трафика
- Поддержка различных протоколов

**Недостатки:**
- Требует перестройки инфраструктуры
- Нужны клиенты V2Ray на устройствах
- Более сложная настройка

### Вариант 4: WireGuard + Smart DNS + Shadowsocks (гибридный)

**Идея:** Комбинировать WireGuard с умной маршрутизацией на уровне сервера.

**Реализация:**
1. Настроить DNS-сервер на VPN-сервере (например, через dnsmasq)
2. Создать список доменов для Shadowsocks (ChatGPT и др.)
3. Настроить iptables правила для маршрутизации по доменам:
   - Домены из списка → через Shadowsocks
   - Остальные → напрямую через WireGuard
4. Использовать DNS на клиенте для определения маршрута

**Преимущества:**
- Сохраняет WireGuard (быстрый, простой)
- Гибкая маршрутизация
- Один профиль для всего

**Недостатки:**
- Сложная настройка DNS и маршрутизации
- Требует поддержки списка доменов
- Может быть медленнее из-за DNS-резолвинга

## Рекомендуемое решение

**Вариант 4 (Гибридный)** — как наиболее сбалансированный:
- Сохраняет существующую инфраструктуру WireGuard
- Добавляет умную маршрутизацию без полной перестройки
- Обеспечивает единый профиль для всех сервисов

## Детальная реализация (Вариант 4)

### Шаг 1: Настройка DNS-сервера на VPN-сервере

```bash
# Установить dnsmasq
apt install -y dnsmasq

# Создать конфиг
nano /etc/dnsmasq.d/vpn-routing.conf
```

**Конфиг `/etc/dnsmasq.d/vpn-routing.conf`:**
```
# DNS для VPN клиентов
listen-address=10.1.0.1
bind-interfaces

# Список доменов для Shadowsocks (ChatGPT и др.)
server=/openai.com/8.8.8.8
server=/chatgpt.com/8.8.8.8
server=/chat.openai.com/8.8.8.8
```

### Шаг 2: Настройка маршрутизации по доменам

Создать скрипт для динамической маршрутизации:
- Резолвить домены через DNS
- Определять IP адреса доменов из списка
- Добавлять iptables правила для маршрутизации этих IP через Shadowsocks

### Шаг 3: Обновление клиентского конфига

В клиентском конфиге WireGuard указать DNS сервера:
```
DNS = 10.1.0.1, 8.8.8.8
```

### Шаг 4: Обновление бота

Добавить новый тип профиля "Универсальный" или сделать VPN+GPT профиль умнее:
- Автоматически определять, какой трафик через Shadowsocks
- Использовать DNS для маршрутизации

## Альтернативное быстрое решение

**Временное решение до полной реализации:**

1. **Улучшить VPN+GPT профиль:**
   - Использовать более качественный Shadowsocks сервер
   - Оптимизировать настройки для лучшей скорости
   - Добавить инструкцию, что профиль работает для всех сервисов

2. **Решить конфликт Telegram:**
   - Настроить маршрутизацию Telegram трафика напрямую (минуя Shadowsocks)
   - Или использовать VPN+GPT профиль без MTProto proxy

3. **Добавить в бот:**
   - Объяснение, что VPN+GPT профиль работает для всех сервисов
   - Рекомендацию использовать VPN+GPT для универсального доступа

## Чеклист реализации

- [ ] Исследовать варианты решения (DNS маршрутизация, улучшенный Shadowsocks, V2Ray)
- [ ] Выбрать оптимальный вариант
- [ ] Создать детальную спецификацию выбранного варианта
- [ ] Реализовать на сервере (DNS, маршрутизация, правила)
- [ ] Обновить клиентские конфиги
- [ ] Обновить бота (новый тип профиля или улучшение существующего)
- [ ] Протестировать на всех сервисах (YouTube, ChatGPT, Telegram, сайты)
- [ ] Обновить документацию

## Риски и митигация

**Риск:** Сложная настройка может сломать существующую инфраструктуру
**Митигация:** Тестировать на тестовом сервере, делать бэкапы перед изменениями

**Риск:** Производительность может ухудшиться
**Митигация:** Мониторить производительность, оптимизировать настройки

**Риск:** DNS-маршрутизация может не работать для всех доменов
**Митигация:** Поддерживать список доменов, обновлять его регулярно

## Связанные документы

- `spec-01-architecture-wg-ss.md` — текущая архитектура
- `troubleshooting-ios-devices.md` — проблемы с устройствами
- `eu1-workarounds-fornex.md` — обходные пути
- `ROADMAP_VPN.md` — планы развития

## Приоритет

**Высокий** — это ключевая задача для улучшения UX и достижения MVP.

## Временные рамки

- Исследование вариантов: 1-2 дня
- Реализация: 3-5 дней
- Тестирование: 2-3 дня
- **Итого: ~1-2 недели**
