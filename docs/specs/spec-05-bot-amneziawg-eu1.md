# Спецификация: бот выдаёт конфиги AmneziaWG для eu1

**Цель:** Для сервера «Европа» (eu1) бот выдаёт конфиги AmneziaWG так же, как сейчас выдаёт WireGuard для main: пользователь выбирает сервер, нажимает /get_config и получает готовый `.conf` файл. Все друзья и знакомые получают новые конфиги (AmneziaWG); старые WireGuard eu1 конфиги больше не выдаются.

**Дата:** 2026-02-21

---

## 1. Контекст

- **main (РФ, Timeweb):** WireGuard работает; бот создаёт peer через `wg set`, формирует `.conf` — без изменений.
- **eu1 (Fornex):** Обычный WireGuard из России не работает (блокировка). Развёрнут **AmneziaWG** по инструкции (Amnezia app → SSH → установка AmneziaWG). Подключение из РФ работает. Сейчас конфиги AmneziaWG создаются вручную в приложении AmneziaVPN и передаются пользователям.
- **Требование:** То же самое, что с WireGuard: пользователь нажимает /get_config для Европы и получает готовый AmneziaWG `.conf` от бота.

---

## 2. Варианты реализации

### Вариант A: Скрипт на eu1 (рекомендуемый при наличии CLI)

На eu1 разворачивается скрипт (или используется SoVoKaN/amneziawg-server-tools / RomikB/amneziawg-install в неинтерактивном режиме), который:

- Вызывается ботом по SSH: `amneziawg-add-client.sh <telegram_id>` (или `<client_name>`).
- Выделяет IP (или принимает из аргумента), генерирует ключи, добавляет peer в AmneziaWG (`awg set ...` или через API/CLI инструмента).
- Выводит готовый клиентский `.conf` в stdout (с обфускацией, как на сервере).
- Бот захватывает stdout и отправляет пользователю файлом.

**Плюсы:** Вся логика AmneziaWG на сервере; бот только вызывает скрипт и шлёт результат.  
**Минусы:** Нужно знать путь к конфигу AmneziaWG на eu1 и интерфейс (awg0 или wg0 в зависимости от сервера); возможна доработка скрипта под формат конфига Amnezia app.

### Вариант B: Логика в боте (awg на eu1)

Бот для eu1:

1. Выделяет IP (как сейчас для WireGuard eu1).
2. Генерирует ключи (`wg genkey` на стороне бота — формат совместим с AmneziaWG).
3. По SSH на eu1: добавляет peer: `awg set <interface> peer <public_key> allowed-ips <ip>`.
4. По SSH на eu1: читает конфиг сервера AmneziaWG (путь из env, например `AMNEZIAWG_EU1_CONFIG_PATH`) и извлекает: публичный ключ сервера, ListenPort, параметры обфускации (JunkPacketCount и т.д.).
5. Собирает клиентский `.conf`: `[Interface]` (PrivateKey, Address, DNS, параметры обфускации из серверного конфига) и `[Peer]` (PublicKey сервера, Endpoint, AllowedIPs, PersistentKeepalive).
6. Сохраняет peer в `peers.json` (тот же формат; для eu1 можно пометить `protocol: "amneziawg"` при необходимости).
7. Отправляет `.conf` пользователю.

**Плюсы:** Не нужен отдельный скрипт на eu1; достаточно доступа по SSH и наличия `awg`.  
**Минусы:** Нужно знать путь к конфигу AmneziaWG на eu1 и формат (обфускация); парсинг конфига в боте.

### Вариант C: Фаза 1 — только инструкции (fallback)

Если на eu1 нельзя программно получить AmneziaWG конфиг (нет `awg`, конфиг в нестандартном месте):

- Для выбора «Европа» бот **не создаёт** WireGuard peer на eu1 и **не выдаёт** старый WireGuard `.conf`.
- Бот отправляет инструкцию по AmneziaWG (`docs/client-instructions-amneziawg.md`) и текст: «Конфиг для Европы (AmneziaWG) выдаётся вручную. Напиши владельцу или запроси конфиг.»
- Команда /instruction для Европы ведёт на инструкцию AmneziaWG.
- Владелец создаёт конфиги в приложении AmneziaVPN и рассылает пользователям. Позже — фаза 2: автоматизация через скрипт или awg.

---

## 3. Шаг 0: Проверка на eu1 (обязательно перед реализацией A или B)

Выполнить на сервере eu1 (185.21.8.91) по SSH:

```bash
# Есть ли awg (AmneziaWG)?
which awg
awg --version 2>/dev/null || true

# Где конфиг AmneziaWG? (Amnezia app мог положить в /etc/amnezia/ или /etc/wireguard/)
ls -la /etc/wireguard/
ls -la /etc/amnezia/ 2>/dev/null || true
ls -la /etc/amnezia/amneziawg/ 2>/dev/null || true

# Имя интерфейса (awg0, wg0, и т.д.)
ip link show | grep -E 'awg|wg'

# Если есть awg0 — публичный ключ сервера и порт
awg show awg0 2>/dev/null || true
```

Результат зафиксировать в проекте (в этом спеке или в `docs/deployment.md`). От него зависит выбор варианта A или B и названия переменных окружения.

---

## 4. Изменения в боте

### 4.1. Поведение для eu1

- При выборе сервера «Европа» и команде /get_config или /regen:
  - **Если реализован вариант A или B:** создаётся/обновляется peer AmneziaWG на eu1, пользователь получает AmneziaWG `.conf`.
  - **Если выбран вариант C:** peer на eu1 не создаётся; пользователь получает инструкцию AmneziaWG и указание запросить конфиг у владельца.
- Старые WireGuard eu1 конфиги больше не выдаются (для eu1 всегда AmneziaWG или инструкция).

### 4.2. Тексты и команды

- **/start:** Упоминать, что для Европы выдаётся AmneziaWG (или инструкция + ручная выдача).
- **/instruction:** Для Европы отдавать инструкцию по AmneziaWG (ПК + iOS через «Поделиться»), см. `docs/client-instructions-amneziawg.md`. При необходимости — отдельные короткие тексты в `docs/bot-instruction-texts/` (например, `instruction_amneziawg_short.txt`).
- **/help:** Указать, что для сервера «Европа» используется AmneziaWG; импорт конфига — в приложение AmneziaVPN/AmneziaWG.

### 4.3. Конфигурация (env)

Для варианта B (и при необходимости для A):

- `AMNEZIAWG_EU1_INTERFACE` — имя интерфейса на eu1 (`awg0` или `wg0`; бот передаёт его в скрипты как AWG_INTERFACE).
- `AMNEZIAWG_EU1_CONFIG_PATH` — путь к серверному конфигу на eu1 (например, `/etc/amnezia/amneziawg/awg0.conf`), чтобы читать публичный ключ сервера, порт и параметры обфускации.

Вариант A: скрипт вызывается через `WG_EU1_SSH_HOST`, `WG_EU1_SSH_USER`, `WG_EU1_SSH_KEY_PATH` (рекомендуемое имя ключа на Timeweb: `id_ed25519_eu1`) и `AMNEZIAWG_EU1_ADD_CLIENT_SCRIPT=/opt/vpnservice/scripts/amneziawg-add-client.sh`. Пошаговая настройка: `docs/amneziawg-bot-automation-setup.md`.

### 4.4. Хранилище (peers.json)

- Существующий формат peer (telegram_id, wg_ip, public_key, server_id, active, profile_type) сохраняется.
- Для eu1 peer'ы, выданные через AmneziaWG, могут помечаться полем `protocol: "amneziawg"` (опционально, для аналитики и миграции). Ключ в `peers.json` по-прежнему `telegram_id` (один активный peer на пользователя на сервер).

---

## 5. Миграция пользователей

- Все пользователи eu1 должны получить новый конфиг (AmneziaWG). Старый WireGuard eu1 конфиг перестаёт быть актуальным (из РФ он и так не работал).
- Владелец: рассылает друзьям/знакомым сообщение: «Для Европы теперь AmneziaWG. Напиши боту /server, выбери Европу, затем /get_config — придёт новый конфиг. Импортируй его в AmneziaVPN/AmneziaWG по инструкции.»
- В боте при первом после обновления /get_config для eu1 пользователь получает новый AmneziaWG конфиг (или инструкцию при варианте C).

---

## 6. Риски и митигация

| Риск | Митигация |
|------|-----------|
| На eu1 конфиг AmneziaWG в нестандартном месте | Шаг 0 (проверка на eu1); зафиксировать путь в env и в документации. |
| Формат клиентского .conf AmneziaWG отличается (обфускация) | Использовать параметры из серверного конфига; при необходимости взять пример .conf из Amnezia app и воспроизвести структуру в боте/скрипте. |
| SoVoKaN/RomikB только интерактивные | Вариант B (awg на eu1) или собственный скрипт на eu1, вызываемый по SSH с аргументами. |

---

## 7. Чеклист реализации

- [ ] Выполнить шаг 0 на eu1, зафиксировать путь к конфигу и интерфейс.
- [ ] Выбрать вариант (A, B или C).
- [ ] Для A: написать/развернуть скрипт на eu1, добавить в env путь к скрипту; в боте для eu1 вызывать скрипт по SSH, захватывать stdout, отправлять .conf.
- [ ] Для B: добавить в боте модуль/функции для eu1: чтение конфига AmneziaWG с eu1, добавление peer через awg, сборка клиентского .conf; env для интерфейса и пути к конфигу.
- [ ] Для C: отключить создание WireGuard peer для eu1; при /get_config для Европы отправлять инструкцию AmneziaWG и текст про ручную выдачу.
- [ ] Обновить /instruction и /help (Europe = AmneziaWG).
- [ ] Обновить /start и сообщения при выборе сервера «Европа».
- [ ] Добавить/обновить короткие тексты в `docs/bot-instruction-texts/` для AmneziaWG.
- [ ] Обновить `docs/deployment.md` и `README_FOR_NEXT_AGENT.md`: eu1 = AmneziaWG, переменные env при необходимости.
- [ ] Проверить: /server → Европа → /get_config — пользователь получает AmneziaWG .conf (или инструкцию при C).
- [ ] Обновить ROADMAP_VPN.md и DONE_LIST_VPN.md.

---

## 8. Связанные документы

- `docs/amneziawg-deploy-instruction.md` — развёртывание AmneziaWG на eu1.
- `docs/client-instructions-amneziawg.md` — инструкция для пользователей (ПК + iOS).
- `docs/step-by-step-plan-bypass.md` — шаг 6 (зафиксировать вариант, бот).
- `README_FOR_NEXT_AGENT.md` — текущая архитектура и серверы.
