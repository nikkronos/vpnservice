# Спецификация: Деплой веб-панели VPN и учёт трафика по пользователям

**Версия:** 0.2  
**Дата:** 2026-02-21  
**Статус:** Реализовано (этапы 1–3)

## Цель

1. **Развернуть веб-панель** на сервере (Timeweb или eu1), получить рабочую ссылку, зафиксировать URL в документации.
2. **Показывать на сайте всю информацию**, нужную владельцу: ноды, сервисы, подключения, пользователи, при необходимости графики/алерты.
3. **Добавить учёт трафика по пользователям** — кто сколько расходует (rx/tx по peer).

---

## Текущее состояние

- Веб-панель уже есть в `web/`: Flask, API `/api/servers`, `/api/users`, `/api/stats`, `/api/traffic`, `/api/services`, шаблон `index.html`.
- Панель читает `users.json` и `peers.json` (бот), проверяет доступность серверов через ping; трафик — с нод через `wg show` (локально и по SSH).
- **Деплой:** автоматического деплоя (CI/CD) нет; обновления применяются вручную на сервере (`git pull`, перезапуск `vpn-web.service`). См. `docs/deployment.md`.

---

## План работ

### Этап 1: Деплой веб-панели

| Шаг | Задача | Результат |
|-----|--------|-----------|
| 1.1 | Выбрать хост: Timeweb (рядом с ботом) или eu1 | Решение зафиксировать в ROADMAP/docs |
| 1.2 | Установить зависимости на сервере (`pip install -r web/requirements.txt`), скопировать `web/`, настроить `env_vars.txt` (ADMIN_ID, пути к data) | Панель запускается вручную |
| 1.3 | Создать systemd unit `vpn-web.service` (WorkingDirectory, ExecStart, User), включить и запустить | Панель работает 24/7 |
| 1.4 | (Рекомендуется) Настроить nginx reverse proxy + HTTPS (Let's Encrypt) | Доступ по https://... |
| 1.5 | Зафиксировать URL панели в `docs/deployment.md` и ROADMAP | Документация актуальна |

**Итог этапа 1:** Есть ссылка на панель, владелец видит статус серверов и базовую статистику (пользователи, пиры по серверам).

---

### Этап 2: «Вся информация» на сайте

| Шаг | Задача | Результат |
|-----|--------|-----------|
| 2.1 | Расширить главную страницу / API: список пользователей с привязкой к пирам (без admin_key на главной — только сводка; детали по auth) | На главной: сводка + по серверам/профилям |
| 2.2 | Страница/блок «Сервисы»: WireGuard (main/eu1), AmneziaWG (eu1), Shadowsocks, MTProto — статус (доступен/недоступен), если применимо | Владелец видит состояние всех сервисов |
| 2.3 | (Опционально) Графики: активные пиры по времени, простые алерты (нода недоступна → заметно на панели) | Улучшенный мониторинг |

**Итог этапа 2:** На сайте отображается вся ключевая информация для мониторинга (ноды, сервисы, пользователи, подключения).

---

### Этап 3: Учёт трафика по пользователям

**Источник данных:** На каждой VPN-ноде (main, eu1) WireGuard/AmneziaWG хранит счётчики rx/tx по каждому peer. Команда `wg show all transfer` (или `wg show wg0`) выдаёт `peer <pubkey> ... transfer: X received, Y sent`.

| Шаг | Задача | Результат |
|-----|--------|-----------|
| 3.1 | Сбор данных с серверов: скрипт или вызов по SSH с Timeweb к main и eu1 — выполнить `wg show <interface> transfer` (для AmneziaWG — аналог по документации), сопоставить pubkey с `peers.json` (telegram_id, username) | Получить rx/tx по каждому peer на каждой ноде |
| 3.2 | API: новый endpoint `/api/traffic` — возвращает список: user (telegram_id, username), server_id, peer (ip/pubkey), rx_bytes, tx_bytes, при необходимости сумма по пользователю | Панель может запросить трафик |
| 3.3 | Вариант A: панель по расписанию (cron) или по кнопке вызывает скрипт сбора и сохраняет результат в файл/БД; API отдаёт последние сохранённые данные. Вариант B: панель при открытии страницы выполняет SSH к нодам и запрашивает `wg show` в реальном времени (медленнее, нужны SSH-ключи на сервере панели) | Выбрать A или B, реализовать |
| 3.4 | UI: страница или блок «Трафик»: таблица/карточки — пользователь, сервер, устройство (peer), принято/отправлено (в МБ/ГБ), сумма по пользователю | Владелец видит, кто сколько расходует |

**Итог этапа 3:** На сайте отображается кто (пользователь/peer) сколько трафика расходует по каждой ноде.

---

## Риски и митигация

| Риск | Митигация |
|------|-----------|
| SSH с панели к нодам — сложность и безопасность | Использовать отдельный ключ только для чтения `wg show`; либо скрипт на каждой ноде, который по cron пишет rx/tx в общее место (NFS/SCP), панель только читает |
| Сброс счётчиков при перезагрузке WireGuard | Это ожидаемо; показывать «трафик с последнего сброса» или накапливать в БД/файле при каждом опросе (дельта + сумма) |
| AmneziaWG на eu1 — другой формат вывода | Изучить `awg` CLI на eu1, добавить парсер в скрипт сбора |

---

## Чеклист

- [x] Деплой: панель запущена на сервере, systemd (vpn-web.service), есть URL
- [x] URL зафиксирован в docs/deployment.md и ROADMAP (http://81.200.146.32:5001)
- [x] На сайте отображаются: серверы, сервисы, пользователи (сводка), пиры по серверам
- [x] Реализован сбор rx/tx с main (локально) и eu1 (по SSH), `wg show dump`
- [x] API `/api/traffic` возвращает трафик по пользователям/пирам
- [x] На панели есть блок «Трафик» с отображением кто сколько расходует; добавлены подсказки ко всем блокам

---

## Связанные документы

- `ROADMAP_VPN.md` — блок «Веб-панель мониторинга»
- `web/README.md` — установка и деплой панели
- `docs/deployment.md` — серверы и команды
- `bot/storage.py` — модель User, Peer (привязка pubkey → telegram_id)
