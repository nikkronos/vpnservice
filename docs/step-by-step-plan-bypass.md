# Пошаговый план: от текущего состояния до рабочего VPN

От этого плана отталкиваемся. Цель: **VPN стабильно работает из России** (eu1 и/или другие ноды). Сервер eu1 (Fornex) сохраняем.

**Выбранный вариант: A (AmneziaWG).** Один клиент AmneziaVPN на ПК и iOS/iPadOS; обфускация; при блокировке РКН можно добавить Xray в том же приложении. Конкретные шаги развёртывания: **docs/amneziawg-deploy-instruction.md**.

---

## Шаг 0. Текущее состояние (напоминание)

- **main (Timeweb, РФ)** — WireGuard работает.
- **eu1 (Fornex, 185.21.8.91)** — обычный WireGuard по UDP из России не работает; трафик через VPN (в т.ч. VPN+GPT/Unified) до интернета не доходит. Shadowsocks (ss-redir) на сервере есть, но полноценный выход в интернет через eu1 не настроен под всех пользователей.
- **Стратегия:** протоколы с обфускацией + при необходимости тест провайдеров и непопулярных доменов (см. `blocking-bypass-strategy.md`).

---

## Шаг 1. Вариант протокола и клиента

**Выбрано: A (AmneziaWG).** Один клиент AmneziaVPN на ПК и на iPhone/iPad; обфускация; при блокировке — в том же приложении можно добавить Xray. Дальше действуем по **docs/amneziawg-deploy-instruction.md**.

---

## Шаг 2. Нода для пилота

Стартуем с **одной ноды — eu1** (Fornex, 185.21.8.91). Разворачиваем AmneziaWG по docs/amneziawg-deploy-instruction.md. Если eu1 окажется недоступен из РФ — по той же инструкции можно развернуть AmneziaWG на другом VPS (тест провайдеров; непопулярные предпочтительнее).

---

## Шаг 3. Подготовка сервера eu1

1. **Доступ:** SSH к eu1 (185.21.8.91) — логин и ключ или пароль под рукой.
2. **Порты:** AmneziaWG ставится через приложение AmneziaVPN по SSH; приложение само настроит сервис. Текущие сервисы (WireGuard 51820, Shadowsocks, MTProto) не трогаем.
3. При установке через приложение при необходимости открыть в файрволе порт, который укажет Amnezia (см. документацию Amnezia для self-hosted).

---

## Шаг 4. Развернуть AmneziaWG на eu1

Действовать по **docs/amneziawg-deploy-instruction.md**: установить AmneziaVPN на ПК → добавить сервер eu1 по SSH → в приложении нажать «Установить» у AmneziaWG → дождаться установки → создать подключение и проверить с ПК.

---

## Шаг 5. Тест из России

1. Подключиться к VPN/прокси с устройства в России (тот же провайдер/сеть, что у целевых пользователей).
2. Проверить:
   - браузер (любой заблокированный или зарубежный сайт);
   - мессенджеры;
   - при необходимости — стриминг, Telegram и т.д.
3. Записать результат по каждой ноде: **работает / не работает** (и по возможности кратко — таймауты, ошибки).

**Результат шага:** минимум одна нода даёт стабильный доступ из РФ — переходим к шагу 6. Если ни одна не работает — шаг 6а.

---

## Шаг 6. Зафиксировать рабочий вариант

- Записать, какая нода и какой вариант (A/B/C/D) оказались рабочими.
- Оформить **инструкцию для пользователей:** как установить клиент (Amnezia / Shadowrocket / V2BOX и т.д.), как импортировать конфиг/ссылку, как включить подключение.
- Сохранить конфиги и ссылки в безопасном месте (резервные копии, без коммита секретов в Git).
- При необходимости доработать Telegram-бота: выдача конфига/ссылки под выбранный протокол (вместо или вместе с WireGuard `.conf`).

**Результат шага:** пользователи могут подключиться по инструкции; при необходимости бот выдаёт нужный конфиг/ссылку.

---

## Шаг 6а. Если ни одна нода не заработала

1. **Смена домена/IP:** если доступ к ноде был по домену — попробовать другой домен или другой IP у того же провайдера (если доступно).
2. **Смена провайдера:** добавить в список теста ещё одного зарубежного провайдера (по возможности непопулярного), развернуть тот же стек и повторить шаги 3–5.
3. **Смена варианта протокола:** попробовать другой вариант (A/B/C/D) на той же ноде или на новой.

Повторять цикл (развёртывание → тест из России) до появления хотя бы одной стабильной связки «нода + протокол + клиент».

**Результат шага:** есть хотя бы одна рабочая конфигурация — переходим к шагу 6.

---

## Шаг 7. Дальнейшие улучшения (после стабильной работы)

- Добавить вторую ноду (резерв или другой регион) по той же схеме.
- Настроить мониторинг доступности (например, из веб-панели или скрипта).
- Обновить ROADMAP и DONE_LIST: отметить выполненные шаги, зафиксировать выбранный протокол и клиент.

---

## Краткая последовательность (чеклист)

- [x] **Шаг 1.** Выбрано: A (AmneziaWG). Инструкция: docs/amneziawg-deploy-instruction.md.
- [x] **Шаг 2.** Нода для пилота: eu1 (при провале — другой VPS по той же инструкции).
- [x] **Шаг 3.** Подготовить eu1: SSH-доступ, при необходимости открыть порт под Amnezia.
- [x] **Шаг 4.** Развернуть AmneziaWG по docs/amneziawg-deploy-instruction.md (ПК → добавить сервер → установить AmneziaWG → создать подключение).
- [x] **Шаг 5.** Тест из России (ПК) — заработало.
- [ ] **Шаг 6.** Зафиксировать рабочий вариант, инструкцию для пользователей; при необходимости — бот.
- [ ] **(При провале)** **Шаг 6а.** Смена провайдера/домена или добавление Xray в Amnezia, повтор 3–5.
- [ ] **Шаг 7.** Резервная нода, мониторинг, обновление документации.

---

## Связанные документы

- `blocking-bypass-strategy.md` — варианты A/B/C/D, совет по провайдерам и доменам.
- `eu1-workarounds-fornex.md` — обходные пути для eu1.
- `README_FOR_NEXT_AGENT.md` — текущая архитектура.
- `ROADMAP_VPN.md` — блок «Обход блокировок РКН».

---

*План создан 2026-02-21. От него отталкиваемся при реализации.*
