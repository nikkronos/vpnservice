# Диагностика проблемы VPN на iPhone без SIM и iPad

## Проблема

VPN не работает на некоторых устройствах:
- Новый iPhone без SIM-карты
- iPad
- Другие iOS устройства

При этом на других устройствах (iPhone с SIM, ПК) VPN работает нормально.

## Возможные причины

### 1. Проблема с UDP WireGuard на Fornex (eu1)

**Известная проблема:** WireGuard UDP (порт 51820) на Fornex технически не работает для клиентов из России из-за блокировки/потери трафика на маршруте Россия ↔ Fornex.

**Проверка:**
```bash
# На клиентском устройстве (iPhone/iPad)
# Проверить подключение к серверу
ping 185.21.8.91

# Проверить UDP порт WireGuard
# (на iOS это сложно, но можно проверить через приложение Network Analyzer)
```

**Решение:**
Использовать обходные пути (см. раздел "Обходные пути" ниже).

### 2. Отсутствие SIM-карты влияет на сетевые настройки iOS

**Проблема:** iOS устройства без SIM могут иметь ограничения в сетевых настройках или использовать другой сетевой стек.

**Проверка:**
- Проверить, работает ли VPN на этом устройстве с другими серверами
- Проверить настройки сети на устройстве (Wi‑Fi, сотовые данные)

**Решение:**
- Использовать Wi‑Fi подключение (не сотовые данные)
- Попробовать другой VPN-сервер (если доступен)
- Использовать обходные пути (Shadowsocks, Cloudflared)

### 3. Разные сетевые стеки на разных устройствах

**Проблема:** Разные версии iOS или разные модели устройств могут по-разному обрабатывать VPN-соединения.

**Проверка:**
- Проверить версию iOS на проблемном устройстве
- Проверить, работает ли VPN на других iOS устройствах

**Решение:**
- Обновить iOS до последней версии
- Переустановить приложение WireGuard
- Использовать альтернативные методы подключения

## Обходные пути

### Вариант 1: ShadowSocks напрямую (без WireGuard)

**Описание:** Использовать ShadowSocks клиент напрямую, минуя WireGuard.

**Для iOS:**
1. Установить Shadowrocket или другой ShadowSocks клиент из App Store
2. Настроить подключение к внешнему ShadowSocks серверу `185.21.8.91:8388`
3. Использовать метод `aes-256-gcm` и пароль из конфига

**Преимущества:**
- Работает на всех устройствах, включая iPhone без SIM и iPad
- Обходит блокировки ChatGPT и других сервисов

**Недостатки:**
- Нет единого профиля VPN (нужен отдельный клиент)
- Может быть медленнее, чем WireGuard

### Вариант 2: WireGuard через TCP (Cloudflared Tunnel)

**Описание:** Использовать Cloudflared для туннелирования WireGuard через TCP.

**Настройка на сервере:**
```bash
# Установить cloudflared
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
chmod +x cloudflared-linux-amd64
sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

# Создать туннель
cloudflared tunnel create vpn-tunnel

# Настроить маршрутизацию WireGuard через туннель
# (требует дополнительной настройки)
```

**Преимущества:**
- Сохраняет преимущества WireGuard
- Работает через TCP (обходит блокировки UDP)

**Недостатки:**
- Сложная настройка
- Требует аккаунт Cloudflare
- Может быть медленнее из-за дополнительного туннелирования

### Вариант 3: udp2raw для обфускации UDP

**Описание:** Использовать udp2raw для обфускации UDP трафика WireGuard.

**Настройка:**
См. `docs/eu1-workarounds-fornex.md` раздел про udp2raw.

**Преимущества:**
- Сохраняет WireGuard протокол
- Обходит блокировки UDP

**Недостатки:**
- Требует клиент udp2raw на устройстве (может быть сложно на iOS)
- Дополнительная нагрузка на сервер

### Вариант 4: V2Ray/Xray с VLESS

**Описание:** Использовать V2Ray/Xray с протоколом VLESS вместо WireGuard.

**Настройка:**
См. `docs/eu1-workarounds-fornex.md` раздел про V2Ray/VLESS.

**Преимущества:**
- Работает на всех устройствах
- Поддерживает различные протоколы (VLESS, VMESS, Shadowsocks)
- Хорошая обфускация трафика

**Недостатки:**
- Требует перестройки инфраструктуры
- Более сложная настройка
- Нужны клиенты V2Ray на устройствах

### Вариант 5: Использовать другой VPN-сервер

**Описание:** Если доступен сервер "Россия" (main), использовать его вместо "Европа" (eu1).

**В боте:**
1. Выбрать `/server`
2. Выбрать "Россия (Timeweb)" вместо "Европа"
3. Получить конфиг `/get_config`

**Преимущества:**
- Простое решение
- Не требует изменений на сервере

**Недостатки:**
- Может не работать для ChatGPT (если заблокирован по IP)
- Нужен доступ к серверу "Россия"

## Рекомендации

### Для iPhone без SIM:

1. **Попробовать сначала:**
   - Использовать Wi‑Fi подключение (не сотовые данные)
   - Обновить iOS до последней версии
   - Переустановить WireGuard

2. **Если не помогает:**
   - Использовать ShadowSocks напрямую (Shadowrocket)
   - Или использовать сервер "Россия" вместо "Европа"

3. **Если нужен ChatGPT:**
   - Использовать ShadowSocks напрямую
   - Или настроить Cloudflared Tunnel (если есть возможность)

### Для iPad:

1. **Попробовать сначала:**
   - Те же шаги, что для iPhone без SIM
   - Проверить, работает ли VPN на других устройствах

2. **Если не помогает:**
   - Использовать ShadowSocks напрямую
   - Или использовать другой VPN-сервер

## Долгосрочное решение

**Миграция EU‑ноды на другой провайдер/ASN:**

Если обходные пути не помогают, рассмотреть миграцию EU‑ноды на другой провайдер:
- Выбрать провайдера с лучшей маршрутизацией в Россию
- Проверить, что UDP WireGuard работает для клиентов из России
- Мигрировать пользователей на новый сервер

## Связанные документы

- `eu1-workarounds-fornex.md` — детальные инструкции по обходным путям
- `eu1-setup-and-troubleshooting.md` — диагностика проблем eu1
- `deployment.md` — информация о серверах
- `spec-01-architecture-wg-ss.md` — архитектура системы

## Вопросы для диагностики

При обращении за помощью ответь на следующие вопросы:

1. Какое устройство? (iPhone модель, iPad модель)
2. Есть ли SIM-карта? (да/нет)
3. Какая версия iOS?
4. Какой сервер используешь? (Россия/Европа)
5. Какой тип профиля? (Обычный VPN/VPN+GPT)
6. Работает ли VPN на других устройствах?
7. Какая ошибка при подключении? (если есть)
