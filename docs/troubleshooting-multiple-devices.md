# Диагностика проблемы с несколькими устройствами

## Проблема

При подключении с двух устройств одновременно интернет работает плохо (медленно, обрывы соединения).

## Возможные причины

### 1. Ограничение пропускной способности на сервере

**Проверка:**
```bash
# На сервере Fornex (eu1)
# Проверить текущую скорость сервера
speedtest-cli

# Проверить использование трафика
iftop -i eth0
# или
nethogs

# Проверить лимиты провайдера Fornex
# (в документации или у поддержки)
```

**Решение:**
- Если скорость сервера низкая — проверить тарифный план Fornex
- При необходимости увеличить ресурсы VPS (CPU, RAM, пропускная способность)

### 2. Конкуренция за ресурсы (CPU/RAM)

**Проверка:**
```bash
# Проверить нагрузку CPU и RAM
htop
# или
top

# Проверить количество активных подключений WireGuard
sudo wg show

# Проверить статистику по каждому пиру
sudo wg show wg0 dump | awk '{print $1, $6, $7}' | column -t
# Колонки: public_key, received_bytes, sent_bytes
```

**Решение:**
- Если CPU/RAM загружены — оптимизировать настройки WireGuard
- Проверить, нет ли других процессов, потребляющих ресурсы
- При необходимости увеличить ресурсы VPS

### 3. Ограничения WireGuard на сервере

**Проверка:**
```bash
# Проверить настройки WireGuard
sudo wg show wg0

# Проверить MTU
ip link show wg0

# Проверить правила iptables (могут замедлять трафик)
sudo iptables -t nat -L -n -v
sudo iptables -L FORWARD -n -v
```

**Решение:**
- Оптимизировать MTU (обычно 1420 для WireGuard, но может варьироваться)
- Проверить, нет ли лишних правил iptables
- Убедиться, что IP forwarding включен: `sysctl net.ipv4.ip_forward`

### 4. Проблемы с Shadowsocks при VPN+GPT профилях

**Проверка:**
```bash
# Проверить статус ss-redir
sudo systemctl status ss-wg.service

# Проверить логи
sudo journalctl -u ss-wg.service -n 50

# Проверить, сколько трафика идёт через ss-redir
sudo ss -tlnp | grep 1081
```

**Решение:**
- Если ss-redir падает или работает медленно — проверить внешний Shadowsocks сервер
- Возможно, внешний сервер перегружен или имеет ограничения

### 5. Проблемы с сетью провайдера

**Проверка:**
```bash
# Проверить пинг до сервера с обоих устройств
ping 185.21.8.91

# Проверить потерю пакетов
mtr 185.21.8.91

# Проверить скорость подключения к серверу
iperf3 -c <server_ip> -p 5201
```

**Решение:**
- Если пинг высокий или есть потери пакетов — проблема на стороне провайдера или маршрутизации
- Попробовать другой сервер (если есть) или другой провайдер

## Рекомендации по оптимизации

### 1. Оптимизация WireGuard

```bash
# Установить оптимальный MTU (если не установлен)
# В /etc/wireguard/wg0.conf добавить в секцию [Interface]:
# MTU = 1420

# Перезапустить WireGuard
sudo systemctl restart wg-quick@wg0
```

### 2. Оптимизация iptables

```bash
# Проверить, нет ли лишних правил
sudo iptables -t nat -L PREROUTING -n -v --line-numbers

# Убедиться, что правила для Shadowsocks применяются только к нужным IP
sudo iptables -t nat -L PREROUTING -n | grep 1081
```

### 3. Мониторинг нагрузки

Создать скрипт для мониторинга (см. `scripts/monitor-server.sh`):
- Количество активных подключений
- Использование CPU/RAM
- Скорость трафика
- Статистика по пирам WireGuard

## Временные решения

1. **Использовать разные серверы для разных устройств:**
   - Одно устройство на сервере "Россия" (main)
   - Другое устройство на сервере "Европа" (eu1)

2. **Ограничить одновременные подключения:**
   - Отключать VPN на одном устройстве, когда используешь другое

3. **Использовать разные профили:**
   - Обычный VPN для одного устройства
   - VPN+GPT для другого (если нужно)

## Долгосрочные решения

1. **Масштабирование:**
   - Добавить второй VPS для распределения нагрузки
   - Использовать load balancing между серверами

2. **Оптимизация инфраструктуры:**
   - Использовать более мощный VPS
   - Оптимизировать настройки сети и WireGuard

3. **Мониторинг и алертинг:**
   - Настроить автоматический мониторинг нагрузки
   - Получать уведомления при превышении лимитов

## Связанные документы

- `deployment.md` — информация о серверах и сервисах
- `architecture.md` — архитектура системы
- `spec-01-architecture-wg-ss.md` — детали архитектуры WireGuard + Shadowsocks
