# Решение конфликта VPN и Telegram proxy на iPhone

## Проблема

При включённом VPN и настроенном MTProto proxy в Telegram, Telegram не загружается. Если выключить proxy, то всё работает.

## Причина

Telegram пытается использовать MTProto proxy, но он конфликтует с VPN-туннелем:
- VPN перенаправляет весь трафик через WireGuard
- MTProto proxy пытается установить отдельное соединение
- Конфликт приводит к тому, что Telegram не может подключиться

## Решения

### Решение 1: Использовать VPN+GPT профиль без MTProto proxy

**Описание:** Использовать VPN+GPT профиль, который обходит блокировки через Shadowsocks, и не настраивать MTProto proxy в Telegram.

**Шаги:**
1. В боте выбрать сервер "Европа" → тип "VPN+GPT"
2. Получить конфиг `/get_config`
3. Импортировать конфиг в WireGuard
4. Включить VPN
5. **Не настраивать** MTProto proxy в Telegram (или отключить его, если уже настроен)

**Преимущества:**
- Простое решение
- Один профиль для всего
- Telegram работает через VPN

**Недостатки:**
- Зависит от качества Shadowsocks сервера
- Может быть медленнее для Telegram

### Решение 2: Настроить маршрутизацию Telegram трафика напрямую (Split Tunneling)

**Описание:** Настроить VPN так, чтобы трафик Telegram шёл напрямую, минуя VPN-туннель.

**Реализация на сервере:**

Создать правила iptables для исключения Telegram IP из VPN-туннеля:

```bash
# Получить IP адреса Telegram
# Telegram использует IP адреса из диапазонов:
# 91.108.4.0/22, 91.108.8.0/22, 91.108.12.0/22, 91.108.16.0/22, и др.

# Добавить правила для исключения Telegram трафика из VPN
# (требует дополнительной настройки маршрутизации)
```

**Преимущества:**
- Telegram работает напрямую (быстро)
- VPN работает для остального трафика
- Можно использовать MTProto proxy отдельно

**Недостатки:**
- Сложная настройка
- Требует поддержки списка IP Telegram
- Telegram IP могут меняться

### Решение 3: Использовать только MTProto proxy (без VPN)

**Описание:** Использовать только MTProto proxy для Telegram, а для остального трафика использовать обычный VPN.

**Шаги:**
1. Включить обычный VPN профиль (не VPN+GPT)
2. Настроить MTProto proxy в Telegram через `/proxy`
3. Telegram будет использовать proxy, остальной трафик — VPN

**Преимущества:**
- Простое решение
- Telegram работает через proxy
- VPN работает для остального трафика

**Недостатки:**
- Нужно настраивать два разных подключения
- Не единый профиль для всего

### Решение 4: Реализовать единый профиль (из задачи 4)

**Описание:** Реализовать единый VPN-профиль, который работает для всех сервисов, включая Telegram.

**См. спецификацию:** `specs/spec-04-unified-profile-all-services.md`

**Преимущества:**
- Один профиль для всего
- Нет конфликтов
- Работает как у крупных VPN-провайдеров

**Недостатки:**
- Требует реализации (в разработке)

## Рекомендации

### Для текущего использования:

1. **Использовать VPN+GPT профиль без MTProto proxy:**
   - Выбрать сервер "Европа" → тип "VPN+GPT"
   - Получить конфиг и импортировать в WireGuard
   - Включить VPN
   - **Не настраивать** MTProto proxy в Telegram

2. **Если нужен MTProto proxy:**
   - Использовать только MTProto proxy для Telegram (без VPN)
   - Или использовать обычный VPN для остального трафика и MTProto proxy для Telegram отдельно

### Для долгосрочного решения:

Реализовать единый профиль (задача 4), который решит конфликт автоматически.

## Инструкция для пользователей

### Вариант А: VPN+GPT без proxy (рекомендуется)

1. В боте: `/server` → выбрать "Европа" → выбрать "VPN+GPT"
2. `/get_config` → получить конфиг
3. Импортировать конфиг в WireGuard
4. Включить VPN
5. В Telegram: **не настраивать** proxy (или отключить, если уже настроен)
6. Telegram будет работать через VPN

### Вариант Б: Обычный VPN + MTProto proxy отдельно

1. В боте: `/server` → выбрать любой сервер → получить конфиг
2. Импортировать конфиг в WireGuard
3. Включить VPN для остального трафика
4. В Telegram: `/proxy` → получить ссылку MTProto proxy
5. Настроить proxy в Telegram отдельно
6. Telegram будет использовать proxy, остальной трафик — VPN

## Проверка работы

После настройки проверить:

1. **VPN работает:**
   - Открыть браузер → проверить IP адрес (должен быть IP VPN-сервера)
   - Открыть YouTube → проверить, что видео загружается

2. **Telegram работает:**
   - Открыть Telegram → проверить, что сообщения отправляются/получаются
   - Проверить подключение в настройках Telegram

3. **ChatGPT работает (если VPN+GPT):**
   - Открыть chat.openai.com → проверить, что сайт загружается

## Связанные документы

- `specs/spec-04-unified-profile-all-services.md` — единый профиль для всех сервисов
- `troubleshooting-ios-devices.md` — проблемы с iOS устройствами
- `spec-02-telegram-mtproto-proxy.md` — настройка MTProto proxy
- `spec-01-architecture-wg-ss.md` — архитектура системы

## Вопросы для диагностики

При обращении за помощью ответь на следующие вопросы:

1. Какой тип профиля используешь? (Обычный VPN/VPN+GPT)
2. Настроен ли MTProto proxy в Telegram? (да/нет)
3. На каком устройстве проблема? (iPhone/iPad/ПК)
4. Какая ошибка в Telegram? (не загружается/не отправляются сообщения/другое)
5. Работает ли VPN для других приложений? (да/нет)
