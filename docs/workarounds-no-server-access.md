# Обходные пути для работы с eu1 без прямого SSH-доступа

## Проблема

- При включении VPN на клиенте SSH-соединение с сервером обрывается
- Прямой доступ к серверу через друга сейчас недоступен
- Нужны способы диагностики и исправления без SSH

## Обходные пути

### 1. Использование бота для выполнения команд на сервере

**Идея:** Добавить в бота команду для выполнения команд на сервере через SSH (только для админа).

**Реализация:**
- Команда `/server_exec <command>` — выполняет команду на eu1 через SSH
- Только для `ADMIN_ID`
- Возвращает результат выполнения

**Плюсы:**
- Можно выполнять команды на сервере без прямого SSH
- Не требует доступа друга

**Минусы:**
- Нужно добавить функционал в бота
- Команды выполняются через бота (может быть медленнее)

**Пример использования:**
```
/server_exec wg show
/server_exec iptables -L FORWARD -n -v
/server_exec journalctl -u shadowsocks-libev-local@ss-wg.service -n 20
```

### 2. Подготовка скриптов диагностики заранее

**Идея:** Создать скрипты диагностики, которые можно запустить на сервере позже (когда будет доступ).

**Реализация:**
- Скрипт `diagnose-eu1.sh` — собирает всю диагностическую информацию
- Сохраняет результаты в файл `/tmp/eu1-diagnosis-$(date +%Y%m%d).txt`
- Можно запустить через бота или когда будет доступ

**Содержимое скрипта:**
```bash
#!/bin/bash
OUTPUT="/tmp/eu1-diagnosis-$(date +%Y%m%d-%H%M%S).txt"

{
    echo "=== WireGuard Status ==="
    wg show
    
    echo -e "\n=== IP Forwarding ==="
    sysctl net.ipv4.ip_forward
    
    echo -e "\n=== iptables FORWARD ==="
    iptables -L FORWARD -n -v
    
    echo -e "\n=== iptables NAT POSTROUTING ==="
    iptables -t nat -L POSTROUTING -n -v
    
    echo -e "\n=== iptables NAT PREROUTING ==="
    iptables -t nat -L PREROUTING -n -v | head -20
    
    echo -e "\n=== Routes ==="
    ip route show
    
    echo -e "\n=== wg0 Interface ==="
    ip addr show wg0
    
    echo -e "\n=== Shadowsocks Status ==="
    systemctl status shadowsocks-libev-local@ss-wg.service --no-pager -l
    
    echo -e "\n=== Shadowsocks Logs (last 50) ==="
    journalctl -u shadowsocks-libev-local@ss-wg.service -n 50 --no-pager
    
    echo -e "\n=== ss-redir Port ==="
    ss -tlnp | grep 1081
    
} > "$OUTPUT" 2>&1

echo "Diagnosis saved to: $OUTPUT"
cat "$OUTPUT"
```

### 3. Использование VPN с исключением SSH (Split Tunneling)

**Идея:** Настроить VPN так, чтобы SSH-трафик не шёл через VPN.

**Реализация:**
- В конфиге WireGuard изменить `AllowedIPs` с `0.0.0.0/0` на список, исключающий IP сервера
- Например: `AllowedIPs = 0.0.0.0/0, !185.21.8.91/32`
- Или использовать более точный список подсетей

**Плюсы:**
- SSH не будет обрываться при включении VPN
- Можно работать с сервером даже с включенным VPN

**Минусы:**
- Нужно обновить конфиги для всех клиентов
- Может быть сложно поддерживать список исключений

**Пример конфига:**
```ini
[Interface]
PrivateKey = ...
Address = 10.1.0.9/32
DNS = 1.1.1.1

[Peer]
PublicKey = ...
Endpoint = 185.21.8.91:51820
AllowedIPs = 0.0.0.0/0, !185.21.8.91/32
PersistentKeepalive = 25
```

### 4. Использование альтернативного способа подключения к серверу

**Варианты:**
- **VNC/NoMachine** — если установлен на сервере
- **Web-консоль провайдера** — Fornex может предоставлять веб-консоль
- **Другой VPN** — подключиться к серверу через другой VPN (например, main на Timeweb)
- **Мобильный интернет** — использовать мобильный интернет для SSH (может быть другой маршрут)

### 5. Автоматическая диагностика через cron на сервере

**Идея:** Настроить cron-задачу на сервере, которая периодически собирает диагностику и отправляет результаты (например, в файл или через API).

**Реализация:**
- Cron-задача каждые 5 минут собирает диагностику
- Сохраняет в файл `/tmp/eu1-status.json` или `/tmp/eu1-status.txt`
- Можно читать через веб-интерфейс или API (если настроен)

**Пример cron-задачи:**
```bash
*/5 * * * * /opt/vpnservice/scripts/collect-diagnosis.sh
```

### 6. Использование веб-панели для мониторинга

**Идея:** Расширить веб-панель (`web/`) для отображения диагностической информации с сервера.

**Реализация:**
- Добавить endpoint `/api/diagnosis/eu1`
- Бот или скрипт на сервере периодически собирает диагностику и отправляет в веб-панель
- Можно просматривать через браузер без SSH

## Рекомендуемый план действий

### Немедленно (можно сделать сейчас):

1. **Создать скрипт диагностики** (`diagnose-eu1.sh`) — подготовить заранее
2. **Добавить команду в бота** `/server_exec` — для выполнения команд на сервере
3. **Обновить конфиги WireGuard** — добавить исключение для SSH (Split Tunneling)

### Когда будет доступ к серверу:

1. Загрузить скрипт диагностики на сервер
2. Запустить диагностику
3. Проанализировать результаты
4. Применить исправления

### Альтернативно:

1. Использовать веб-консоль Fornex (если доступна)
2. Подключиться через другой VPN (main на Timeweb)
3. Использовать мобильный интернет для SSH

## Приоритет

1. **Высокий:** Split Tunneling для SSH (чтобы не терять доступ)
2. **Средний:** Команда `/server_exec` в боте (для диагностики)
3. **Низкий:** Автоматическая диагностика через cron (для мониторинга)
