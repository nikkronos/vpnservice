# Веб-панель мониторинга VPN

## Описание

Веб-панель для мониторинга состояния VPN-сервиса:
- Количество подключённых устройств
- Статус серверов (доступность, нагрузка)
- Статистика использования
- Управление пользователями (для владельца)

## Структура

```
web/
├── app.py              # Flask приложение
├── templates/          # HTML шаблоны
│   ├── index.html     # Главная страница
│   ├── servers.html   # Статус серверов
│   └── users.html     # Список пользователей
├── static/            # CSS, JS файлы
│   ├── style.css
│   └── main.js
└── requirements.txt   # Зависимости
```

## Функциональность

### Для всех пользователей:
- Просмотр статуса серверов
- Просмотр статистики использования
- Просмотр количества активных подключений

### Для владельца (админ):
- Управление пользователями
- Просмотр детальной статистики
- Мониторинг нагрузки на серверах
- Управление серверами

## Установка

```bash
# Установить зависимости
pip install -r requirements.txt

# Настроить переменные окружения
cp env_vars.example.txt env_vars.txt
# Заполнить ADMIN_ID и другие параметры

# Запустить приложение
python app.py
```

## Деплой

**Автоматического деплоя нет.** Обновления на сервере применяются вручную: `git pull` в `/opt/vpnservice` и перезапуск сервиса `vpn-web.service` (см. `../docs/deployment.md`).

Веб-панель разворачивается на том же сервере Timeweb, где работает бот (`/opt/vpnservice`). Пошаговая инструкция: **`../docs/deployment.md`** — раздел «Веб-панель мониторинга (Timeweb)».

Пример systemd unit: `vpn-web.service.example` в этой папке.

## Безопасность

- Аутентификация через Telegram (опционально)
- Доступ только для владельца (по ADMIN_ID)
- HTTPS через nginx reverse proxy (рекомендуется)

## API Endpoints

- `GET /` — главная страница
- `GET /api/servers` — статус серверов (JSON)
- `GET /api/services` — статус сервисов (WireGuard, AmneziaWG, Shadowsocks, MTProto)
- `GET /api/traffic` — трафик по пользователям/пирам (rx/tx с нод)
- `GET /api/users` — список пользователей (JSON)
- `GET /api/stats` — статистика использования (JSON)

## Обновление данных

- Интервал автообновления на странице: **5 минут** (снижение нагрузки на сервер).
- В блоке «Трафик» выводится время последнего ответа API (`last_update`), чтобы убедиться, что данные приходят с бэкенда.

### Если трафик не меняется

1. **Проверить на сервере:** панель читает `env_vars.txt` и `peers.json`/`users.json` из рабочей директории (`/opt/vpnservice`). Для eu1 трафик запрашивается по SSH (`WG_EU1_SSH_*`). Если SSH до eu1 с сервера панели не настроен или ключ не подходит — по eu1 будет пусто.
2. **main:** данные с ноды main берутся локально (`wg show wg0 dump`). Если WireGuard на этом хосте не поднят или интерфейс другой — в env должен быть верный `WG_INTERFACE`.
3. **eu1 (AmneziaWG):** трафик запрашивается по SSH командой `awg show <interface> dump` (интерфейс из `AMNEZIAWG_EU1_INTERFACE`, по умолчанию awg0). Если на eu1 используется awg0 — задать в env на сервере панели `AMNEZIAWG_EU1_INTERFACE=awg0` (или другой интерфейс AmneziaWG).
4. **Счётчики:** `wg`/`awg show` отдаёт накопленный трафик с последнего перезапуска интерфейса; если клиенты не активны, числа не растут.

## Связанные документы

- `../bot/storage.py` — модель данных пользователей и пиров
- `../docs/deployment.md` — информация о серверах
- `../docs/architecture.md` — архитектура системы
